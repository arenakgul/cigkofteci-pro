<!DOCTYPE html>
<html lang="tr" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <!-- Android tablet i√ßin daha saƒülƒ±klƒ± viewport (pinch-zoom a√ßƒ±k) -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#871918" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />

  <title>√áiƒü K√∂fteci Mahsum Usta | Y√∂netim Paneli</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Google Identity Services (GIS) -->
  <script src="https://accounts.google.com/gsi/client" async defer onload="window.__GIS_LOADED__ && window.__GIS_LOADED__()"></script>

<style>
    :root{
      --font:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      --r:18px;
      --rs:12px;
      --t:.18s ease;

      /* LOGO ANA RENK: #871918 */
      --primary:#871918;
      --primary-2:#a11c1b;
      --primary-3:#661111;

      /* D√ºz (flat) modern zeminler */
      --bg:#0f0b0b;
      --panel:#171011;
      --panel2:#1f1617;
      --input:#241a1b;
      --border:rgba(255,255,255,.10);

      --text:#fbfbfc;
      --muted:rgba(251,251,252,.65);

      --accent:#f5d0cd;
      --price:#ffd166;
      --price-bg:rgba(255,209,102,.16);
      --price-bd:rgba(255,209,102,.35);
      --success:#22c55e;
      --warning:#f59e0b;
      --danger:#ef4444;

      --shadow:0 14px 40px rgba(0,0,0,.40);
      --shadow2:0 10px 26px rgba(0,0,0,.32);
      --focus:0 0 0 4px rgba(135,25,24,.20);
    }

    html[data-theme="light"]{
      --bg:#fbf7f6;
      --panel:#ffffff;
      --panel2:#fff6f6;
      --input:#f4ecec;
      --border:rgba(20,11,11,.10);

      --text:#140b0b;
      --muted:rgba(20,11,11,.62);

      --price:#b45309;
      --price-bg:rgba(180,83,9,.12);
      --price-bd:rgba(180,83,9,.22);

      --shadow:0 12px 35px rgba(15,20,25,.10);
      --shadow2:0 10px 22px rgba(15,20,25,.08);
      --focus:0 0 0 4px rgba(135,25,24,.18);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      background:var(--bg);
      color:var(--text);
      overflow-x:hidden;
      -webkit-tap-highlight-color: transparent; /* Android dokunma highlight azalt */
    }

    /* Android dokunma i√ßin: yanlƒ±≈ülƒ±kla zoom/√ßift tƒ±k davranƒ±≈üƒ±nƒ± azaltƒ±r */
    button, .btn, .nav-item, .chip, .channel-btn, .product { touch-action: manipulation; }

    .hidden{display:none !important}
    .row{display:flex; gap:10px; align-items:center}
    .muted{color:var(--muted)}
    .pill{border-radius:999px}

    /* Layout */
    .app{display:flex; min-height:100vh;
      height:100dvh;}
    .main{flex:1; padding:16px; min-width:0;}

    /* Sidebar */
    .sidebar{
      width:285px;
      padding:18px;
      border-right:1px solid var(--border);
      background:var(--panel);
      position:sticky;
      top:0;
      height:100vh;
      height:100dvh;
      display:flex;
      flex-direction:column;
      gap:14px;
      z-index:50;
    }

    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:46px; height:46px;
      border-radius:14px;
      background:rgba(135,25,24,.14);
      border:1px solid rgba(135,25,24,.35);
      display:grid; place-items:center;
      overflow:hidden;
      box-shadow:var(--shadow2);
      flex:0 0 auto;
    }
    .logo img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .brand b{display:block; font-size:15px; letter-spacing:.2px;}
    .brand span{display:block; font-size:12px; color:var(--muted); margin-top:2px;}

    .box{
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:var(--r);
      padding:12px;
    }

    select,input,button,textarea{
      font-family:inherit;
      font-size:14px;
      outline:none;
    }
    select,input,textarea{
      width:100%;
      padding:10px 12px;
      background:var(--input);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:14px;
      transition:var(--t);
    }
    select:focus,input:focus,textarea:focus{box-shadow:var(--focus); border-color:rgba(135,25,24,.45);}

    /* Nav */
    .nav{display:flex; flex-direction:column; gap:10px;}
    .nav-item{
      display:flex;
      gap:12px;
      align-items:center;
      width:100%;
      padding:12px;
      border-radius:var(--r);
      background:transparent;
      border:1px solid transparent;
      color:var(--text);
      cursor:pointer;
      transition:var(--t);
      text-align:left;
    }
    .nav-item:hover{
      background:rgba(255,255,255,.03);
      border-color:var(--border);
      transform:translateY(-1px);
    }
    .nav-item.active{
      background:rgba(135,25,24,.12);
      border-color:rgba(135,25,24,.35);
      box-shadow:var(--shadow2);
    }
    .ico{
      width:40px; height:40px;
      border-radius:14px;
      display:grid; place-items:center;
      background:rgba(255,255,255,.03);
      border:1px solid var(--border);
      flex:0 0 auto;
      font-size:18px;
    }
    .nav-item.active .ico{
      background:rgba(135,25,24,.12);
      border-color:rgba(135,25,24,.35);
    }

    .sidebar-footer{margin-top:auto; display:flex; flex-direction:column; gap:10px;}
    #saveStatus{font-size:12px; min-height:16px;}

    /* Buttons */
    .btn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition:var(--t);
      user-select:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.05);}
    .btn:active{transform:translateY(0);}

    .btn-primary{
      background:var(--primary);
      border-color:rgba(0,0,0,0);
      color:#fff;
      font-weight:800;
    }
    .btn-primary:hover{background:var(--primary-2);}

    .btn-danger{background:rgba(239,68,68,.12); border-color:rgba(239,68,68,.35); color:#ffd6d6; font-weight:800;}
    .btn-warning{background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.35); color:#ffe7be; font-weight:800;}
    .btn-success{background:rgba(34,197,94,.12); border-color:rgba(34,197,94,.35); color:#c8ffd9; font-weight:800;}

    .btn-sm{padding:8px 10px; border-radius:12px; font-size:13px;}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none;}

    /* Topbar */
    .topbar{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--r);
      padding:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      box-shadow:var(--shadow2);
      margin-bottom:14px;
    }
    .topbar h1{
      font-size:16px;
      margin:0;
      letter-spacing:.2px;
    }
    .topbar h1 span{font-size:12px; color:var(--muted); font-weight:600; margin-left:8px;}

    /* Panels */
    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--r);
      padding:14px;
      box-shadow:var(--shadow2);
      min-width:0;
    }
    .panel h2{
      margin:0 0 10px 0;
      font-size:14px;
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
    }

    /* === Kategori/Kanal Barƒ±: kayma fix === */
    .category-scroll{
      display:flex;
      align-items:center;
      gap:8px;

      flex-wrap:nowrap;
      overflow-x:auto;
      overflow-y:hidden;
      white-space:nowrap;

      -webkit-overflow-scrolling:touch;
      scrollbar-gutter:stable;
      padding:2px 2px 8px 2px;
    }
    .category-scroll::-webkit-scrollbar{height:8px}
    .category-scroll::-webkit-scrollbar-thumb{
      background:rgba(255,255,255,.18);
      border-radius:999px;
    }
    .category-scroll::-webkit-scrollbar-track{background:transparent}

    /* Chips */
    .chip, .channel-btn{
      flex:0 0 auto;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;

      height:40px;
      padding:0 14px;

      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
      transition:var(--t);
      user-select:none;
      font-size:13px;
      white-space:nowrap;

      line-height:1;
      vertical-align:middle;
    }
    .chip:hover,.channel-btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.05);}
    .chip.active,.channel-btn.active{
      background:rgba(135,25,24,.12);
      border-color:rgba(135,25,24,.35);
      box-shadow:var(--shadow2);
    }

    /* POS layout */
    .content-grid{
      display:grid;
      grid-template-columns:1.7fr 1fr;
      gap:14px;
      align-items:start;
    }
    .pos-tools{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:start}
@media(max-width:980px){.pos-tools{grid-template-columns:1fr}}


    /* POS grid: auto-fit */
    .product-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(170px, 1fr));
      gap:12px;
      margin-top:10px;
    }
    .product{
      border:1px solid var(--border);
      background:var(--panel2);
      border-radius:var(--r);
      padding:14px;
      cursor:pointer;
      transition:var(--t);
      display:flex;
      gap:10px;
      align-items:center;
      min-height:66px;
    }
    .product:hover{
      transform:translateY(-2px);
      border-color:rgba(135,25,24,.30);
      box-shadow:var(--shadow2);
    }
    .pico{
      width:40px; height:40px;
      border-radius:14px;
      display:grid; place-items:center;
      background:rgba(135,25,24,.12);
      border:1px solid rgba(135,25,24,.20);
      font-size:20px;
      flex:0 0 auto;
    }
    .pname{
      display:block;
      font-size:clamp(.95rem, 2.8vw, 1.05rem);
      line-height:1.15;
      font-weight:900;
      word-break:break-word;
    }
    .price{
      font-weight:950;
      color:var(--price);
      margin-top:6px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:var(--price-bg);
      border:1px solid var(--price-bd);
      width:fit-content;
    }
    .stock{font-size:12px; color:var(--muted); margin-top:6px;}
    .stock.zero{ color:var(--danger); font-weight:900; }

    /* Cart */
    .cart-box{position:sticky; top:16px;}
    .cart-empty{
      padding:12px;
      border-radius:var(--r);
      border:1px dashed var(--border);
      color:var(--muted);
      text-align:center;
    }
    .cart-item{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:12px 0;
      border-bottom:1px solid var(--border);
    }
    .cart-summary{
      display:flex; justify-content:space-between; align-items:center;
      padding-top:12px; margin-top:12px;
      border-top:1px solid var(--border);
    }
    .cart-total{font-size:18px; font-weight:950; color:var(--price);}
    .pay-row{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}

    /* Cards */
    .cards{display:grid; grid-template-columns:repeat(auto-fit, minmax(170px, 1fr)); gap:12px;}
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--r);
      padding:14px;
      box-shadow:var(--shadow2);
    }
    .card .label{font-size:12px; color:var(--muted)}
    .card .value{font-size:20px; font-weight:950; margin-top:6px;}
    /* Para deƒüerlerini daha belirgin yap */
    #repTurnover{color:var(--price);}
    #repExpense{color:var(--warning);}
    #repNet{color:var(--success);}

    /* Tables */
    table{
      width:100%;
      border-collapse:collapse;
      border-radius:16px;
      overflow:hidden;
      border:1px solid var(--border);
      background:rgba(255,255,255,.02);
    }
    th,td{padding:12px 10px; border-bottom:1px solid var(--border); font-size:12px; text-align:left; vertical-align:top;}
    th{color:var(--muted); font-weight:900; text-transform:uppercase; font-size:11px; letter-spacing:.3px; background:rgba(255,255,255,.03)}
    tr:last-child td{border-bottom:none}

    /* Pages */
    .page-view{display:none;}
    .page-view.active{display:block;}

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:999;
    }
    .modal{
      width:min(720px, 100%);
      border-radius:22px;
      border:1px solid var(--border);
      background:var(--panel);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modal-head{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modal-head b{font-size:14px}
    .modal-body{padding:14px 16px;}
    .modal-foot{
      padding:14px 16px;
      border-top:1px solid var(--border);
      display:flex;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }

    /* Mobile sidebar overlay */
    .sb-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      z-index:998;
    }

    /* iOS input zoom engeli + mobil rahatlƒ±k */
    @media (max-width: 560px){
      select,input,textarea{font-size:16px;}
      .product{padding:12px; min-height:74px; align-items:flex-start;}
      .pico{width:42px; height:42px; border-radius:14px; font-size:20px;}
      .main{padding:12px; padding-bottom:calc(12px + env(safe-area-inset-bottom));}
      .topbar{position:sticky; top:8px; z-index:60;}
    }

    /* Responsive */
    @media (max-width: 1180px){
      .product-grid{grid-template-columns:repeat(auto-fit, minmax(170px, 1fr));}
      .content-grid{grid-template-columns:1.4fr 1fr;}
    }
    @media (max-width: 980px){
      .cards{grid-template-columns:repeat(2, minmax(0,1fr));}
      .content-grid{grid-template-columns:1fr;}
      .cart-box{position:relative; top:auto;}
    }
    @media (max-width: 840px){
      .sidebar{
        position:fixed;
        left:-320px;
        top:0;
        height:100vh;
        height:100dvh;
        z-index:999;
        transition:var(--t);
        box-shadow:var(--shadow);
      }
      .sidebar.open{left:0;}
      .main{padding:12px;}
    }
    @media (max-width: 560px){
      .product-grid{grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));}
    }
    @media (max-width: 420px){
      .product-grid{grid-template-columns:1fr;}
    }

    /* Sync panel */
    .sync-row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .sync-pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
    }
    .sync-ok{color:var(--success); border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.10);}
    .sync-warn{color:var(--warning); border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.10);}
    .sync-bad{color:var(--danger); border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.10);}

    /* Topbar sync indicator */
    .sync-top-btn{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      font-weight:800;
    }
    .sync-dot{
      width:10px; height:10px; border-radius:999px;
      display:inline-block;
      border:1px solid rgba(255,255,255,.25);
      box-shadow:0 0 0 3px rgba(255,255,255,.04);
    }
    .sync-dot.ok{ background:rgba(34,197,94,.95); }
    .sync-dot.warn{ background:rgba(245,158,11,.95); }
    .sync-dot.bad{ background:rgba(239,68,68,.95); }
    .mini-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:10px;}

  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div class="logo" title="Logo">
          <img src="logo.png" alt="√áiƒü K√∂fteci Mahsum Usta">
        </div>
        <div>
          <b>√áiƒü K√∂fteci Mahsum Usta</b>
          <span>Y√∂netim Paneli</span>
        </div>
      </div>

      <div class="box">
        <div class="muted" style="font-size:12px; margin-bottom:8px;">≈ûube Se√ß</div>
        <select id="branchSelect">
          <option value="hastane">Hastane ≈ûubesi</option>
          <option value="cihanpol">Cihanpol ≈ûubesi</option>
        </select>
      </div>

      <div class="nav">
        <button class="nav-item active" data-view="pos" type="button">
          <div class="ico">üßæ</div>
          <div><b>Satƒ±≈ü</b><br><span class="muted" style="font-size:12px;">POS ekranƒ±</span></div>
        </button>
        <button class="nav-item" data-view="dashboard" type="button">
          <div class="ico">üìà</div>
          <div><b>Rapor</b><br><span class="muted" style="font-size:12px;">G√ºnl√ºk/Genel</span></div>
        </button>
        <button class="nav-item" data-view="inventory" type="button">
          <div class="ico">üì¶</div>
          <div><b>√úr√ºnler</b><br><span class="muted" style="font-size:12px;">Stok y√∂netimi</span></div>
        </button>
        <button class="nav-item" data-view="expenses" type="button">
          <div class="ico">üßæ</div>
          <div><b>Gider</b><br><span class="muted" style="font-size:12px;">Gider kaydƒ±</span></div>
        </button>
      </div>

      <div class="sidebar-footer">
        <div class="box">
          <div class="row" style="justify-content:space-between;">
            <div>
              <div class="muted" style="font-size:12px;">Tema</div>
              <div style="font-weight:900;">Karanlƒ±k / Aydƒ±nlƒ±k</div>
            </div>
            <button class="btn btn-sm" id="themeToggle" type="button">üåô</button>
          </div>
        </div>

        <!-- LIVE SYNC -->
        <div class="box" id="syncBox">
          <div class="muted" style="font-size:12px; margin-bottom:8px;">Canlƒ± Senkron (Google Sheets)</div>
          <div class="sync-row" style="margin-bottom:8px;">
            <span id="syncPill" class="sync-pill sync-warn">‚è≥ Hazƒ±rlanƒ±yor‚Ä¶</span>
            <span id="syncLast" class="sync-pill">Son: -</span>
          </div>
          <div class="sync-row">
            <button class="btn btn-sm btn-primary" id="btnGoogleConnect" type="button">üîê Google Baƒülan</button>
            <button class="btn btn-sm" id="btnSyncPull" type="button">‚¨áÔ∏è √áek</button>
            <button class="btn btn-sm" id="btnSyncPush" type="button">‚¨ÜÔ∏è G√∂nder</button>
          </div>
          <div class="muted" style="font-size:11px; margin-top:8px;" id="syncHint">
            Not: Uygulama ‚ÄúTesting‚Äù modundaysa sadece Test Users giri≈ü yapabilir.
          </div>
        </div>

        <div class="box">
          <div class="muted" style="font-size:12px; margin-bottom:8px;">Yedek</div>
          <div class="row">
            <button class="btn btn-sm" id="btnExport" type="button">‚¨áÔ∏è Yedek Al</button>
            <button class="btn btn-sm" id="btnImport" type="button">‚¨ÜÔ∏è Yedeƒüi Y√ºkle</button>
            <input type="file" id="importFile" accept="application/json" class="hidden">
          </div>
          <div id="saveStatus" class="muted" style="margin-top:8px;"></div>
        </div>

        <div class="box">
          <div class="muted" style="font-size:11px;">
            Veri Kaynaƒüƒ±: <b id="dataSourceLabel">-</b>
          </div>
        </div>
      </div>
    </aside>

    <div id="sbOverlay" class="sb-overlay hidden" onclick="toggleSidebar(true)"></div>

    <main class="main">
      <div class="topbar">
        <h1>
          √áiƒü K√∂fteci Mahsum Usta
          <span id="activeBranchLabel" class="muted"></span>
          <span id="dataSourceTop" style="font-size:12px; color:var(--muted); font-weight:600; margin-left:8px;"></span>
        </h1>
        <div class="row">
          <button class="sync-top-btn" id="syncTopBtn" type="button" onclick="openSyncPanel()" title="Canlƒ± Senkron">
            üîÑ <span id="syncDotTop" class="sync-dot warn"></span>
            <span id="syncTopLabel" class="muted" style="font-size:12px; font-weight:900;">Senkron</span>
          </button>
          <button class="btn" type="button" onclick="toggleSidebar()">‚ò∞ Men√º</button>
        </div>
      </div>

      <!-- POS -->
      <section class="page-view active" id="view-pos">
        <div class="content-grid">
          <div class="panel">
            <h2>
              <span>√úr√ºnler</span>
              <span class="muted" style="font-size:12px;">Sepete ekle</span>
            </h2>

            <div class="pos-tools">
              <div style="flex:1; min-width:220px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Kategori</div>
                <div class="category-scroll" id="catBar"></div>
              </div>
              <div style="flex:1; min-width:220px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Satƒ±≈ü Kanalƒ±</div>
                <div class="category-scroll" id="channelButtons"></div>
              </div>
            </div>

            <div class="product-grid" id="posGrid"></div>
          </div>

          <div class="panel cart-box">
            <h2>
              <span>Sepet</span>
              <span class="muted" style="font-size:12px;">√ñdeme al</span>
            </h2>

            <div id="cartList"></div>

            <div class="cart-summary">
              <div class="muted">Ara Toplam</div>
              <div class="cart-total" id="cartSubtotal">0.00 ‚Ç∫</div>
            </div>
</div>

            <div class="cart-summary" style="margin-top:10px;">
              <div class="muted">Toplam</div>
              <div class="cart-total" id="cartTotal">0.00 ‚Ç∫</div>
            </div>

            <div style="margin-top:14px;">
              <div class="muted" style="font-size:12px; margin-bottom:8px;">√ñdeme Y√∂ntemi</div>
              <div class="pay-row" id="payButtons"></div>
            </div>

            <div class="row" style="margin-top:12px;">
              <button class="btn btn-danger" type="button" onclick="clearCart()">üßπ Temizle</button>
              <button class="btn btn-primary" type="button" onclick="checkout()">‚úÖ Satƒ±≈üƒ± Kaydet</button>
            </div>
          </div>
        </div>
      </section>

      <!-- DASHBOARD -->
      <section class="page-view" id="view-dashboard">
        <div class="panel" style="margin-bottom:14px;">
          <h2>
            <span>√ñzet</span>
            <span class="muted" style="font-size:12px;">Ciro / Gider / Net</span>
          </h2>

          <div class="cards">
            <div class="card">
              <div class="label">Toplam Ciro</div>
              <div class="value" id="repTurnover">0.00 ‚Ç∫</div>
            </div>
            <div class="card">
              <div class="label">Toplam Gider</div>
              <div class="value" id="repExpense">0.00 ‚Ç∫</div>
            </div>
            <div class="card">
              <div class="label">Satƒ±≈ü Adedi</div>
              <div class="value" id="repCount">0</div>
            </div>
            <div class="card">
              <div class="label">Net</div>
              <div class="value" id="repNet">0.00 ‚Ç∫</div>
            </div>
          </div>
        </div>

        <div class="panel">
          <h2>
            <span>Satƒ±≈ülar</span>
            <span class="muted" style="font-size:12px;">D√ºzenle/Sil</span>
          </h2>

          <div class="row" style="flex-wrap:wrap; gap:12px; margin-bottom:12px;">
            <div style="flex:1; min-width:220px;">
              <div class="muted" style="font-size:12px; margin-bottom:6px;">Tarih</div>
              <input type="date" id="salesDateFilter" onchange="filterSales()">
            </div>
            <div style="flex:1; min-width:220px;">
              <div class="muted" style="font-size:12px; margin-bottom:6px;">Kanal</div>
              <select id="salesChannelFilter" onchange="filterSales()"></select>
            </div>
            <div style="flex:1; min-width:220px;">
              <div class="muted" style="font-size:12px; margin-bottom:6px;">Ara</div>
              <input id="salesSearch" placeholder="√úr√ºn/kanal/ID ara..." oninput="filterSales()">
            </div>
          </div>

          <div style="overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th>Tarih</th>
                  <th>Kanal</th>
                  <th>√ñdeme</th>
                  <th>Toplam</th>
                  <th>√úr√ºnler</th>
                  <th>ƒ∞≈ülem</th>
                </tr>
              </thead>
              <tbody id="salesTable"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- INVENTORY -->
      <section class="page-view" id="view-inventory">
        <div class="content-grid">
          <div class="panel">
            <h2>
              <span>√úr√ºn Ekle / G√ºncelle</span>
              <span class="muted" style="font-size:12px;">Stok / Fiyat</span>
            </h2>

            <div class="row" style="flex-wrap:wrap;">
              <div style="flex:1; min-width:240px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">√úr√ºn Adƒ±</div>
                <input id="pName" placeholder="√ñrn: Acƒ±lƒ± √áiƒü K√∂fte">
              </div>
              <div style="flex:1; min-width:240px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Kategori</div>
                <select id="pCat"></select>
              </div>
            </div>

            <div class="row" style="flex-wrap:wrap; margin-top:10px;">
              <div style="flex:1; min-width:160px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Fiyat (‚Ç∫)</div>
                <input id="pPrice" type="number" step="0.01" min="0" placeholder="0.00">
              </div>
              <div style="flex:1; min-width:160px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Stok</div>
                <input id="pStock" type="number" step="1" min="0" placeholder="0">
              </div>
              <div style="flex:1; min-width:200px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">ƒ∞kon (Emoji)</div>
                <input id="pIcon" placeholder="√ñrn: üåØ">
              </div>
            </div>
            
            <div style="margin-top:12px;">
              <div class="muted" style="font-size:12px; margin-bottom:6px;">Kanal Bazlƒ± Fiyatlar (opsiyonel)</div>
              <div class="mini-grid" id="channelPriceFields"></div>
              <div class="muted" style="font-size:12px; margin-top:6px;">Bo≈ü bƒ±rakƒ±lan kanallar, "Fiyat" alanƒ±nƒ± kullanƒ±r.</div>
            </div>

<div class="row" style="margin-top:12px; flex-wrap:wrap;">
              <input type="hidden" id="pId">
              <button class="btn btn-primary" type="button" onclick="saveProduct()">üíæ Kaydet</button>
              <button class="btn" type="button" onclick="resetProductForm()">‚Ü©Ô∏è Sƒ±fƒ±rla</button>
            </div>
          </div>

          <div class="panel">
            <h2>
              <span>√úr√ºn Listesi</span>
              <span class="muted" style="font-size:12px;">D√ºzenle/Sil</span>
            </h2>

            <div class="row" style="flex-wrap:wrap; gap:12px; margin-bottom:12px;">
              <div style="flex:1; min-width:220px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Kategori</div>
                <select id="invCatFilter" onchange="filterProducts()"></select>
              </div>
              
              <div style="flex:1; min-width:220px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Fiyat Kanalƒ±</div>
                <select id="invPriceChannel" onchange="filterProducts()"></select>
              </div>
<div style="flex:1; min-width:220px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Ara</div>
                <input id="invSearch" placeholder="√úr√ºn adƒ± ara..." oninput="filterProducts()">
              </div>
            </div>

            <div style="overflow:auto;">
              <table id="inventoryTable">
                <thead>
                  <tr>
                    <th>√úr√ºn</th>
                    <th>Kategori</th>
                    <th>Fiyat</th>
                    <th>Stok</th>
                    <th>ƒ∞≈ülem</th>
                  </tr>
                </thead>
                <tbody id="inventoryBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- EXPENSES -->
      <section class="page-view" id="view-expenses">
        <div class="content-grid">
          <div class="panel">
            <h2>
              <span>Gider Ekle</span>
              <span class="muted" style="font-size:12px;">Masraf kaydƒ±</span>
            </h2>

            <div class="row" style="flex-wrap:wrap;">
              <div style="flex:1; min-width:220px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Tarih</div>
                <input id="expDate" type="date">
              </div>
              <div style="flex:1; min-width:220px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Tip</div>
                <select id="expType"></select>
              </div>
            </div>

            <div class="row" style="flex-wrap:wrap; margin-top:10px;">
              <div style="flex:1; min-width:220px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">A√ßƒ±klama</div>
                <input id="expDesc" placeholder="√ñrn: Elektrik faturasƒ±">
              </div>
              <div style="flex:1; min-width:160px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Tutar (‚Ç∫)</div>
                <input id="expAmount" type="number" step="0.01" min="0" placeholder="0.00">
              </div>
            </div>

            <div class="row" style="margin-top:12px; flex-wrap:wrap;">
              <button class="btn btn-primary" type="button" onclick="addExpense()">‚ûï Gider Ekle</button>
              <button class="btn" type="button" onclick="resetExpenseForm()">‚Ü©Ô∏è Sƒ±fƒ±rla</button>
            </div>
          </div>

          <div class="panel">
            <h2>
              <span>Gider Listesi</span>
              <span class="muted" style="font-size:12px;">Sil</span>
            </h2>

            <div class="row" style="flex-wrap:wrap; gap:12px; margin-bottom:12px;">
              <div style="flex:1; min-width:220px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Tip</div>
                <select id="expTypeFilter" onchange="filterExpenses()"></select>
              </div>
              <div style="flex:1; min-width:220px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Ara</div>
                <input id="expSearch" placeholder="A√ßƒ±klama ara..." oninput="filterExpenses()">
              </div>
            </div>

            <div style="overflow:auto;">
              <table>
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>Tip</th>
                    <th>A√ßƒ±klama</th>
                    <th>Tutar</th>
                    <th>ƒ∞≈ülem</th>
                  </tr>
                </thead>
                <tbody id="expensesTable"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Edit Sale Modal -->
      <div id="editModal" class="modal-backdrop hidden">
        <div class="modal">
          <div class="modal-head">
            <b>Satƒ±≈ü D√ºzenle</b>
            <button class="btn btn-sm" type="button" onclick="closeEditModal()">‚úñ</button>
          </div>
          <div class="modal-body">
            <div class="row" style="flex-wrap:wrap;">
              <div style="flex:1; min-width:220px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Kanal</div>
                <select id="editSaleChannel"></select>
              </div>
              <div style="flex:1; min-width:220px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">√ñdeme</div>
                <select id="editSaleMethod">
                  <option value="nakit">Nakit</option>
                  <option value="kart">Kart</option>
                  <option value="online">Online</option>
                </select>
              </div>
            </div>
</div>

<div style="margin-top:12px;">
              <div class="muted" style="font-size:12px; margin-bottom:6px;">√úr√ºnler</div>
              <div id="editSaleItems"></div>
            </div>

            <div class="row" style="margin-top:12px; justify-content:space-between;">
              <div class="muted">Ara Toplam</div>
              <div style="font-weight:950;" id="editSaleSubtotal">0.00 ‚Ç∫</div>
            </div>
            <div class="row" style="margin-top:8px; justify-content:space-between;">
              <div class="muted">Genel Toplam</div>
              <div style="font-weight:950;" id="editSaleTotal">0.00 ‚Ç∫</div>
            </div>
          </div>
          <div class="modal-foot">
            <button class="btn btn-danger" type="button" onclick="deleteSale()">üóëÔ∏è Satƒ±≈üƒ± Sil</button>
            <button class="btn btn-primary" type="button" onclick="updateSale()">üíæ G√ºncelle</button>
          </div>
        </div>
      </div>

  <!-- =========================
       ≈ûUBE √úR√úNLERƒ∞ (JSON)
       Bu listeler DEFAULTS'e aktarƒ±lƒ±yor.
       ========================= -->

  <!-- ≈ûube 1: Hastane ≈ûubesi √úr√ºnleri -->
  <script type="application/json" id="branchHastaneProducts">
  
[
  {
    "id": 1,
    "name": "NORMAL D√úR√úM",
    "cat": "D√ºr√ºmler",
    "icon": "üåØ",
    "price": 50,
    "prices": {
      "Telefon": 60,
      "Yemeksepeti": 80
    },
    "stock": 100
  },
  {
    "id": 2,
    "name": "MEGA D√úR√úM",
    "cat": "D√ºr√ºmler",
    "icon": "üåØ",
    "price": 90,
    "prices": {
      "Telefon": 100,
      "Yemeksepeti": 120
    },
    "stock": 100
  },
  {
    "id": 3,
    "name": "ULTRA MEGA D√úR√úM",
    "cat": "D√ºr√ºmler",
    "icon": "üåØ",
    "price": 110,
    "prices": {
      "Telefon": 120,
      "Yemeksepeti": 125
    },
    "stock": 100
  },
  {
    "id": 4,
    "name": "DUBLE D√úR√úM",
    "cat": "D√ºr√ºmler",
    "icon": "üåØ",
    "price": 135,
    "prices": {
      "Telefon": 140,
      "Yemeksepeti": 140
    },
    "stock": 100
  },
  {
    "id": 5,
    "name": "250 GR PORSƒ∞YON",
    "cat": "Porsiyon",
    "icon": "ü•ó",
    "price": 100,
    "prices": {
      "Telefon": 100,
      "Yemeksepeti": 110
    },
    "stock": 100
  },
  {
    "id": 6,
    "name": "350 GR PORSƒ∞YON",
    "cat": "Porsiyon",
    "icon": "ü•ó",
    "price": 115,
    "prices": {
      "Telefon": 115,
      "Yemeksepeti": 150
    },
    "stock": 100
  },
  {
    "id": 7,
    "name": "500 GR PORSƒ∞YON",
    "cat": "Porsiyon",
    "icon": "ü•ó",
    "price": 150,
    "prices": {
      "Telefon": 150,
      "Yemeksepeti": 190
    },
    "stock": 100
  },
  {
    "id": 8,
    "name": "750 GR PORSƒ∞YON",
    "cat": "Porsiyon",
    "icon": "ü•ó",
    "price": 225,
    "prices": {
      "Telefon": 225,
      "Yemeksepeti": 280
    },
    "stock": 100
  },
  {
    "id": 9,
    "name": "1 KG PORSƒ∞YON",
    "cat": "Porsiyon",
    "icon": "ü•ó",
    "price": 300,
    "prices": {
      "Telefon": 300,
      "Yemeksepeti": 370
    },
    "stock": 100
  },
  {
    "id": 10,
    "name": "SU",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 10,
    "prices": {
      "Telefon": 15,
      "Yemeksepeti": 20
    },
    "stock": 100
  },
  {
    "id": 11,
    "name": "K√ú√á√úK AYRAN",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 15,
    "prices": {
      "Telefon": 20,
      "Yemeksepeti": 20
    },
    "stock": 100
  },
  {
    "id": 12,
    "name": "B√úY√úK AYRAN",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 20,
    "prices": {
      "Telefon": 25,
      "Yemeksepeti": 30
    },
    "stock": 100
  },
  {
    "id": 13,
    "name": "CAM KOLA",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 35,
    "prices": {
      "Telefon": 40,
      "Yemeksepeti": 45
    },
    "stock": 100
  },
  {
    "id": 14,
    "name": "CAM FANTA",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 35,
    "prices": {
      "Telefon": 40,
      "Yemeksepeti": 45
    },
    "stock": 100
  },
  {
    "id": 15,
    "name": "KUTU KOLA",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 50,
    "prices": {
      "Telefon": 60,
      "Yemeksepeti": 65
    },
    "stock": 100
  },
  {
    "id": 16,
    "name": "KUTU FANTA",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 50,
    "prices": {
      "Telefon": 60,
      "Yemeksepeti": 65
    },
    "stock": 100
  },
  {
    "id": 17,
    "name": "ƒ∞CETEA MANGO",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 50,
    "prices": {
      "Telefon": 60,
      "Yemeksepeti": 65
    },
    "stock": 100
  },
  {
    "id": 18,
    "name": "ƒ∞CETEA ≈ûEFTALƒ∞",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 50,
    "prices": {
      "Telefon": 60,
      "Yemeksepeti": 65
    },
    "stock": 100
  },
  {
    "id": 19,
    "name": "ƒ∞CETEA Lƒ∞MON",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 50,
    "prices": {
      "Telefon": 60,
      "Yemeksepeti": 65
    },
    "stock": 100
  },
  {
    "id": 20,
    "name": "ƒ∞CETEA KARPUZ",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 50,
    "prices": {
      "Telefon": 60,
      "Yemeksepeti": 65
    },
    "stock": 100
  },
  {
    "id": 21,
    "name": "ƒ∞CETEA MANGO 1 LT",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 60,
    "prices": {
      "Telefon": 70,
      "Yemeksepeti": 80
    },
    "stock": 100
  },
  {
    "id": 22,
    "name": "ƒ∞CETEA ≈ûEFTALƒ∞ 1 LT",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 60,
    "prices": {
      "Telefon": 70,
      "Yemeksepeti": 80
    },
    "stock": 100
  },
  {
    "id": 23,
    "name": "ƒ∞CETEA Lƒ∞MON 1 LT",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 60,
    "prices": {
      "Telefon": 70,
      "Yemeksepeti": 80
    },
    "stock": 100
  },
  {
    "id": 24,
    "name": "ƒ∞CETEA KARPUZ 1 LT",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 60,
    "prices": {
      "Telefon": 70,
      "Yemeksepeti": 80
    },
    "stock": 100
  },
  {
    "id": 25,
    "name": "≈ûALGAM 330 ML",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 40,
    "prices": {
      "Telefon": 45,
      "Yemeksepeti": 45
    },
    "stock": 100
  },
  {
    "id": 26,
    "name": "≈ûALGAM 1 LT",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 70,
    "prices": {
      "Telefon": 75,
      "Yemeksepeti": 80
    },
    "stock": 100
  },
  {
    "id": 27,
    "name": "Lƒ∞MONATA 330 ML",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 35,
    "prices": {
      "Telefon": 40,
      "Yemeksepeti": 45
    },
    "stock": 100
  },
  {
    "id": 28,
    "name": "Lƒ∞MONATA 1 LT",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 70,
    "prices": {
      "Telefon": 75,
      "Yemeksepeti": 80
    },
    "stock": 100
  },
  {
    "id": 29,
    "name": "KOLA 1 LT",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 60,
    "prices": {
      "Telefon": 70,
      "Yemeksepeti": 80
    },
    "stock": 100
  },
  {
    "id": 30,
    "name": "KOLA 2 LT",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 80,
    "prices": {
      "Telefon": 90,
      "Yemeksepeti": 100
    },
    "stock": 100
  },
  {
    "id": 31,
    "name": "KOLA 2.5 LT",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 90,
    "prices": {
      "Telefon": 100,
      "Yemeksepeti": 115
    },
    "stock": 100
  },
  {
    "id": 32,
    "name": "DORƒ∞TOS 15 GR",
    "cat": "Ek Paketler",
    "icon": "‚ûï",
    "price": 15,
    "prices": {
      "Telefon": 15,
      "Yemeksepeti": 15
    },
    "stock": 100
  },
  {
    "id": 33,
    "name": "DORƒ∞TOS 20 GR",
    "cat": "Ek Paketler",
    "icon": "‚ûï",
    "price": 20,
    "prices": {
      "Telefon": 20,
      "Yemeksepeti": 20
    },
    "stock": 100
  },
  {
    "id": 34,
    "name": "K√ú√á√úK YE≈ûƒ∞LLƒ∞K",
    "cat": "Ek Paketler",
    "icon": "‚ûï",
    "price": 25,
    "prices": {
      "Telefon": 25,
      "Yemeksepeti": 30
    },
    "stock": 100
  },
  {
    "id": 35,
    "name": "B√úY√úK YE≈ûƒ∞LLƒ∞K",
    "cat": "Ek Paketler",
    "icon": "‚ûï",
    "price": 35,
    "prices": {
      "Telefon": 35,
      "Yemeksepeti": 40
    },
    "stock": 100
  },
  {
    "id": 36,
    "name": "TUR≈ûU PAKETƒ∞",
    "cat": "Ek Paketler",
    "icon": "‚ûï",
    "price": 35,
    "prices": {
      "Telefon": 35,
      "Yemeksepeti": 45
    },
    "stock": 100
  },
  {
    "id": 37,
    "name": "2 LAVA≈û",
    "cat": "Ek Paketler",
    "icon": "‚ûï",
    "price": 8,
    "prices": {
      "Telefon": 8,
      "Yemeksepeti": 8
    },
    "stock": 100
  }
]</script>

  <!-- ≈ûube 2: Cihanpol ≈ûubesi √úr√ºnleri -->
  <script type="application/json" id="branchCihanpolProducts">
  
[
  {
    "id": 1,
    "name": "NORMAL D√úR√úM",
    "cat": "D√ºr√ºmler",
    "icon": "üåØ",
    "price": 50,
    "prices": {
      "Telefon": 60,
      "Yemeksepeti": 80
    },
    "stock": 100
  },
  {
    "id": 2,
    "name": "MEGA D√úR√úM",
    "cat": "D√ºr√ºmler",
    "icon": "üåØ",
    "price": 90,
    "prices": {
      "Telefon": 100,
      "Yemeksepeti": 120
    },
    "stock": 100
  },
  {
    "id": 3,
    "name": "ULTRA MEGA D√úR√úM",
    "cat": "D√ºr√ºmler",
    "icon": "üåØ",
    "price": 110,
    "prices": {
      "Telefon": 120,
      "Yemeksepeti": 125
    },
    "stock": 100
  },
  {
    "id": 4,
    "name": "DUBLE D√úR√úM",
    "cat": "D√ºr√ºmler",
    "icon": "üåØ",
    "price": 135,
    "prices": {
      "Telefon": 140,
      "Yemeksepeti": 140
    },
    "stock": 100
  },
  {
    "id": 5,
    "name": "250 GR PORSƒ∞YON",
    "cat": "Porsiyon",
    "icon": "ü•ó",
    "price": 100,
    "prices": {
      "Telefon": 100,
      "Yemeksepeti": 110
    },
    "stock": 100
  },
  {
    "id": 6,
    "name": "350 GR PORSƒ∞YON",
    "cat": "Porsiyon",
    "icon": "ü•ó",
    "price": 115,
    "prices": {
      "Telefon": 115,
      "Yemeksepeti": 150
    },
    "stock": 100
  },
  {
    "id": 7,
    "name": "500 GR PORSƒ∞YON",
    "cat": "Porsiyon",
    "icon": "ü•ó",
    "price": 150,
    "prices": {
      "Telefon": 150,
      "Yemeksepeti": 190
    },
    "stock": 100
  },
  {
    "id": 8,
    "name": "750 GR PORSƒ∞YON",
    "cat": "Porsiyon",
    "icon": "ü•ó",
    "price": 225,
    "prices": {
      "Telefon": 225,
      "Yemeksepeti": 280
    },
    "stock": 100
  },
  {
    "id": 9,
    "name": "1 KG PORSƒ∞YON",
    "cat": "Porsiyon",
    "icon": "ü•ó",
    "price": 300,
    "prices": {
      "Telefon": 300,
      "Yemeksepeti": 370
    },
    "stock": 100
  },
  {
    "id": 10,
    "name": "SU",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 10,
    "prices": {
      "Telefon": 15,
      "Yemeksepeti": 20
    },
    "stock": 100
  },
  {
    "id": 11,
    "name": "K√ú√á√úK AYRAN",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 15,
    "prices": {
      "Telefon": 20,
      "Yemeksepeti": 20
    },
    "stock": 100
  },
  {
    "id": 12,
    "name": "B√úY√úK AYRAN",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 20,
    "prices": {
      "Telefon": 25,
      "Yemeksepeti": 30
    },
    "stock": 100
  },
  {
    "id": 13,
    "name": "CAM KOLA",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 35,
    "prices": {
      "Telefon": 40,
      "Yemeksepeti": 45
    },
    "stock": 100
  },
  {
    "id": 14,
    "name": "CAM FANTA",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 35,
    "prices": {
      "Telefon": 40,
      "Yemeksepeti": 45
    },
    "stock": 100
  },
  {
    "id": 15,
    "name": "KUTU KOLA",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 50,
    "prices": {
      "Telefon": 60,
      "Yemeksepeti": 65
    },
    "stock": 100
  },
  {
    "id": 16,
    "name": "KUTU FANTA",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 50,
    "prices": {
      "Telefon": 60,
      "Yemeksepeti": 65
    },
    "stock": 100
  },
  {
    "id": 17,
    "name": "ƒ∞CETEA MANGO",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 50,
    "prices": {
      "Telefon": 60,
      "Yemeksepeti": 65
    },
    "stock": 100
  },
  {
    "id": 18,
    "name": "ƒ∞CETEA ≈ûEFTALƒ∞",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 50,
    "prices": {
      "Telefon": 60,
      "Yemeksepeti": 65
    },
    "stock": 100
  },
  {
    "id": 19,
    "name": "ƒ∞CETEA Lƒ∞MON",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 50,
    "prices": {
      "Telefon": 60,
      "Yemeksepeti": 65
    },
    "stock": 100
  },
  {
    "id": 20,
    "name": "ƒ∞CETEA KARPUZ",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 50,
    "prices": {
      "Telefon": 60,
      "Yemeksepeti": 65
    },
    "stock": 100
  },
  {
    "id": 21,
    "name": "ƒ∞CETEA MANGO 1 LT",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 60,
    "prices": {
      "Telefon": 70,
      "Yemeksepeti": 80
    },
    "stock": 100
  },
  {
    "id": 22,
    "name": "ƒ∞CETEA ≈ûEFTALƒ∞ 1 LT",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 60,
    "prices": {
      "Telefon": 70,
      "Yemeksepeti": 80
    },
    "stock": 100
  },
  {
    "id": 23,
    "name": "ƒ∞CETEA Lƒ∞MON 1 LT",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 60,
    "prices": {
      "Telefon": 70,
      "Yemeksepeti": 80
    },
    "stock": 100
  },
  {
    "id": 24,
    "name": "ƒ∞CETEA KARPUZ 1 LT",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 60,
    "prices": {
      "Telefon": 70,
      "Yemeksepeti": 80
    },
    "stock": 100
  },
  {
    "id": 25,
    "name": "≈ûALGAM 330 ML",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 40,
    "prices": {
      "Telefon": 45,
      "Yemeksepeti": 45
    },
    "stock": 100
  },
  {
    "id": 26,
    "name": "≈ûALGAM 1 LT",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 70,
    "prices": {
      "Telefon": 75,
      "Yemeksepeti": 80
    },
    "stock": 100
  },
  {
    "id": 27,
    "name": "Lƒ∞MONATA 330 ML",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 35,
    "prices": {
      "Telefon": 40,
      "Yemeksepeti": 45
    },
    "stock": 100
  },
  {
    "id": 28,
    "name": "Lƒ∞MONATA 1 LT",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 70,
    "prices": {
      "Telefon": 75,
      "Yemeksepeti": 80
    },
    "stock": 100
  },
  {
    "id": 29,
    "name": "KOLA 1 LT",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 60,
    "prices": {
      "Telefon": 70,
      "Yemeksepeti": 80
    },
    "stock": 100
  },
  {
    "id": 30,
    "name": "KOLA 2 LT",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 80,
    "prices": {
      "Telefon": 90,
      "Yemeksepeti": 100
    },
    "stock": 100
  },
  {
    "id": 31,
    "name": "KOLA 2.5 LT",
    "cat": "ƒ∞√ßecek",
    "icon": "ü•§",
    "price": 90,
    "prices": {
      "Telefon": 100,
      "Yemeksepeti": 115
    },
    "stock": 100
  },
  {
    "id": 32,
    "name": "DORƒ∞TOS 15 GR",
    "cat": "Ek Paketler",
    "icon": "‚ûï",
    "price": 15,
    "prices": {
      "Telefon": 15,
      "Yemeksepeti": 15
    },
    "stock": 100
  },
  {
    "id": 33,
    "name": "DORƒ∞TOS 20 GR",
    "cat": "Ek Paketler",
    "icon": "‚ûï",
    "price": 20,
    "prices": {
      "Telefon": 20,
      "Yemeksepeti": 20
    },
    "stock": 100
  },
  {
    "id": 34,
    "name": "K√ú√á√úK YE≈ûƒ∞LLƒ∞K",
    "cat": "Ek Paketler",
    "icon": "‚ûï",
    "price": 25,
    "prices": {
      "Telefon": 25,
      "Yemeksepeti": 30
    },
    "stock": 100
  },
  {
    "id": 35,
    "name": "B√úY√úK YE≈ûƒ∞LLƒ∞K",
    "cat": "Ek Paketler",
    "icon": "‚ûï",
    "price": 35,
    "prices": {
      "Telefon": 35,
      "Yemeksepeti": 40
    },
    "stock": 100
  },
  {
    "id": 36,
    "name": "TUR≈ûU PAKETƒ∞",
    "cat": "Ek Paketler",
    "icon": "‚ûï",
    "price": 35,
    "prices": {
      "Telefon": 35,
      "Yemeksepeti": 45
    },
    "stock": 100
  },
  {
    "id": 37,
    "name": "2 LAVA≈û",
    "cat": "Ek Paketler",
    "icon": "‚ûï",
    "price": 8,
    "prices": {
      "Telefon": 8,
      "Yemeksepeti": 8
    },
    "stock": 100
  }
]</script>

      <script>
    // ====== STORAGE ======
    var STORAGE_KEY = 'MAHSUM_USTA_APP_V5';
    var THEME_KEY = 'MAHSUM_USTA_THEME';

    // ====== GOOGLE SHEETS LIVE SYNC CONFIG ======
var SHEETS_SYNC = {
  enabled: true,
  clientId: '475033237170-hmk421hd221h2ubdu26svt4sgv3709gn.apps.googleusercontent.com',
  spreadsheetId: '14KIWt8HFT-CoYAsyWpBa1YNrMlay2_UKQqBdKMfo4Ck',
  range: 'State!A2:D2',
  opsAppendRange: 'Ops!A:H',
  scope: 'https://www.googleapis.com/auth/spreadsheets'
};

    // Varsayƒ±lanlar
    var DEFAULTS = {
      categories: ["D√ºr√ºmler", "Porsiyon", "ƒ∞√ßecek", "Ek Paketler"],
      expenseTypes: ['Kira','Elektrik','Su','Doƒüalgaz','Personel','Malzeme','Diƒüer'],
      salesChannels: ["D√ºkkan ƒ∞√ßi", "Telefon", "Yemeksepeti", "Getir", "Trendyol Yemek"],
      branches: {
        hastane: { name:'Hastane ≈ûubesi', products:[], sales:[], expenses:[] },
        cihanpol:{ name:'Cihanpol ≈ûubesi', products:[], sales:[], expenses:[] }
      }
    };

    // Default √ºr√ºnleri JSON scriptlerden oku ve DEFAULTS i√ßine koy
    function readProductsFromScript(scriptId){
      try{
        var el = document.getElementById(scriptId);
        if(!el) return [];
        var txt = (el.textContent || el.innerText || '').trim();
        if(!txt) return [];
        var arr = JSON.parse(txt);
        if(!Array.isArray(arr)) return [];
        return arr;
      }catch(e){ return []; }
    }
    DEFAULTS.branches.hastane.products = readProductsFromScript('branchHastaneProducts');
    DEFAULTS.branches.cihanpol.products = readProductsFromScript('branchCihanpolProducts');

    // Eski localStorage key'lerini otomatik bulup ta≈üƒ± (V5'e)
    function findBestOldStateInLocalStorage(){
      try{
        var bestKey = null;
        var bestScore = -1;

        for(var i=0;i<localStorage.length;i++){
          var k = localStorage.key(i);
          if(!k) continue;
          if(k === STORAGE_KEY) continue;

          var raw = localStorage.getItem(k);
          if(!raw || raw.length < 10) continue;

          var obj = null;
          try{ obj = JSON.parse(raw); }catch(e){ obj=null; }
          if(!obj || typeof obj !== 'object') continue;

          // Skorla: branches varsa y√ºksek, sales/expenses/products varsa artƒ±
          var score = 0;
          if(obj.branches && typeof obj.branches === 'object') score += 5;
          if(obj.categories && Array.isArray(obj.categories)) score += 1;
          if(obj.expenseTypes && Array.isArray(obj.expenseTypes)) score += 1;
          if(obj.salesChannels && Array.isArray(obj.salesChannels)) score += 1;

          // branch i√ßeriƒüi
          if(obj.branches){
            var bks = Object.keys(obj.branches);
            for(var j=0;j<bks.length;j++){
              var bk = bks[j];
              var b = obj.branches[bk];
              if(!b) continue;
              if(Array.isArray(b.products)) score += 2;
              if(Array.isArray(b.sales)) score += 2;
              if(Array.isArray(b.expenses)) score += 2;
            }
          }

          if(score > bestScore){
            bestScore = score;
            bestKey = k;
          }
        }

        return bestKey;
      }catch(e){
        return null;
      }
    }

    function deepClone(o){
      return JSON.parse(JSON.stringify(o));
    }

    function normalizeAndBackfill(st){
      if(!st || typeof st !== 'object') st = {};
      var TEMPLATE_VERSION = 2; // bu s√ºr√ºmde √ºr√ºn kataloƒüu/kanallar/kategoriler sabitlenir

      // Kategoriler: SADECE DEFAULTS.categories (kafana g√∂re ekleme yok)
      var allowedCats = deepClone(DEFAULTS.categories);
      if(!st.categories || !Array.isArray(st.categories) || st.categories.length===0) st.categories = deepClone(DEFAULTS.categories);
      try{
        st.categories = (st.categories||[]).map(function(c){ return String(c||'').trim(); }).filter(Boolean);
        st.categories = st.categories.filter(function(c){ return allowedCats.indexOf(c)!==-1; });
        for(var ci=0; ci<allowedCats.length; ci++){
          if(st.categories.indexOf(allowedCats[ci])===-1) st.categories.push(allowedCats[ci]);
        }
      }catch(e){
        st.categories = deepClone(DEFAULTS.categories);
      }

      // temel alanlar yoksa ekle
      if(!st.expenseTypes || !Array.isArray(st.expenseTypes) || st.expenseTypes.length===0) st.expenseTypes = deepClone(DEFAULTS.expenseTypes);
      if(!st.salesChannels || !Array.isArray(st.salesChannels) || st.salesChannels.length===0) st.salesChannels = deepClone(DEFAULTS.salesChannels);

      // satƒ±≈ü kanallarƒ±nƒ± (DEFAULTS + mevcut) birle≈ütir (tekrarlarƒ± at)
      try{
        var mergedCh = [];
        function addCh(x){
          if(!x) return;
          x = String(x).trim();
          if(!x) return;
          if(mergedCh.indexOf(x)===-1) mergedCh.push(x);
        }
        for(var ci2=0; ci2<(DEFAULTS.salesChannels||[]).length; ci2++) addCh(DEFAULTS.salesChannels[ci2]);
        for(ci2=0; ci2<(st.salesChannels||[]).length; ci2++) addCh(st.salesChannels[ci2]);
        st.salesChannels = mergedCh;
      }catch(e){}

      if(!st.branches || typeof st.branches !== 'object') st.branches = deepClone(DEFAULTS.branches);

      var keys = ['hastane','cihanpol'];
      var needsTemplateReset = (!st.catalogTemplateVersion || Number(st.catalogTemplateVersion) < TEMPLATE_VERSION);

      // eski kategori adlarƒ±nƒ± yeniye map'le (uyumluluk)
      var legacyCatMap = {
        '√áiƒü K√∂fte':'Porsiyon',
        'Cig Kofte':'Porsiyon',
        'Cigkofte':'Porsiyon',
        '√áiƒük√∂fte':'Porsiyon'
      };

      for(var i=0;i<keys.length;i++){
        var k = keys[i];
        if(!st.branches[k]) st.branches[k] = deepClone(DEFAULTS.branches[k]);
        if(!st.branches[k].name) st.branches[k].name = DEFAULTS.branches[k].name;
        if(!Array.isArray(st.branches[k].products)) st.branches[k].products = [];
        if(!Array.isArray(st.branches[k].sales)) st.branches[k].sales = [];
        if(!Array.isArray(st.branches[k].expenses)) st.branches[k].expenses = [];

        var template = deepClone((DEFAULTS.branches[k] && DEFAULTS.branches[k].products) ? DEFAULTS.branches[k].products : []);
        var tplById = {}, tplByName = {};
        for(var t=0; t<template.length; t++){
          var tp = template[t];
          if(tp && tp.cat && legacyCatMap[tp.cat]) tp.cat = legacyCatMap[tp.cat];
          if(tp && allowedCats.indexOf(tp.cat)===-1) tp.cat = 'Ek Paketler';
          tplById[String(tp.id)] = tp;
          tplByName[normNameForMatch(tp.name)] = tp;
        }

        // mevcut √ºr√ºnleri indexle
        var ex = st.branches[k].products || [];
        var exById = {}, exByName = {};
        for(var e=0; e<ex.length; e++){
          var ep = ex[e];
          if(!ep) continue;
          if(ep.cat && legacyCatMap[ep.cat]) ep.cat = legacyCatMap[ep.cat];
          exById[String(ep.id)] = ep;
          exByName[normNameForMatch(ep.name)] = ep;
        }

        // √úR√úN Lƒ∞STESƒ∞: SADECE template'deki √ºr√ºnler (ba≈üka √ºr√ºn eklenmez)
        var newList = [];
        for(t=0; t<template.length; t++){
          tp = template[t];
          ep = exById[String(tp.id)] || exByName[normNameForMatch(tp.name)];
          var np = deepClone(tp);

          // stok: ≈üubeye √∂zel tutulur
          if(ep && ep.stock!==undefined && ep.stock!==null && ep.stock!==''){
            np.stock = Number(ep.stock)||0;
          }

          // fiyatlar: bu s√ºr√ºme ilk ge√ßi≈üte template'yi baz al; sonrasƒ±nda kullanƒ±cƒ± deƒüi≈üikliklerini koru
          if(!needsTemplateReset && ep){
            if(ep.price!==undefined && ep.price!==null && ep.price!=='') np.price = Number(ep.price)||0;
            if(ep.prices && typeof ep.prices === 'object') np.prices = deepClone(ep.prices);
          }

          // kanal bazlƒ± fiyatlar numeric olsun (base: np.price)
          if(!np.prices || typeof np.prices !== 'object') np.prices = {};
          try{ if(np.prices['D√ºkkan ƒ∞√ßi']!==undefined) delete np.prices['D√ºkkan ƒ∞√ßi']; }catch(e){}
          var chs = st.salesChannels || [];
          for(var cc=0; cc<chs.length; cc++){
            var ch2 = String(chs[cc]||'').trim();
            if(!ch2 || ch2==='D√ºkkan ƒ∞√ßi') continue;
            if(np.prices[ch2]!==undefined && np.prices[ch2]!==null && np.prices[ch2]!=='' ){
              np.prices[ch2] = Number(np.prices[ch2])||0;
            }
          }

          newList.push(np);
        }
        st.branches[k].products = newList;

        // satƒ±≈ü kayƒ±tlarƒ±: √ºr√ºn id/name uyumla + kurye √ºcreti yok (total=subtotal)
        try{
          var fmt = new Intl.DateTimeFormat('en-CA', {timeZone:'Europe/Istanbul', year:'numeric', month:'2-digit', day:'2-digit'});
          var salesArr = st.branches[k].sales || [];
          for(var si=0; si<salesArr.length; si++){
            var s = salesArr[si] || {};
            if(!s.dateKey){
              try{
                var dd = new Date(s.date);
                if(!isNaN(dd.getTime())) s.dateKey = fmt.format(dd);
              }catch(e){}
            }

            // items: id/name map
            for(var ii=0; ii<(s.items||[]).length; ii++){
              var it = s.items[ii] || {};
              var hit = tplById[String(it.id)] || tplByName[normNameForMatch(it.name)];
              if(hit){
                it.id = hit.id;
                it.name = hit.name;
              }
            }

            // kurye √ºcreti alanƒ± eski kayƒ±tlarda varsa bile 0 kabul edelim
            s.deliveryFee = 0;

            if(s.subtotal===undefined || s.subtotal===null || s.subtotal===''){
              var sub = 0;
              for(ii=0; ii<(s.items||[]).length; ii++){
                sub += (Number(s.items[ii].price)||0) * (Number(s.items[ii].qty)||0);
              }
              s.subtotal = sub;
            }
            s.total = Number(s.subtotal)||0;
          }
        }catch(e){}
      }

      if(needsTemplateReset) st.catalogTemplateVersion = TEMPLATE_VERSION;
      return st;
    }

    var dataSourceKey = STORAGE_KEY;

    function loadStateOrDefault(){
      // √ñnce V5'ten dene
      var raw = localStorage.getItem(STORAGE_KEY);
      if(raw){
        try{
          var st = JSON.parse(raw);
          st = normalizeAndBackfill(st);
          dataSourceKey = STORAGE_KEY;
          return st;
        }catch(e){}
      }

      // V5 yoksa: en iyi eski state'i bul ve migrate et
      var oldKey = findBestOldStateInLocalStorage();
      if(oldKey){
        try{
          var oldRaw = localStorage.getItem(oldKey);
          var oldSt = JSON.parse(oldRaw);
          oldSt = normalizeAndBackfill(oldSt);

          // migrate: V5'e yaz
          localStorage.setItem(STORAGE_KEY, JSON.stringify(oldSt));
          dataSourceKey = oldKey + " ‚Üí " + STORAGE_KEY;
          return oldSt;
        }catch(e){}
      }

      // hi√ß yoksa defaults
      dataSourceKey = 'DEFAULTS';
      return normalizeAndBackfill(deepClone(DEFAULTS));
    }

    var state = loadStateOrDefault();

    // ====== THEME ======
    function loadTheme(){
      var t = localStorage.getItem(THEME_KEY);
      if(t==='light' || t==='dark'){
        document.documentElement.setAttribute('data-theme', t);
        updateThemeButton();
      }
    }
    function toggleTheme(){
      var cur = document.documentElement.getAttribute('data-theme') || 'dark';
      var next = (cur==='dark') ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem(THEME_KEY, next);
      updateThemeButton();
    }
    function updateThemeButton(){
      var btn = document.getElementById('themeToggle');
      if(!btn) return;
      var cur = document.documentElement.getAttribute('data-theme') || 'dark';
      btn.textContent = (cur==='dark') ? 'üåô' : '‚òÄÔ∏è';
    }

    // ====== HELPERS ======
    function esc(s){
      s = (s===null || s===undefined) ? '' : String(s);
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }
    function setText(id, txt){
      var el = document.getElementById(id);
      if(el) el.textContent = txt;
    }
    function getVal(id){
      var el = document.getElementById(id);
      return el ? el.value : '';
    }
    function setVal(id, v){
      var el = document.getElementById(id);
      if(el) el.value = v;
    }
    function showSaveStatus(msg, type){
      var el = document.getElementById('saveStatus');
      if(!el) return;
      el.textContent = msg || '';
      el.style.color = (type==='success') ? 'var(--success)' : (type==='error' ? 'var(--danger)' : 'var(--muted)');
    }

    function newId(){
      return Date.now() + Math.floor(Math.random()*1000);
    }

    function getBranchKey(){
      var sel = document.getElementById('branchSelect');
      return sel ? sel.value : 'hastane';
    }
    function getBranch(){
      var k = getBranchKey();
      return state.branches[k];
    }
    function refreshBranchLabel(){
      var b = getBranch();
    var p = null;
      var el = document.getElementById('activeBranchLabel');
      if(el && b) el.textContent = '‚Äî ' + b.name;
    }

    function updateDataSourceLabels(){
      var d1 = document.getElementById('dataSourceLabel');
      var d2 = document.getElementById('dataSourceTop');
      if(d1) d1.textContent = dataSourceKey || '-';
      if(d2) d2.textContent = 'Kaynak: ' + (dataSourceKey || '-');
    }

    function save(silent){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        dataSourceKey = STORAGE_KEY;
        if(!silent) showSaveStatus('Kaydedildi', 'success');
        updateDataSourceLabels();

        // Sheets push (debounced)
        if(SheetsSync && SheetsSync.isConnected && SheetsSync.isConnected()){
          SheetsSync.pushDebounced();
        }

        return true;
      }catch(e){
        if(!silent) showSaveStatus('Kaydetme hatasƒ±!', 'error');
        return false;
      }
    }

    function cloneItems(items){
      return items.map(function(it){
        return { id:it.id, name:it.name, price:Number(it.price)||0, qty:Number(it.qty)||0 };
      });
    }

    function findProduct(products, id){
      for(var i=0;i<products.length;i++){
        if(Number(products[i].id)===Number(id)) return products[i];
      }
      return null;
    }

    function getCategoryIcon(cat){
      var map = {
        'D√ºr√ºmler':'üåØ',
        'Porsiyon':'ü•ó',
        'ƒ∞√ßecek':'ü•§',
        'Ek Paketler':'‚ûï',

        // Eski s√ºr√ºm uyumluluƒüu:
        '√áiƒü K√∂fte':'ü•ó'
      };
      return map[cat] || 'üì¶';
    }

    // ====== SIDEBAR & VIEW ======
    function bindNav(){
      var items = document.querySelectorAll('.nav-item');
      for(var i=0;i<items.length;i++){
        items[i].addEventListener('click', function(){
          var view = this.getAttribute('data-view');
          switchView(view);
          if(window.innerWidth <= 840){
            toggleSidebar(true);
          }
        });
      }
    }

    function openSyncPanel(){
      // Sidebar kapalƒ±ysa a√ß
      var sb = document.getElementById('sidebar');
      if(sb && !sb.classList.contains('open')) toggleSidebar();
      var box = document.getElementById('syncBox');
      if(box && box.scrollIntoView) box.scrollIntoView({behavior:'smooth', block:'start'});
    }

    function switchView(view){
      var items = document.querySelectorAll('.nav-item');
      for(var i=0;i<items.length;i++){
        items[i].classList.toggle('active', items[i].getAttribute('data-view')===view);
      }
      var views = document.querySelectorAll('.page-view');
      for(i=0;i<views.length;i++){
        views[i].classList.remove('active');
      }
      var target = document.getElementById('view-' + view);
      if(target) target.classList.add('active');

      if(view==='pos') renderPOS();
      if(view==='dashboard'){ renderDashboard(); renderSalesTable(); }
      if(view==='inventory'){ renderInventory(); }
      if(view==='expenses'){ renderExpenses(); }
    }

    function toggleSidebar(forceClose){
      var sb = document.getElementById('sidebar');
      var ov = document.getElementById('sbOverlay');
      if(!sb) return;

      var open = sb.classList.contains('open');
      var shouldOpen = !open;

      if(forceClose === true) shouldOpen = false;
      if(forceClose === false) shouldOpen = true;

      if(shouldOpen){
        sb.classList.add('open');
        if(ov) ov.classList.remove('hidden');
      }else{
        sb.classList.remove('open');
        if(ov) ov.classList.add('hidden');
      }
    }

    // ====== POS ======
    // Satƒ±≈ü kanallarƒ± (≈üimdilik Trendyol Yemek pasif)
    var INACTIVE_SALES_CHANNELS = ['Getir','Trendyol Yemek'];
    function getActiveSalesChannels(){
      var arr = (state && Array.isArray(state.salesChannels)) ? state.salesChannels : [];
      var out = [];
      for(var i=0;i<arr.length;i++){
        var c = String(arr[i]||'').trim();
        if(!c) continue;
        if(INACTIVE_SALES_CHANNELS.indexOf(c)!==-1) continue;
        if(out.indexOf(c)===-1) out.push(c);
      }
      if(out.length===0) out = ['D√ºkkan ƒ∞√ßi'];
      return out;
    }

    var activeCat = 'Hepsi';
    var activeChannel = (getActiveSalesChannels()[0]) || 'D√ºkkan ƒ∞√ßi';
    var activePayMethod = 'nakit';
    var cart = [];


    // ====== TIMEZONE SAFE DATEKEY (Europe/Istanbul) ======
    function istanbulDateKeyFromDate(d){
      try{
        return new Intl.DateTimeFormat('en-CA', {
          timeZone: 'Europe/Istanbul',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        }).format(d);
      }catch(e){
        // fallback: local date
        var y = d.getFullYear();
        var m = String(d.getMonth()+1).padStart(2,'0');
        var da = String(d.getDate()).padStart(2,'0');
        return y+'-'+m+'-'+da;
      }
    }
    function istanbulDateKeyFromIso(iso){
      if(!iso) return '';
      var d = new Date(iso);
      if(isNaN(d.getTime())) return '';
      return istanbulDateKeyFromDate(d);
    }

    // ====== CHANNEL-BASED PRICING ======
    function ensureProductPrices(p){
      if(!p) return;
      if(!p.prices || typeof p.prices !== 'object') p.prices = {};
      var base = Number(p.price)||0;

      // D√ºkkan i√ßi her zaman base ile uyumlu olsun
      if(p.prices['D√ºkkan ƒ∞√ßi']===undefined || p.prices['D√ºkkan ƒ∞√ßi']===null || p.prices['D√ºkkan ƒ∞√ßi']===''){
        p.prices['D√ºkkan ƒ∞√ßi'] = base;
      }
      // diƒüer kanallar bo≈üsa base'e d√º≈üer (saklamaya gerek yok ama edit kolaylƒ±ƒüƒ±)
      try{
        for(var i=0;i<(state.salesChannels||[]).length;i++){
          var ch = state.salesChannels[i];
          if(!ch) continue;
        if(ch==='D√ºkkan ƒ∞√ßi') continue;
          if(p.prices[ch]===undefined || p.prices[ch]===null || p.prices[ch]===''){
            // sadece D√ºkkan i√ßi zorunlu; diƒüerleri bo≈ü kalabilir (fallback √ßalƒ±≈üƒ±r)
          }
        }
      }catch(e){}
    }

    function getProductPrice(p, channel){
      if(!p) return 0;
      var ch = String(channel||'').trim();
      if(p.prices && ch && p.prices[ch]!==undefined && p.prices[ch]!==null && p.prices[ch]!==''){
        return Number(p.prices[ch])||0;
      }
      return Number(p.price)||0;
    }

    function syncCartPricesToChannel(){
      var b = getBranch();
      if(!b) return;
      for(var i=0;i<cart.length;i++){
        var it = cart[i];
        var p = findProduct(b.products, it.id);
        if(p){
          ensureProductPrices(p);
          it.price = getProductPrice(p, activeChannel);
        }
      }
    }

    // ====== TELEFON KURYE √úCRETƒ∞ ======
    function isPhoneChannel(ch){
      return String(ch||'').trim().toLowerCase() === 'telefon';
    }
    function getDeliveryFee(){ return 0; }

    function renderPayButtons(){
      var el = document.getElementById('payButtons');
      if(!el) return;
      var methods = [
        {k:'nakit', t:'üíµ Nakit'},
        {k:'kart', t:'üí≥ Kart'},
        {k:'online', t:'üåê Online'}
      ];
      var html = '';
      for(var i=0;i<methods.length;i++){
        html += '<div class="chip '+(activePayMethod===methods[i].k?'active':'')+'" data-pay="'+methods[i].k+'">'+methods[i].t+'</div>';
      }
      el.innerHTML = html;

      el.onclick = function(ev){
        var t = ev.target;
        while(t && t!==el && !t.getAttribute('data-pay')) t = t.parentElement;
        if(t && t.getAttribute('data-pay')){
          activePayMethod = t.getAttribute('data-pay');
          renderPayButtons();
        }
      };
    }

    function renderPOS(){
      var branch = getBranch();
      var catBar = document.getElementById('catBar');
      var posGrid = document.getElementById('posGrid');
      var channelButtons = document.getElementById('channelButtons');
      if(!branch || !catBar || !posGrid || !channelButtons) return;

      var i, c, html;

      // Kategoriler
      html = '<div class="chip '+(activeCat==='Hepsi'?'active':'')+'" data-cat="Hepsi">üì¶ Hepsi</div>';
      for(i=0;i<state.categories.length;i++){
        c = state.categories[i];
        html += '<div class="chip '+(activeCat===c?'active':'')+'" data-cat="'+esc(c)+'">'+getCategoryIcon(c)+' '+esc(c)+'</div>';
      }
      catBar.innerHTML = html;

      // Kanallar
      html = '';
      var allChans = (state.salesChannels && state.salesChannels.length) ? state.salesChannels : DEFAULTS.salesChannels;
      var activeChans = getActiveSalesChannels();
      if(activeChans.indexOf(activeChannel)===-1) activeChannel = activeChans[0] || allChans[0] || 'D√ºkkan ƒ∞√ßi';
      for(i=0;i<allChans.length;i++){
        c = allChans[i];
        var inactive = isInactiveChannel(c);
        var cls = 'chip ' + (activeChannel===c?'active ':'') + (inactive?'disabled':'');
        if(inactive){
          html += '<div class="'+cls+'" data-channel-disabled="1">üîí '+esc(c)+'</div>';
        }else{
          html += '<div class="'+cls+'" data-channel="'+esc(c)+'">üìç '+esc(c)+'</div>';
        }
      }
      channelButtons.innerHTML = html;

// √úr√ºnler

      var prods = branch.products || [];
      html = '';
      for(i=0;i<prods.length;i++){
        var p = prods[i];
        if(activeCat!=='Hepsi' && p.cat!==activeCat) continue;

        var st = Number(p.stock)||0;
        var stockText = 'Stok: '+st;
        var stockCls = (st<=0) ? 'stock zero' : 'stock';

        html += '<div class="product" data-pid="'+esc(p.id)+'" title="Sepete ekle">'
          +   '<div class="pico">'+esc(p.icon || getCategoryIcon(p.cat))+'</div>'
          +   '<div style="min-width:0;">'
          +     '<b class="pname">'+esc(p.name)+'</b>'
          +     '<div class="price">'+Number(getProductPrice(p, activeChannel)).toFixed(2)+' ‚Ç∫</div>'
          +     '<div class="'+stockCls+'">'+esc(stockText)+'</div>'
          +   '</div>'
          + '</div>';
      }
      posGrid.innerHTML = html;

      // √ºr√ºn tƒ±klama (event delegation)
      posGrid.onclick = function(ev){
        var el = ev.target;
        while(el && el!==posGrid && !el.getAttribute('data-pid')) el = el.parentElement;
        if(el && el.getAttribute('data-pid')){
          addToCart(Number(el.getAttribute('data-pid')));
        }
      };

      // kategori tƒ±klama
      catBar.onclick = function(ev){
        var el = ev.target;
        while(el && el!==catBar && !el.getAttribute('data-cat')) el = el.parentElement;
        if(el && el.getAttribute('data-cat')){
          activeCat = el.getAttribute('data-cat');
          renderPOS();
        }
      };

      // kanal tƒ±klama
      channelButtons.onclick = function(ev){
        var el = ev.target;
        while(el && el!==channelButtons && !el.getAttribute('data-channel') && !el.getAttribute('data-channel-disabled')) el = el.parentElement;
        if(!el || el===channelButtons) return;
        if(el.getAttribute('data-channel-disabled')){
          alert('Bu satƒ±≈ü kanalƒ± ≈üu an pasif. Hesap a√ßƒ±lƒ±nca aktif edilebilir.');
          return;
        }
        var ch = el.getAttribute('data-channel');
        if(ch){
          activeChannel = ch;
          // Kanal deƒüi≈ütiyse sepetteki fiyatlarƒ± g√ºncelle
          syncCartPricesToChannel();
          renderPOS();
        }
      };


      renderCart();
      renderPayButtons();
    }

    function calcCartSubtotal(){
      var t = 0;
      for(var i=0;i<cart.length;i++){
        t += (Number(cart[i].price)||0) * (Number(cart[i].qty)||0);
      }
      return t;
    }

    function calcCartTotal(){ return calcCartSubtotal(); }

    function renderCart(){
      var el = document.getElementById('cartList');
      if(!el) return;

      if(cart.length===0){
        el.innerHTML = '<div class="cart-empty">Sepet bo≈ü</div>';
        setText('cartSubtotal', '0.00 ‚Ç∫');
        setText('cartTotal', '0.00 ‚Ç∫');
        var fr = document.getElementById('deliveryFeeRow');
        if(fr) fr.style.display = 'none';
        return;
      }

      var html = '';
      for(var i=0;i<cart.length;i++){
        var it = cart[i];
        html += '<div class="cart-item">'
          +   '<div style="min-width:0;">'
          +     '<div style="font-weight:900;">'+esc(it.name)+'</div>'
          +     '<div class="muted" style="font-size:12px; margin-top:3px;">'+Number(it.price).toFixed(2)+' ‚Ç∫</div>'
          +   '</div>'
          +   '<div class="row" style="gap:6px;">'
          +     '<button class="btn btn-sm" type="button" onclick="changeCartQty('+it.id+', -1)">‚àí</button>'
          +     '<div style="min-width:28px; text-align:center; font-weight:900;">'+it.qty+'</div>'
          +     '<button class="btn btn-sm" type="button" onclick="changeCartQty('+it.id+', 1)">+</button>'
          +   '</div>'
          + '</div>';
      }
      el.innerHTML = html;

      // Telefon kanalƒ±nda kurye √ºcreti alanƒ±nƒ± g√∂ster
      var feeRow = document.getElementById('deliveryFeeRow');
      if(feeRow) feeRow.style.display = isPhoneChannel(activeChannel) ? 'block' : 'none';

      setText('cartSubtotal', calcCartSubtotal().toFixed(2)+' ‚Ç∫');
      setText('cartTotal', calcCartTotal().toFixed(2)+' ‚Ç∫');
    }

    function addToCart(pid){
      var b = getBranch();
      var p = findProduct(b.products, pid);
      if(!p) return;

      var stock = Number(p.stock)||0;
      if(stock<=0){
        alert('Stok yok!');
        return;
      }

      // sepette var mƒ±
      for(var i=0;i<cart.length;i++){
        if(Number(cart[i].id)===Number(pid)){
          if(cart[i].qty + 1 > stock){
            alert('Yetersiz stok! (Mevcut: '+stock+')');
            return;
          }
          cart[i].qty += 1;
          renderCart();
          return;
        }
      }

      ensureProductPrices(p);
      cart.push({ id:p.id, name:p.name, price:getProductPrice(p, activeChannel), qty:1 });
      renderCart();
    }

    function changeCartQty(pid, delta){
      var b = getBranch();
      var p = findProduct(b.products, pid);
      if(!p) return;
      var stock = Number(p.stock)||0;

      for(var i=0;i<cart.length;i++){
        if(Number(cart[i].id)===Number(pid)){
          var next = cart[i].qty + delta;
          if(next<=0){
            cart.splice(i,1);
            renderCart();
            return;
          }
          if(next > stock){
            alert('Yetersiz stok! (Mevcut: '+stock+')');
            return;
          }
          cart[i].qty = next;
          renderCart();
          return;
        }
      }
    }

    function clearCart(){
      if(cart.length===0) return;
      if(!confirm('Sepeti temizlemek istiyor musunuz?')) return;
      cart = [];
      renderCart();
    }

    function checkout(){
      var b = getBranch();
      if(cart.length===0){
        alert('Sepet bo≈ü!');
        return;
      }

      // stok kontrol + d√º≈ü
      for(var i=0;i<cart.length;i++){
        var it = cart[i];
        var p = findProduct(b.products, it.id);
        if(!p){ alert('√úr√ºn bulunamadƒ±: '+it.name); return; }
        var st = Number(p.stock)||0;
        if(it.qty > st){
          alert('Yetersiz stok: '+it.name+' (Mevcut: '+st+')');
          return;
        }
      }
      for(i=0;i<cart.length;i++){
        it = cart[i];
        p = findProduct(b.products, it.id);
        p.stock = (Number(p.stock)||0) - (Number(it.qty)||0);
      }

      var subtotal = calcCartSubtotal();
      var deliveryFee = 0;
      var total = subtotal;

      var now = new Date();
      var sale = {
        id: newId(),
        date: now.toISOString(),
        dateKey: istanbulDateKeyFromDate(now),
        items: cloneItems(cart),
        subtotal: subtotal,
        deliveryFee: deliveryFee,
        total: total,
        method: activePayMethod,
        channel: activeChannel
      };
      b.sales.push(sale);
      if(SheetsSync && SheetsSync.isReady()){
        SheetsSync.logSale(getBranchKey(), sale);
      }
      save();
      cart = [];
      setVal('deliveryFee','');
      renderPOS();
      alert('Satƒ±≈ü kaydedildi!');
    }

    // ====== DASHBOARD / SALES TABLE ======
    function renderDashboard(){
      var b = getBranch();
      if(!b) return;

      var turnover = 0, expense = 0;
      for(var i=0;i<b.sales.length;i++) turnover += Number(b.sales[i].total)||0;
      for(i=0;i<b.expenses.length;i++) expense += Number(b.expenses[i].amount)||0;

      setText('repTurnover', turnover.toFixed(2)+' ‚Ç∫');
      setText('repExpense', expense.toFixed(2)+' ‚Ç∫');
      setText('repCount', String(b.sales.length));
      setText('repNet', (turnover-expense).toFixed(2)+' ‚Ç∫');

      filterSales();
    }

    function findSale(sales, id){
      for(var i=0;i<sales.length;i++){
        if(Number(sales[i].id)===Number(id)) return sales[i];
      }
      return null;
    }

    function renderSalesTable(list){
      var b = getBranch();
      var tb = document.getElementById('salesTable');
      if(!tb || !b) return;

      var sales = list || b.sales || [];
      var html = '';

      // en yeni en √ºstte
      sales = sales.slice().sort(function(a,b){ return (new Date(b.date)) - (new Date(a.date)); });

      for(var i=0;i<sales.length;i++){
        var s = sales[i];
        var d = new Date(s.date);
        var ds = d.toLocaleString('tr-TR');

        var itemsStr = '';
        for(var j=0;j<s.items.length;j++){
          itemsStr += s.items[j].name + ' x' + s.items[j].qty + (j<s.items.length-1 ? ', ' : '');
        }

        html += '<tr>'
          + '<td>'+esc(ds)+'</td>'
          + '<td>'+esc(s.channel||'')+'</td>'
          + '<td>'+esc((s.method||'').toUpperCase())+'</td>'
          + '<td>'+Number(s.total||0).toFixed(2)+' ‚Ç∫</td>'
          + '<td>'+esc(itemsStr)+'</td>'
          + '<td><button class="btn btn-sm" type="button" onclick="openEditSale('+s.id+')">‚úèÔ∏è</button></td>'
          + '</tr>';
      }

      tb.innerHTML = html || '<tr><td colspan="6" class="muted">Satƒ±≈ü yok</td></tr>';
    }

    function filterSales(){
      var b = getBranch();
      if(!b) return;

      var dateFilter = getVal('salesDateFilter');
      var chFilter = getVal('salesChannelFilter');
      var q = (getVal('salesSearch')||'').toLowerCase().trim();

      var out = [];
      for(var i=0;i<b.sales.length;i++){
        var s = b.sales[i];

        if(dateFilter){
          var sKey = s.dateKey || istanbulDateKeyFromIso(s.date);
          if(sKey !== dateFilter) continue;
        }

        if(chFilter && chFilter!=='Hepsi'){
          if((s.channel||'') !== chFilter) continue;
        }

        if(q){
          var hay = (String(s.id)+' '+(s.channel||'')+' '+(s.method||'')+' ');
          for(var j=0;j<s.items.length;j++){
            hay += (s.items[j].name||'')+' ';
          }
          if(hay.toLowerCase().indexOf(q)===-1) continue;
        }

        out.push(s);
      }

      renderSalesTable(out);
    }

    function renderSalesChannelFilter(extraChannel){
      var channels = (state.salesChannels && state.salesChannels.length) ? state.salesChannels.slice() : DEFAULTS.salesChannels.slice();
      if(extraChannel){
        var ex = String(extraChannel||'').trim();
        if(ex && channels.indexOf(ex)===-1) channels = channels.concat([ex]);
      }

      // Dashboard filtresi
      var el = document.getElementById('salesChannelFilter');
      if(el){
        var prev = el.value || 'Hepsi';
        var html = '<option value="Hepsi">Hepsi</option>';
        for(var i=0;i<channels.length;i++){
          html += '<option value="'+esc(channels[i])+'">'+esc(channels[i])+'</option>';
        }
        el.innerHTML = html;
        if(prev) el.value = prev;
      }

      // Satƒ±≈ü d√ºzenleme modalƒ±
      var el2 = document.getElementById('editSaleChannel');
      if(el2){
        var prev2 = el2.value || '';
        var html2 = '';
        for(var j=0;j<channels.length;j++){
          html2 += '<option value="'+esc(channels[j])+'">'+esc(channels[j])+'</option>';
        }
        el2.innerHTML = html2;
        if(prev2) el2.value = prev2;
      }
    }

    // ====== EDIT SALE MODAL ======
    var editingSaleId = null;
    var saleDraft = null;
    var saleOriginalSnapshot = null;

    function openEditSale(id){
      var b = getBranch();
      var sale = findSale(b.sales, id);
      if(!sale) return;

      editingSaleId = id;

      // snapshot'lar
      saleOriginalSnapshot = deepClone(sale);
      saleDraft = deepClone(sale);

      renderSalesChannelFilter(sale.channel);
      setVal('editSaleChannel', sale.channel || getActiveSalesChannels()[0] || 'D√ºkkan ƒ∞√ßi');
      setVal('editSaleMethod', sale.method || 'nakit');
      setVal('editDeliveryFee', (sale.deliveryFee!==undefined && sale.deliveryFee!==null) ? String(Number(sale.deliveryFee)||0) : '');

      // Kanal deƒüi≈üince fiyatlarƒ± yeni kanala g√∂re g√ºncelle
      var chSel = document.getElementById('editSaleChannel');
      if(chSel){
        chSel.onchange = function(){
          var newCh = getVal('editSaleChannel');
          repriceDraftItemsForChannel(newCh);
          renderEditSaleItems();
        };
      }

      renderEditSaleItems();
      document.getElementById('editModal').classList.remove('hidden');
    }

    function closeEditModal(){
      var m = document.getElementById('editModal');
      if(m) m.classList.add('hidden');
      editingSaleId = null;
      saleDraft = null;
      saleOriginalSnapshot = null;
    }

    function renderEditSaleItems(){
      var el = document.getElementById('editSaleItems');
      if(!el || !saleDraft) return;

      var b = getBranch();
      var html = '';

      for(var i=0;i<saleDraft.items.length;i++){
        var it = saleDraft.items[i];
        var p = findProduct(b.products, it.id);
        var stock = p ? Number(p.stock)||0 : 0;

        // max qty = mevcut stok + (orijinal satƒ±≈üta bu √ºr√ºnden ka√ß vardƒ±)
        var origQty = 0;
        for(var j=0;j<saleOriginalSnapshot.items.length;j++){
          if(Number(saleOriginalSnapshot.items[j].id)===Number(it.id)){
            origQty = Number(saleOriginalSnapshot.items[j].qty)||0;
            break;
          }
        }
        var maxQty = stock + origQty;

        html += '<div class="cart-item" style="border-bottom:1px solid var(--border); padding:10px 0;">'
          +   '<div style="min-width:0;">'
          +     '<div style="font-weight:900;">'+esc(it.name)+'</div>'
          +     '<div class="muted" style="font-size:12px; margin-top:3px;">Mevcut stok: '+stock+' | Limit: '+maxQty+'</div>'
          +   '</div>'
          +   '<div class="row" style="gap:6px;">'
          +     '<button class="btn btn-sm" type="button" onclick="editSaleQty('+it.id+', -1)">‚àí</button>'
          +     '<div style="min-width:28px; text-align:center; font-weight:900;">'+it.qty+'</div>'
          +     '<button class="btn btn-sm" type="button" onclick="editSaleQty('+it.id+', 1)">+</button>'
          +   '</div>'
          + '</div>';
      }

      el.innerHTML = html;

      updateEditSaleTotals();
    }

    function calcItemsTotal(items){
      var t = 0;
      for(var i=0;i<items.length;i++){
        t += (Number(items[i].price)||0) * (Number(items[i].qty)||0);
      }
      return t;
    }

    function repriceDraftItemsForChannel(channel){
      if(!saleDraft) return;
      var b = getBranch();
      for(var i=0;i<saleDraft.items.length;i++){
        var it = saleDraft.items[i];
        var p = findProduct(b.products, it.id);
        if(p){
          // Eƒüer √ºr√ºn fiyatƒ± kanala g√∂re tanƒ±mlƒ±ysa yeni fiyata ge√ß
          if(p.prices && p.prices[channel]!==undefined && p.prices[channel]!==null && p.prices[channel]!==''){
            it.price = Number(p.prices[channel])||0;
          }else{
            // fallback: d√ºkkan fiyatƒ± / mevcut
            if(p.price!==undefined && p.price!==null) it.price = Number(p.price)||0;
          }
        }
      }
    }

    function updateEditSaleTotals(){
      if(!saleDraft) return;
      var ch = getVal('editSaleChannel') || saleDraft.channel || 'D√ºkkan ƒ∞√ßi';

      // telefon ise kurye alanƒ± a√ßƒ±k
      var feeRow = document.getElementById('editDeliveryFeeRow');
      if(feeRow) feeRow.style.display = (String(ch).trim().toLowerCase()==='telefon') ? 'block' : 'none';

      var sub = calcItemsTotal(saleDraft.items || []);
      var fee = 0;
      if(String(ch).trim().toLowerCase()==='telefon'){
        fee = Number(getVal('editDeliveryFee')||0) || 0;
      }else{
        setVal('editDeliveryFee','');
      }

      saleDraft.subtotal = sub;
      saleDraft.deliveryFee = fee;
      saleDraft.total = sub + fee;

      setText('editSaleSubtotal', sub.toFixed(2)+' ‚Ç∫');
      setText('editSaleTotal', (sub+fee).toFixed(2)+' ‚Ç∫');
    }


    function editSaleQty(pid, delta){
      if(!saleDraft || !saleOriginalSnapshot) return;
      var b = getBranch();
      var p = findProduct(b.products, pid);
      var stock = p ? Number(p.stock)||0 : 0;

      // orijinal qty
      var origQty = 0;
      for(var j=0;j<saleOriginalSnapshot.items.length;j++){
        if(Number(saleOriginalSnapshot.items[j].id)===Number(pid)){
          origQty = Number(saleOriginalSnapshot.items[j].qty)||0;
          break;
        }
      }
      var maxQty = stock + origQty;

      for(var i=0;i<saleDraft.items.length;i++){
        if(Number(saleDraft.items[i].id)===Number(pid)){
          var next = saleDraft.items[i].qty + delta;
          if(next<1) next = 1;
          if(next>maxQty){
            alert('Limit a≈üƒ±ldƒ±! Maks: '+maxQty);
            return;
          }
          saleDraft.items[i].qty = next;
          break;
        }
      }
      renderEditSaleItems();
    }

    function updateSale(){
      var b = getBranch();
      var sale = findSale(b.sales, editingSaleId);
      if(!sale || !saleDraft || !saleOriginalSnapshot) return;

      var newMethod = getVal('editSaleMethod') || 'nakit';
      var newChannel = getVal('editSaleChannel') || (state.salesChannels && state.salesChannels[0]) || 'D√ºkkan ƒ∞√ßi';

      // 1) eski satƒ±≈üƒ±n stok etkisini geri al
      for(var i=0;i<saleOriginalSnapshot.items.length;i++){
        var oi = saleOriginalSnapshot.items[i];
        var p1 = findProduct(b.products, oi.id);
        if(p1) p1.stock = (Number(p1.stock)||0) + (Number(oi.qty)||0);
      }

      // 2) yeni taslaƒüa g√∂re d√º≈ü (kontrol)
      for(i=0;i<saleDraft.items.length;i++){
        var ni = saleDraft.items[i];
        var p2 = findProduct(b.products, ni.id);
        if(!p2){
          // fail-safe: eskiyi tekrar d√º≈ü
          for(var j=0;j<saleOriginalSnapshot.items.length;j++){
            var oi2 = saleOriginalSnapshot.items[j];
            var pp = findProduct(b.products, oi2.id);
            if(pp) pp.stock = (Number(pp.stock)||0) - (Number(oi2.qty)||0);
          }
          alert('√úr√ºn bulunamadƒ±: '+ni.name+' (Bu √ºr√ºn ge√ßmi≈üte silinmi≈ü olabilir)');
          return;
        }
        var st = Number(p2.stock)||0;
        if(Number(ni.qty) > st){
          // fail-safe: eskiyi tekrar d√º≈ü
          for(var j2=0;j2<saleOriginalSnapshot.items.length;j2++){
            var oi22 = saleOriginalSnapshot.items[j2];
            var pp2 = findProduct(b.products, oi22.id);
            if(pp2) pp2.stock = (Number(pp2.stock)||0) - (Number(oi22.qty)||0);
          }
          alert('Yetersiz stok: '+ni.name+' (Mevcut: '+st+')');
          return;
        }
      }
      for(i=0;i<saleDraft.items.length;i++){
        ni = saleDraft.items[i];
        p2 = findProduct(b.products, ni.id);
        p2.stock = (Number(p2.stock)||0) - (Number(ni.qty)||0);
      }

      sale.method = newMethod;
      sale.channel = newChannel;
      sale.items = cloneItems(saleDraft.items);

      // Totaller (telefon kurye dahil)
      sale.subtotal = calcItemsTotal(sale.items);
      sale.deliveryFee = (String(newChannel).trim().toLowerCase()==='telefon') ? (Number(getVal('editDeliveryFee')||0) || 0) : 0;
      sale.total = (Number(sale.subtotal)||0) + (Number(sale.deliveryFee)||0);

      // dateKey yoksa geri doldur
      if(!sale.dateKey) sale.dateKey = istanbulDateKeyFromIso(sale.date);

      save();
      closeEditModal();
      renderAll();
      alert('Satƒ±≈ü g√ºncellendi!');
    }

    function deleteSale(){
      var b = getBranch();
      var sale = findSale(b.sales, editingSaleId);
      if(!sale) return;

      if(!confirm('Bu satƒ±≈üƒ± silmek istiyor musunuz?')) return;

      // stoklarƒ± geri ver
      for(var i=0;i<sale.items.length;i++){
        var it = sale.items[i];
        var p = findProduct(b.products, it.id);
        if(p) p.stock = (Number(p.stock)||0) + (Number(it.qty)||0);
      }

      // satƒ±≈ütan √ßƒ±kar
      for(i=0;i<b.sales.length;i++){
        if(Number(b.sales[i].id)===Number(editingSaleId)){
          b.sales.splice(i,1);
          break;
        }
      }

      save();
      closeEditModal();
      renderAll();
      alert('Satƒ±≈ü silindi.');
    }

    // ====== INVENTORY ======

    function renderChannelPriceFields(prices){
      var wrap = document.getElementById('channelPriceFields');
      if(!wrap) return;

      var chans = state.salesChannels || [];
      var html = '';
      for(var i=0;i<chans.length;i++){
        var ch = String(chans[i]||'').trim();
        if(!ch) continue;
        if(ch==='D√ºkkan ƒ∞√ßi') continue;

        var v = '';
        if(prices && prices[ch]!==undefined && prices[ch]!==null && prices[ch]!==''){
          v = String(prices[ch]);
        }

        html += '<div>'
          +   '<div class="muted" style="font-size:12px; margin-bottom:6px;">'+esc(ch)+'</div>'
          +   '<input class="pChPrice" data-channel="'+esc(ch)+'" type="number" step="0.01" min="0" placeholder="(bo≈ü)" value="'+esc(v)+'">'
          + '</div>';
      }
      wrap.innerHTML = html;
    }


    function resetProductForm(){
      setVal('pId','');
      setVal('pName','');
      setVal('pPrice','');
      setVal('pStock','');
      setVal('pIcon','');
      if(state.categories && state.categories[0]) setVal('pCat', state.categories[0]);
      renderChannelPriceFields(null);
    }

    
function cloneObj(o){ try{ return JSON.parse(JSON.stringify(o||{})); }catch(e){ return {}; } }
function normNameForMatch(s){
      // T√ºrk√ße isim e≈üle≈ütirme i√ßin daha g√ºvenli normalizasyon
      return (s||'')
        .toString()
        .toLocaleLowerCase('tr-TR')
        .replace(/[‚Äô'`]/g,'')
        .replace(/\s+/g,' ')
        .trim();
    }

// Hastane & Cihanpol fiyatlarƒ± aynƒ± kalacak: √ºr√ºn g√ºncellemesi (isim/kategori/ikon/fiyatlar) t√ºm ≈üubelere uygulanƒ±r.
// Stoklar ≈üube bazƒ±nda ayrƒ± tutulur.
function syncProductAcrossBranches(srcBranchKey, prod){
  var branches = state.branches || {};
  var keys = Object.keys(branches);
  for(var i=0;i<keys.length;i++){
    var bk = keys[i];
    if(bk===srcBranchKey) continue;
    var arr = (branches[bk] && branches[bk].products) ? branches[bk].products : [];
    var target = null;
    for(var j=0;j<arr.length;j++){ if(String(arr[j].id)===String(prod.id)) { target = arr[j]; break; } }
    if(!target){
      var n = normNameForMatch(prod.name);
      for(var k=0;k<arr.length;k++){ if(normNameForMatch(arr[k].name)===n){ target = arr[k]; break; } }
    }
    if(target){
      target.name = prod.name;
      target.cat = prod.cat;
      target.icon = prod.icon;
      target.price = prod.price;
      target.prices = cloneObj(prod.prices);
    }else{
      arr.push({id:prod.id,name:prod.name,cat:prod.cat,icon:prod.icon,price:prod.price,prices:cloneObj(prod.prices),stock:prod.stock||0});
      branches[bk].products = arr;
    }
  }
}

function saveProduct(){
      var b = getBranch();
      var p = null;
      var idRaw = getVal('pId');
      var name = getVal('pName').trim();
      var cat = getVal('pCat');
      var price = Number(getVal('pPrice')||0);
      var stock = Number(getVal('pStock')||0);
      var icon = getVal('pIcon').trim();

      // Kanal bazlƒ± fiyatlar
      var prices = { 'D√ºkkan ƒ∞√ßi': price };
      try{
        var nodes = document.querySelectorAll('#channelPriceFields .pChPrice');
        for(var pi=0; pi<nodes.length; pi++){
          var ch = nodes[pi].getAttribute('data-channel') || '';
          ch = String(ch).trim();
          if(!ch || ch==='D√ºkkan ƒ∞√ßi') continue;
          var vv = (nodes[pi].value||'').trim();
          if(vv!==''){
            prices[ch] = Number(vv)||0;
          }
        }
      }catch(e){}

      if(!name){ alert('√úr√ºn adƒ± bo≈ü olamaz'); return; }
      if(!cat){ alert('Kategori se√ß'); return; }

      if(idRaw){
        // update
        var p = findProduct(b.products, Number(idRaw));
        if(!p){ alert('√úr√ºn bulunamadƒ±'); return; }
        p.name = name;
        p.cat = cat;
        p.price = price;
        p.stock = stock;
        p.icon = icon;
        p.prices = prices;
      }else{
        // new
        var id = newId();
        b.products.push({
          id:id,
          name:name,
          cat:cat,
          price:price,
          stock:stock,
          icon:icon,
          prices: prices
        });
    p = b.products[b.products.length-1];
      }
      if(p){ syncProductAcrossBranches(getBranchKey(), p); }
      save();
      if(p && SheetsSync && SheetsSync.logProduct){ SheetsSync.logProduct(getBranchKey(), p); }
      resetProductForm();
      renderAll();
      alert('√úr√ºn kaydedildi!');
    }

    function editProduct(id){
      var b = getBranch();
      var p = findProduct(b.products, id);
      if(!p) return;
      setVal('pId', p.id);
      setVal('pName', p.name);
      setVal('pCat', p.cat);
      setVal('pPrice', p.price);
      setVal('pStock', p.stock);
      setVal('pIcon', p.icon||'');
      renderChannelPriceFields(p.prices || null);
      switchView('inventory');
    }

    function deleteProduct(id){
      // Bu s√ºr√ºmde basit silme: (ƒ∞stersen ge√ßmi≈ü satƒ±≈üta kullanƒ±ldƒ±ysa engel ekleriz)
      var b = getBranch();
      if(!confirm('√úr√ºn√º silmek istiyor musunuz?')) return;

      for(var i=0;i<b.products.length;i++){
        if(Number(b.products[i].id)===Number(id)){
          b.products.splice(i,1);
          break;
        }
      }
      save();
      renderAll();
    }

    function renderInventory(){
      renderInventoryFilters();
      filterProducts();
    }

    function renderInventoryFilters(){
      var sel = document.getElementById('pCat');
      if(sel){
        var html = '';
        for(var i=0;i<state.categories.length;i++){
          html += '<option value="'+esc(state.categories[i])+'">'+esc(state.categories[i])+'</option>';
        }
        sel.innerHTML = html;
      }

      var sel2 = document.getElementById('invCatFilter');
      if(sel2){
        var html2 = '<option value="Hepsi">Hepsi</option>';
        for(i=0;i<state.categories.length;i++){
          html2 += '<option value="'+esc(state.categories[i])+'">'+esc(state.categories[i])+'</option>';
        }
        sel2.innerHTML = html2;
      }

      var sel3 = document.getElementById('invPriceChannel');
      if(sel3){
        var html3 = '';
        var chans = (state.salesChannels && state.salesChannels.length) ? state.salesChannels : DEFAULTS.salesChannels;
        for(i=0;i<chans.length;i++){
          html3 += '<option value="'+esc(chans[i])+'">'+esc(chans[i])+'</option>';
        }
        sel3.innerHTML = html3;
        if(!sel3.value && chans[0]) sel3.value = chans[0];
      }

      renderChannelPriceFields(null);
    }

    function filterProducts(){
      var b = getBranch();
      var cat = getVal('invCatFilter');
      var q = (getVal('invSearch')||'').toLowerCase().trim();

      var list = [];
      for(var i=0;i<b.products.length;i++){
        var p = b.products[i];
        if(cat && cat!=='Hepsi' && p.cat!==cat) continue;
        if(q && (p.name||'').toLowerCase().indexOf(q)===-1) continue;
        list.push(p);
      }
      renderInventoryTable(list);
    }

    function renderInventoryTable(list){
      var tb = document.getElementById('inventoryBody');
      if(!tb) return;

      var html = '';
      for(var i=0;i<list.length;i++){
        var p = list[i];
        html += '<tr>'
          + '<td>'+esc(p.icon||'')+' '+esc(p.name)+'</td>'
          + '<td>'+esc(p.cat||'')+'</td>'
          + '<td>'+Number(getProductPrice(p, (getVal('invPriceChannel')||'D√ºkkan ƒ∞√ßi'))).toFixed(2)+' ‚Ç∫</td>'
          + '<td>'+Number(p.stock||0)+'</td>'
          + '<td>'
          +   '<button class="btn btn-sm" type="button" onclick="editProduct('+p.id+')">‚úèÔ∏è</button> '
          +   '<button class="btn btn-sm btn-danger" type="button" onclick="deleteProduct('+p.id+')">üóëÔ∏è</button>'
          + '</td>'
          + '</tr>';
      }
      tb.innerHTML = html || '<tr><td colspan="5" class="muted">√úr√ºn yok</td></tr>';
    }

    // ====== EXPENSES ======
    function resetExpenseForm(){
      setVal('expDesc','');
      setVal('expAmount','');
      // date'i bug√ºne √ßek
      var d = new Date();
      var y = d.getFullYear();
      var m = String(d.getMonth()+1).padStart(2,'0');
      var da = String(d.getDate()).padStart(2,'0');
      setVal('expDate', y+'-'+m+'-'+da);
    }

    function renderExpenseSelectors(){
      var sel = document.getElementById('expType');
      if(sel){
        var html = '';
        for(var i=0;i<state.expenseTypes.length;i++){
          html += '<option value="'+esc(state.expenseTypes[i])+'">'+esc(state.expenseTypes[i])+'</option>';
        }
        sel.innerHTML = html;
      }

      var sel2 = document.getElementById('expTypeFilter');
      if(sel2){
        var html2 = '<option value="Hepsi">Hepsi</option>';
        for(i=0;i<state.expenseTypes.length;i++){
          html2 += '<option value="'+esc(state.expenseTypes[i])+'">'+esc(state.expenseTypes[i])+'</option>';
        }
        sel2.innerHTML = html2;
      }
    }

    function addExpense(){
      var b = getBranch();
      var date = getVal('expDate');
      var type = getVal('expType');
      var desc = getVal('expDesc').trim();
      var amount = Number(getVal('expAmount')||0);

      if(!date){ alert('Tarih se√ß'); return; }
      if(!type){ alert('Tip se√ß'); return; }
      if(!amount || amount<=0){ alert('Tutar gir'); return; }

        var expObj = {
        id:newId(),
        date:date,
        type:type,
        desc:desc,
        amount:amount
      };
      b.expenses.push(expObj);

      if(SheetsSync && SheetsSync.isReady()){
  SheetsSync.logExpense(getBranchKey(), expObj);
}

save();
resetExpenseForm();
renderAll();
alert('Gider eklendi!');
    }

    function deleteExpense(id){
      if(!confirm('Gideri silmek istiyor musunuz?')) return;
      var b = getBranch();
      for(var i=0;i<b.expenses.length;i++){
        if(Number(b.expenses[i].id)===Number(id)){
          b.expenses.splice(i,1);
          break;
        }
      }
      save();
      renderAll();
    }

    function filterExpenses(){
      var b = getBranch();
      var type = getVal('expTypeFilter');
      var q = (getVal('expSearch')||'').toLowerCase().trim();

      var out = [];
      for(var i=0;i<b.expenses.length;i++){
        var e = b.expenses[i];
        if(type && type!=='Hepsi' && e.type!==type) continue;
        if(q){
          var hay = (e.desc||'')+' '+(e.type||'');
          if(hay.toLowerCase().indexOf(q)===-1) continue;
        }
        out.push(e);
      }
      renderExpensesTable(out);
    }

    function renderExpensesTable(list){
      var tb = document.getElementById('expensesTable');
      if(!tb) return;

      // yeni en √ºstte
      list = list.slice().sort(function(a,b){
        return (new Date(b.date)) - (new Date(a.date));
      });

      var html = '';
      for(var i=0;i<list.length;i++){
        var e = list[i];
        html += '<tr>'
          + '<td>'+esc(e.date||'')+'</td>'
          + '<td>'+esc(e.type||'')+'</td>'
          + '<td>'+esc(e.desc||'')+'</td>'
          + '<td>'+Number(e.amount||0).toFixed(2)+' ‚Ç∫</td>'
          + '<td><button class="btn btn-sm btn-danger" type="button" onclick="deleteExpense('+e.id+')">üóëÔ∏è</button></td>'
          + '</tr>';
      }
      tb.innerHTML = html || '<tr><td colspan="5" class="muted">Gider yok</td></tr>';
    }

    function renderExpenses(){
      renderExpenseSelectors();
      resetExpenseForm();
      filterExpenses();
    }

    // ====== EXPORT / IMPORT ======
    function exportBackup(){
      var data = JSON.stringify(state, null, 2);
      var blob = new Blob([data], {type:'application/json'});
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'mahsum_usta_yedek_'+Date.now()+'.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function importBackupFile(file){
      var fr = new FileReader();
      fr.onload = function(){
        try{
          var obj = JSON.parse(fr.result);
          obj = normalizeAndBackfill(obj);
          state = obj;
          save(true);
          renderAll();
          alert('Yedek y√ºklendi!');
        }catch(e){
          alert('Yedek okunamadƒ±.');
        }
      };
      fr.readAsText(file);
    }

    // ====== RENDER ALL ======
    function renderSelectors(){
      renderSalesChannelFilter();
      renderInventoryFilters();
      renderExpenseSelectors();
    }

    function renderAll(){
      refreshBranchLabel();
      updateDataSourceLabels();
      renderSelectors();

      // aktif sayfayƒ± tekrar √ßiz
      var active = document.querySelector('.page-view.active');
      if(active){
        var id = active.id.replace('view-','');
        if(id==='pos') renderPOS();
        if(id==='dashboard'){ renderDashboard(); renderSalesTable(); }
        if(id==='inventory') renderInventory();
        if(id==='expenses') renderExpenses();
      }
    }

    // ====== INIT ======
    function bindBranchSelect(){
      var sel = document.getElementById('branchSelect');
      if(!sel) return;
      sel.addEventListener('change', function(){
        cart = [];
        renderAll();
      });
    }

    function bindBackupButtons(){
      var ex = document.getElementById('btnExport');
      var im = document.getElementById('btnImport');
      var file = document.getElementById('importFile');
      if(ex) ex.onclick = exportBackup;
      if(im) im.onclick = function(){ if(file) file.click(); };
      if(file) file.onchange = function(){
        if(file.files && file.files[0]) importBackupFile(file.files[0]);
        file.value = '';
      };
    }

    // ====== SHEETS LIVE SYNC (GIS token model + Sheets API) ======
    var SheetsSync = (function(){
      var accessToken = null;
      var tokenClient = null;
      var deviceId = null;
      var isApplyingRemote = false;
      var lastPullRev = Number(localStorage.getItem('SHEETS_LAST_PULL_REV') || 0);
      var pushTimer = null;
      var pullTimer = null;
      var pullInFlight = false;

      function nowIso(){ return new Date().toISOString(); }
      // --- TOKEN PERSIST / AUTO-RECONNECT (sessionStorage + silent refresh) ---
      var SESSION_TOKEN_KEY = 'SHEETS_ACCESS_TOKEN';
      var SESSION_TOKEN_EXP_KEY = 'SHEETS_ACCESS_TOKEN_EXP';
      var HAS_CONNECTED_KEY = 'SHEETS_HAS_CONNECTED';

      var pendingTokenResolve = null;
      var pendingTokenReject = null;
      var tokenPurpose = null; // 'init' | 'interactive' | 'refresh'
      var suppressInitAutoConnect = false;


      function clearSessionToken(){
        accessToken = null;
        try{
          sessionStorage.removeItem(SESSION_TOKEN_KEY);
          sessionStorage.removeItem(SESSION_TOKEN_EXP_KEY);
        }catch(e){}
      }

      function storeSessionToken(token, expiresInSec){
        try{
          sessionStorage.setItem(SESSION_TOKEN_KEY, token);
          if(expiresInSec){
            // 60 sn tampon (√ßok kritik: token bitmeden yenileyelim)
            var exp = Date.now() + (Number(expiresInSec)*1000) - 60000;
            sessionStorage.setItem(SESSION_TOKEN_EXP_KEY, String(exp));
          }
          localStorage.setItem(HAS_CONNECTED_KEY, '1'); // kullanƒ±cƒ± en az 1 kez baƒülandƒ±
        }catch(e){}
      }

      function restoreSessionToken(){
        try{
          var tok = sessionStorage.getItem(SESSION_TOKEN_KEY);
          var exp = Number(sessionStorage.getItem(SESSION_TOKEN_EXP_KEY) || 0);
          if(tok && (!exp || exp > Date.now())){
            accessToken = tok;
            pill('sync-ok','‚úÖ Baƒülandƒ±');
            setLast(nowIso());
            // sayfa yenilemede otomatik devam
            startAutoPull();
            // token varsa bir kez √ßekelim
            pull();
            setTimeout(flushOpsQueue, 300);
            return true;
          }
        }catch(e){}
        return false;
      }

      function requestToken(opts, purpose){
        if(!tokenClient){
          suppressInitAutoConnect = true;
          init();
          suppressInitAutoConnect = false;
          if(!tokenClient) return Promise.reject(new Error('NO_TOKEN_CLIENT'));
        }
        // aynƒ± anda birden fazla token istemeyelim
        if(pendingTokenResolve) return new Promise(function(resolve, reject){
          // mevcut isteƒüin sonucu gelince aynƒ± sonucu payla≈ü
          var prevResolve = pendingTokenResolve;
          var prevReject = pendingTokenReject;
          pendingTokenResolve = function(tok){ try{ prevResolve(tok); }catch(e){} resolve(tok); };
          pendingTokenReject = function(err){ try{ prevReject(err); }catch(e){} reject(err); };
        });

        tokenPurpose = purpose || 'interactive';

        return new Promise(function(resolve, reject){
          pendingTokenResolve = resolve;
          pendingTokenReject = reject;
          try{
            tokenClient.requestAccessToken(opts || {});
          }catch(e){
            pendingTokenResolve = null;
            pendingTokenReject = null;
            tokenPurpose = null;
            reject(e);
          }
        });
      }

      function requestTokenSilent(){
        return requestToken({prompt:''}, 'init');
      }

      function requestTokenRefresh(){
        return requestToken({prompt:''}, 'refresh');
      }

      function requestTokenInteractive(){
        return requestToken({prompt:'consent'}, 'interactive');
      }


      function pill(cls, txt){
        var el = document.getElementById('syncPill');
        if(el){
          el.className = 'sync-pill ' + cls;
          el.textContent = txt;
        }

        // Topbar g√∂stergesi
        try{
          var dot = document.getElementById('syncDotTop');
          var lab = document.getElementById('syncTopLabel');
          if(dot){
            var tcls = 'warn';
            if(String(cls).indexOf('sync-ok')!==-1) tcls = 'ok';
            else if(String(cls).indexOf('sync-bad')!==-1) tcls = 'bad';
            else tcls = 'warn';
            dot.className = 'sync-dot ' + tcls;
          }
          if(lab){
            // kƒ±sa metin
            lab.textContent = txt || 'Senkron';
          }
        }catch(e){}
      }
      function setLast(txt){
        var el = document.getElementById('syncLast');
        if(el) el.textContent = 'Son: ' + (txt || '-');
      }

      function isReady(){
        return !!tokenClient;
      }

      function init(){
        deviceId = localStorage.getItem('SHEETS_DEVICE_ID');
        if(!deviceId){
          deviceId = 'dev_' + Date.now() + '_' + Math.floor(Math.random()*1e9);
          localStorage.setItem('SHEETS_DEVICE_ID', deviceId);
        }

        if(!SHEETS_SYNC.enabled){
          pill('sync-warn','‚õî Kapalƒ±');
          return;
        }

        // GIS script'i ge√ß gelirse: onload callback ile tekrar init
        if(!(window.google && google.accounts && google.accounts.oauth2)){
          pill('sync-warn','‚è≥ Google auth hazƒ±r deƒüil');
          return;
        }

        try{
          tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: SHEETS_SYNC.clientId,
            scope: SHEETS_SYNC.scope,
            callback: function(resp){
              // Ba≈üarƒ±lƒ± token
              if(resp && resp.access_token){
                accessToken = resp.access_token;

                // token'ƒ± sayfa yenilemede kaybetmemek i√ßin sessionStorage'a yaz
                storeSessionToken(accessToken, resp.expires_in);

                pill('sync-ok','‚úÖ Baƒülandƒ±');
                setLast(nowIso());

                // otomatik √ßek + kuyruƒüu bo≈üalt
                if(tokenPurpose !== 'refresh'){
                  pull();
                  setTimeout(flushOpsQueue, 300);
                }

                // auto-pull devam etsin
                startAutoPull();

                // bekleyen promise varsa √ß√∂zelim
                if(pendingTokenResolve){
                  try{ pendingTokenResolve(accessToken); }catch(e){}
                }
              }else{
                // Hata/iptal
                if(tokenPurpose === 'refresh'){
                  clearSessionToken();
                }
                pill('sync-warn','üîê Baƒülan');

                if(pendingTokenReject){
                  try{ pendingTokenReject(resp || new Error('TOKEN_ERROR')); }catch(e){}
                }
              }

              // cleanup
              pendingTokenResolve = null;
              pendingTokenReject = null;
              tokenPurpose = null;
            }
          });
          // sayfa yenilemede token'ƒ± geri y√ºkle / sessiz tekrar baƒülan
          if(!restoreSessionToken()){
            if(!suppressInitAutoConnect && localStorage.getItem(HAS_CONNECTED_KEY)==='1'){
              pill('sync-warn','‚è≥ Google baƒülanƒ±yor‚Ä¶');
              requestTokenSilent().catch(function(){ /* sessiz olmazsa kullanƒ±cƒ± tƒ±klar */ });
              // auto-pull connect ile zaten ba≈ülayacak
              startAutoPull();
            }else{
              pill('sync-warn','üîê Baƒülan');
            }
          }
        }catch(e){
          pill('sync-bad','‚ùå Auth init hata');
        }
      }
      // requestTokenInteractive artƒ±k yukarƒ±da Promise'li olarak tanƒ±mlƒ±

      function sheetsFetch(url, opt){
        opt = opt || {};
        opt.headers = opt.headers || {};

        if(!accessToken){
          return Promise.reject(new Error('NO_TOKEN'));
        }

        function doFetch(){
          opt.headers['Authorization'] = 'Bearer ' + accessToken;
          return fetch(url, opt);
        }

        function handleOk(r){
          if(!r.ok){
            return r.text().then(function(t){
              throw new Error('HTTP ' + r.status + ' ' + t);
            });
          }
          return r.json();
        }

        return doFetch().then(function(r){
          // Token s√ºresi bitti -> 1 kez sessiz yenile ve yeniden dene
          if(r.status === 401){
            clearSessionToken();
            return requestTokenRefresh().then(function(){
              return doFetch();
            }).then(handleOk).catch(function(err){
              pill('sync-warn','üîê Baƒülan');
              throw err;
            });
          }
          return handleOk(r);
        });
      }


       // ---- OPS APPEND (satƒ±r ekleme) ----
      var opsQueue = [];
      try { opsQueue = JSON.parse(localStorage.getItem('SHEETS_OPS_QUEUE') || '[]') || []; } catch(e){ opsQueue = []; }

      function saveOpsQueue(){
        try{ localStorage.setItem('SHEETS_OPS_QUEUE', JSON.stringify(opsQueue)); }catch(e){}
      }
      function enqueueOpRow(row){
        opsQueue.push(row);
        saveOpsQueue();
      }

      function appendOpsRows(rows){
        var url = 'https://sheets.googleapis.com/v4/spreadsheets/' + encodeURIComponent(SHEETS_SYNC.spreadsheetId)
          + '/values/' + encodeURIComponent(SHEETS_SYNC.opsAppendRange) + ':append'
          + '?valueInputOption=RAW&insertDataOption=INSERT_ROWS';

        return sheetsFetch(url, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ majorDimension:'ROWS', values: rows })
        });
      }

      function flushOpsQueue(){
        if(!accessToken) return;
        if(!opsQueue.length) return;

        var batch = opsQueue.slice();
        opsQueue = [];
        saveOpsQueue();

        appendOpsRows(batch).then(function(){
          setLast(nowIso());
        }).catch(function(err){
          console.warn(err);
          // geri koy (kaybolmasƒ±n)
          opsQueue = batch.concat(opsQueue);
          saveOpsQueue();
        });
      }

      function logSale(branchKey, sale){
        // timestamp, branch, type=sale, saleId, total, channel, method, itemsJson
        var row = [
          nowIso(),
          String(branchKey || ''),
          'sale',
          String(sale.id || ''),
          String(Number(sale.total || 0).toFixed(2)),
          String(sale.channel || ''),
          String(sale.method || ''),
          JSON.stringify(sale.items || [])
        ];

        if(!accessToken){ enqueueOpRow(row); pill('sync-warn','üîê Baƒülan'); return; }

        appendOpsRows([row]).then(function(){
          setLast(nowIso());
        }).catch(function(err){
          console.warn(err);
          enqueueOpRow(row);
        });
      }

      function logExpense(branchKey, exp){
        // timestamp, branch, type=expense, expenseId, amount, typeName, desc
        // H s√ºtunu bo≈ü bƒ±rakƒ±yoruz
        var row = [
          nowIso(),
          String(branchKey || ''),
          'expense',
          String(exp.id || ''),
          String(Number(exp.amount || 0).toFixed(2)),
          String(exp.type || ''),
          String(exp.desc || ''),
          ''
        ];

        if(!accessToken){ enqueueOpRow(row); pill('sync-warn','üîê Baƒülan'); return; }

        appendOpsRows([row]).then(function(){
          setLast(nowIso());
        }).catch(function(err){
          console.warn(err);
          enqueueOpRow(row);
        });
      }

      function pushDebounced(){
        if(pushTimer) clearTimeout(pushTimer);
        pushTimer = setTimeout(function(){ push(); }, 600);
      }

      function push(){
        if(!SHEETS_SYNC.enabled) return;
        if(isApplyingRemote) return;

        if(!accessToken){
          pill('sync-warn','üîê Baƒülan');
          return;
        }

        if(pullInFlight) return;
        pullInFlight = true;

        var rev = Date.now(); // basit rev
        var values = [[ String(rev), nowIso(), deviceId, JSON.stringify(state) ]];

        var url = 'https://sheets.googleapis.com/v4/spreadsheets/' + encodeURIComponent(SHEETS_SYNC.spreadsheetId)
          + '/values/' + encodeURIComponent(SHEETS_SYNC.range) + '?valueInputOption=RAW';

        pill('sync-warn','‚¨ÜÔ∏è G√∂nderiliyor‚Ä¶');

        sheetsFetch(url, {
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ range: SHEETS_SYNC.range, majorDimension:'ROWS', values: values })
        }).then(function(){
          pill('sync-ok','‚úÖ Senkron');
          setLast(nowIso());
        }).catch(function(err){
          console.warn(err);
          pill('sync-bad','‚ùå G√∂nderme hata');
        });
      }

      function pull(){
        if(!SHEETS_SYNC.enabled) return;
        if(!accessToken){
          pill('sync-warn','üîê Baƒülan');
          return;
        }

        if(pullInFlight) return;
        pullInFlight = true;

        var url = 'https://sheets.googleapis.com/v4/spreadsheets/' + encodeURIComponent(SHEETS_SYNC.spreadsheetId)
          + '/values/' + encodeURIComponent(SHEETS_SYNC.range) + '?majorDimension=ROWS';

        pill('sync-warn','‚¨áÔ∏è √áekiliyor‚Ä¶');

        sheetsFetch(url).then(function(data){
          var row = (data && data.values && data.values[0]) ? data.values[0] : null;
          if(!row || row.length < 4){
            pill('sync-warn','‚ÑπÔ∏è Bo≈ü');
            return;
          }
          var rev = Number(row[0] || 0);
          var updatedAt = row[1] || '';
          var remoteJson = row[3] || '';

          if(rev <= lastPullRev){
            pill('sync-ok','‚úÖ G√ºncel');
            setLast(updatedAt || nowIso());
            return;
          }

          var remoteState = null;
          try{ remoteState = JSON.parse(remoteJson); }catch(e){ remoteState=null; }
          if(!remoteState){
            pill('sync-bad','‚ùå JSON bozuk');
            return;
          }

          isApplyingRemote = true;
          state = normalizeAndBackfill(remoteState);
          save(true); // local g√ºncelle
          renderAll();
          isApplyingRemote = false;

          lastPullRev = rev;
          localStorage.setItem('SHEETS_LAST_PULL_REV', String(lastPullRev));

          pill('sync-ok','‚úÖ G√ºncellendi');
          setLast(updatedAt || nowIso());
        }).catch(function(err){
          console.warn(err);
          pill('sync-bad','‚ùå √áekme hata');
        }).then(function(){
          pullInFlight = false;
        });
      }

      function startAutoPull(){
        if(pullTimer) clearInterval(pullTimer);
        pullTimer = setInterval(function(){
          if(document.hidden) return;
          if(!accessToken) return;
          pull();
        }, 10000);
      }


  function logProduct(branchKey, product){
      try{
        var row = [
          nowIso(),
          branchKey,
          'product',
          String(product && product.id || ''),
          String(product && product.name || ''),
          String(product && product.cat || ''),
          Number(product && product.price || 0) || 0,
          JSON.stringify((product && product.prices) ? product.prices : {})
        ];
        enqueueOpRow(row);
        flushOpsQueueDebounced();
      }catch(e){}
    }

return {
  init: init,
  isReady: function(){ return !!tokenClient; },
  isConnected: function(){ return !!accessToken; },
  connect: function(){
    requestTokenInteractive();
    startAutoPull();
  },
  pull: pull,
  push: push,
  pushDebounced: pushDebounced,
  logSale: logSale,
  logExpense: logExpense,
    logProduct: logProduct
};

    })();

    // GIS onload callback
    window.__GIS_LOADED__ = function(){
      SheetsSync.init();
    };

    function bindSyncUI(){
      var btnC = document.getElementById('btnGoogleConnect');
      var btnPull = document.getElementById('btnSyncPull');
      var btnPush = document.getElementById('btnSyncPush');

      if(btnC) btnC.onclick = function(){ SheetsSync.connect(); };
      if(btnPull) btnPull.onclick = function(){ SheetsSync.pull(); };
      if(btnPush) btnPush.onclick = function(){ SheetsSync.push(); };
    }

    function init(){
      loadTheme();
      updateDataSourceLabels();
      bindNav();
      bindBranchSelect();
      bindBackupButtons();
      bindSyncUI();

      var tbtn = document.getElementById('themeToggle');
      if(tbtn) tbtn.onclick = toggleTheme;

      // filtre dropdown'larƒ± ilk kez doldur
      renderSelectors();

      // default tarih alanlarƒ±
      resetExpenseForm();

      // ilk render
      renderAll();

      // GIS y√ºklenmi≈üse init
      if(window.google && google.accounts && google.accounts.oauth2){
        SheetsSync.init();
      }
    }

    init();

    // ====== PWA CACHE (offline) ======
    (function(){
      try{
        if("serviceWorker" in navigator){
          navigator.serviceWorker.register("./sw.js").catch(function(){});
        }
      }catch(e){}
    })();

    /*
      Ek notlar:
      - Eƒüer "Hata 403 access_denied" alƒ±rsan: OAuth Consent Screen > Audience > Test users i√ßine email ekle.
      - Authorized JavaScript origins: https://arenakgul.github.io (path yok).
    */
      </script>
    </main>
  </div>
</body>
</html>
