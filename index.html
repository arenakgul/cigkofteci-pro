<!DOCTYPE html>
<html lang="tr" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>√áiƒü K√∂fteci Mahsum Usta | Y√∂netim Paneli</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --font:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      --r:18px;
      --rs:12px;
      --t:.18s ease;

      /* LOGO ANA RENK: #871918 */
      --primary:#871918;
      --primary-2:#a11c1b;
      --primary-3:#661111;

      /* D√ºz (flat) modern zeminler */
      --bg:#0f0b0b;
      --panel:#171011;
      --panel2:#1f1617;
      --input:#241a1b;
      --border:rgba(255,255,255,.10);

      --text:#fbfbfc;
      --muted:rgba(251,251,252,.65);

      --accent:#f5d0cd;   /* yumu≈üak vurgu (fiyat vb.) */
      --success:#22c55e;
      --warning:#f59e0b;
      --danger:#ef4444;

      --shadow:0 14px 40px rgba(0,0,0,.40);
      --shadow2:0 10px 26px rgba(0,0,0,.32);
      --focus:0 0 0 4px rgba(135,25,24,.20);
    }

    html[data-theme="light"]{
      --bg:#fbf7f6;
      --panel:#ffffff;
      --panel2:#fff6f6;
      --input:#f4ecec;
      --border:rgba(20,11,11,.10);

      --text:#140b0b;
      --muted:rgba(20,11,11,.62);

      --shadow:0 12px 35px rgba(15,20,25,.10);
      --shadow2:0 10px 22px rgba(15,20,25,.08);
      --focus:0 0 0 4px rgba(135,25,24,.18);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      background:var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }

    .hidden{display:none !important}
    .row{display:flex; gap:10px; align-items:center}
    .muted{color:var(--muted)}
    .pill{border-radius:999px}

    /* Layout */
    .app{display:flex; min-height:100vh;}
    .main{flex:1; padding:16px; min-width:0;}

    /* Sidebar */
    .sidebar{
      width:285px;
      padding:18px;
      border-right:1px solid var(--border);
      background:var(--panel);
      position:sticky;
      top:0;
      height:100vh;
      display:flex;
      flex-direction:column;
      gap:14px;
      z-index:50;
    }

    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:46px; height:46px;
      border-radius:14px;
      background:rgba(135,25,24,.14);
      border:1px solid rgba(135,25,24,.35);
      display:grid; place-items:center;
      overflow:hidden;
      box-shadow:var(--shadow2);
      flex:0 0 auto;
    }
    .logo img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .brand b{display:block; font-size:15px; letter-spacing:.2px;}
    .brand span{display:block; font-size:12px; color:var(--muted); margin-top:2px;}

    .box{
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:var(--r);
      padding:12px;
    }

    select,input,button,textarea{
      font-family:inherit;
      font-size:14px;
      outline:none;
    }
    select,input,textarea{
      width:100%;
      padding:10px 12px;
      background:var(--input);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:14px;
      transition:var(--t);
    }
    select:focus,input:focus,textarea:focus{box-shadow:var(--focus); border-color:rgba(135,25,24,.45);}

    /* Nav */
    .nav{display:flex; flex-direction:column; gap:10px;}
    .nav-item{
      display:flex;
      gap:12px;
      align-items:center;
      width:100%;
      padding:12px;
      border-radius:var(--r);
      background:transparent;
      border:1px solid transparent;
      color:var(--text);
      cursor:pointer;
      transition:var(--t);
      text-align:left;
    }
    .nav-item:hover{
      background:rgba(255,255,255,.03);
      border-color:var(--border);
      transform:translateY(-1px);
    }
    .nav-item.active{
      background:rgba(135,25,24,.12);
      border-color:rgba(135,25,24,.35);
      box-shadow:var(--shadow2);
    }
    .ico{
      width:40px; height:40px;
      border-radius:14px;
      display:grid; place-items:center;
      background:rgba(255,255,255,.03);
      border:1px solid var(--border);
      flex:0 0 auto;
      font-size:18px;
    }
    .nav-item.active .ico{
      background:rgba(135,25,24,.12);
      border-color:rgba(135,25,24,.35);
    }

    .sidebar-footer{margin-top:auto; display:flex; flex-direction:column; gap:10px;}
    #saveStatus{font-size:12px; min-height:16px;}

    /* Buttons */
    .btn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition:var(--t);
      user-select:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.05);}
    .btn:active{transform:translateY(0);}

    .btn-primary{
      background:var(--primary);
      border-color:rgba(0,0,0,0);
      color:#fff;
      font-weight:800;
    }
    .btn-primary:hover{background:var(--primary-2);}

    .btn-danger{background:rgba(239,68,68,.12); border-color:rgba(239,68,68,.35); color:#ffd6d6; font-weight:800;}
    .btn-warning{background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.35); color:#ffe7be; font-weight:800;}
    .btn-success{background:rgba(34,197,94,.12); border-color:rgba(34,197,94,.35); color:#c8ffd9; font-weight:800;}

    .btn-sm{padding:8px 10px; border-radius:12px; font-size:13px;}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none;}

    /* Topbar */
    .topbar{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--r);
      padding:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      box-shadow:var(--shadow2);
      margin-bottom:14px;
    }
    .topbar h1{
      font-size:16px;
      margin:0;
      letter-spacing:.2px;
    }
    .topbar h1 span{font-size:12px; color:var(--muted); font-weight:600; margin-left:8px;}

    /* Panels */
    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--r);
      padding:14px;
      box-shadow:var(--shadow2);
      min-width:0;
    }
    .panel h2{
      margin:0 0 10px 0;
      font-size:14px;
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
    }

    /* === Kategori/Kanal Barƒ±: kayma fix === */
    .category-scroll{
      display:flex;
      align-items:center;
      gap:8px;

      flex-wrap:nowrap;
      overflow-x:auto;
      overflow-y:hidden;
      white-space:nowrap;

      -webkit-overflow-scrolling:touch;
      scrollbar-gutter:stable;
      padding:2px 2px 8px 2px;
    }
    .category-scroll::-webkit-scrollbar{height:8px}
    .category-scroll::-webkit-scrollbar-thumb{
      background:rgba(255,255,255,.18);
      border-radius:999px;
    }
    .category-scroll::-webkit-scrollbar-track{background:transparent}

    /* Chips */
    .chip, .channel-btn{
      flex:0 0 auto;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;

      height:40px;            /* sabit y√ºkseklik */
      padding:0 14px;

      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
      transition:var(--t);
      user-select:none;
      font-size:13px;
      white-space:nowrap;

      line-height:1;          /* emoji baseline zƒ±plamasƒ±nƒ± keser */
      vertical-align:middle;
    }
    .chip:hover,.channel-btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.05);}
    .chip.active,.channel-btn.active{
      background:rgba(135,25,24,.12);
      border-color:rgba(135,25,24,.35);
      box-shadow:var(--shadow2);
    }

    /* POS layout */
    .content-grid{
      display:grid;
      grid-template-columns:1.7fr 1fr;
      gap:14px;
      align-items:start;
    }
    .pos-tools{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:flex-start;
    }

    /* POS grid: 4 columns */
    .product-grid{
      display:grid;
      grid-template-columns:repeat(4, minmax(0,1fr));
      gap:12px;
      margin-top:10px;
    }
    .product{
      border:1px solid var(--border);
      background:var(--panel2);
      border-radius:var(--r);
      padding:14px;
      cursor:pointer;
      transition:var(--t);
      display:flex;
      gap:12px;
      align-items:center;
      min-height:82px;
    }
    .product:hover{
      transform:translateY(-2px);
      border-color:rgba(135,25,24,.30);
      box-shadow:var(--shadow2);
    }
    .pico{
      width:46px; height:46px;
      border-radius:16px;
      display:grid; place-items:center;
      background:rgba(135,25,24,.12);
      border:1px solid rgba(135,25,24,.20);
      font-size:22px;
      flex:0 0 auto;
    }
    .price{font-weight:900; color:var(--accent); margin-top:4px;}
    .stock{font-size:12px; color:var(--muted); margin-top:6px;}

    /* Cart */
    .cart-box{position:sticky; top:16px;}
    .cart-empty{
      padding:12px;
      border-radius:var(--r);
      border:1px dashed var(--border);
      color:var(--muted);
      text-align:center;
    }
    .cart-item{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:12px 0;
      border-bottom:1px solid var(--border);
    }
    .cart-summary{
      display:flex; justify-content:space-between; align-items:center;
      padding-top:12px; margin-top:12px;
      border-top:1px solid var(--border);
    }
    .cart-total{font-size:18px; font-weight:900;}
    .pay-row{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}

    /* Cards */
    .cards{display:grid; grid-template-columns:repeat(4, minmax(0,1fr)); gap:12px;}
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--r);
      padding:14px;
      box-shadow:var(--shadow2);
    }
    .card .label{font-size:12px; color:var(--muted)}
    .card .value{font-size:20px; font-weight:950; margin-top:6px;}

    /* Tables */
    table{
      width:100%;
      border-collapse:collapse;
      border-radius:16px;
      overflow:hidden;
      border:1px solid var(--border);
      background:rgba(255,255,255,.02);
    }
    th,td{padding:12px 10px; border-bottom:1px solid var(--border); font-size:12px; text-align:left; vertical-align:top;}
    th{color:var(--muted); font-weight:900; text-transform:uppercase; font-size:11px; letter-spacing:.3px; background:rgba(255,255,255,.03)}
    tr:last-child td{border-bottom:none}

    /* Pages */
    .page-view{display:none;}
    .page-view.active{display:block;}

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:999;
    }
    .modal{
      width:min(720px, 100%);
      border-radius:22px;
      border:1px solid var(--border);
      background:var(--panel);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modal-head{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modal-head b{font-size:14px}
    .modal-body{padding:14px 16px;}
    .modal-foot{
      padding:14px 16px;
      border-top:1px solid var(--border);
      display:flex;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }

    /* Responsive */
    @media (max-width: 1180px){
      .product-grid{grid-template-columns:repeat(3, minmax(0,1fr));}
      .content-grid{grid-template-columns:1.4fr 1fr;}
    }
    @media (max-width: 980px){
      .cards{grid-template-columns:repeat(2, minmax(0,1fr));}
      .content-grid{grid-template-columns:1fr;}
      .cart-box{position:relative; top:auto;}
    }
    @media (max-width: 840px){
      .sidebar{
        position:fixed;
        left:-320px;
        top:0;
        height:100vh;
        z-index:999;
        transition:var(--t);
        box-shadow:var(--shadow);
      }
      .sidebar.open{left:0;}
      .main{padding:12px;}
    }
    @media (max-width: 560px){
      .product-grid{grid-template-columns:repeat(2, minmax(0,1fr));}
    }
    @media (max-width: 420px){
      .product-grid{grid-template-columns:1fr;}
    }
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div class="logo" title="Logo">
          <img src="logo.png" alt="√áiƒü K√∂fteci Mahsum Usta">
        </div>
        <div>
          <b>√áiƒü K√∂fteci Mahsum Usta</b>
          <span>Y√∂netim Paneli</span>
        </div>
      </div>

      <div class="box">
        <div class="muted" style="font-size:12px; margin-bottom:8px;">≈ûube Se√ß</div>
        <select id="branchSelect">
          <option value="hastane">Hastane ≈ûubesi</option>
          <option value="cihanpol">Cihanpol ≈ûubesi</option>
        </select>
      </div>

      <div class="nav">
        <button class="nav-item active" data-view="pos" type="button">
          <div class="ico">üßæ</div>
          <div><b>Satƒ±≈ü</b><br><span class="muted" style="font-size:12px;">POS ekranƒ±</span></div>
        </button>
        <button class="nav-item" data-view="dashboard" type="button">
          <div class="ico">üìà</div>
          <div><b>Rapor</b><br><span class="muted" style="font-size:12px;">Ciro & gider</span></div>
        </button>
        <button class="nav-item" data-view="inventory" type="button">
          <div class="ico">üì¶</div>
          <div><b>√úr√ºnler</b><br><span class="muted" style="font-size:12px;">Stok y√∂netimi</span></div>
        </button>
        <button class="nav-item" data-view="expenses" type="button">
          <div class="ico">üí∏</div>
          <div><b>Gider</b><br><span class="muted" style="font-size:12px;">Kayƒ±t & filtre</span></div>
        </button>
      </div>

      <div class="sidebar-footer">
        <div class="row" style="flex-wrap:wrap;">
          <button class="btn btn-primary" id="manualSaveBtn" type="button">üíæ Yedek Al</button>
          <button class="btn" id="loadBackupBtn" type="button">üì• Yedeƒüi Y√ºkle</button>
          <button class="btn" id="themeToggle" type="button" title="Tema">üåô</button>
        </div>
        <input id="backupFileInput" type="file" accept="application/json" class="hidden">
        <div id="saveStatus"></div>
        <div class="muted" style="font-size:11px;">
          Se√ßili ≈ûube: <b id="currentBranchName">| Hastane ≈ûubesi</b>
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <h1>√áiƒü K√∂fteci Mahsum Usta <span id="topHint">| Hƒ±zlƒ± Y√∂netim</span></h1>
        <div class="row">
          <button class="btn" type="button" onclick="toggleSidebar()">‚ò∞ Men√º</button>
        </div>
      </div>

      <!-- POS -->
      <section class="page-view active" id="view-pos">
        <div class="content-grid">
          <div class="panel">
            <h2>
              <span>Satƒ±≈ü Ekranƒ±</span>
              <span class="muted" style="font-size:12px;">√úr√ºn se√ß ‚Üí sepete ekle</span>
            </h2>

            <div class="pos-tools">
              <div style="flex:1; min-width:220px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Kategori</div>
                <div class="category-scroll" id="catBar"></div>
              </div>
              <div style="flex:1; min-width:220px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Satƒ±≈ü Kanalƒ±</div>
                <div class="category-scroll" id="channelButtons"></div>
              </div>
            </div>

            <div class="product-grid" id="posGrid"></div>
          </div>

          <div class="panel cart-box">
            <h2>
              <span>Sepet</span>
              <span class="muted" style="font-size:12px;">√ñdeme al</span>
            </h2>

            <div class="cart-empty" id="cartEmpty">Sepet Bo≈ü</div>
            <div id="cartContainer"></div>

            <div class="cart-summary">
              <div class="muted">Toplam</div>
              <div class="cart-total" id="cartTotal">0.00 ‚Ç∫</div>
            </div>

            <div class="pay-row">
              <button class="btn btn-sm" type="button" onclick="setPayMethod('nakit')" id="pm-nakit">üíµ Nakit</button>
              <button class="btn btn-sm" type="button" onclick="setPayMethod('kart')" id="pm-kart">üí≥ Kart</button>
              <button class="btn btn-sm" type="button" onclick="setPayMethod('iban')" id="pm-iban">üè¶ IBAN</button>
              <button class="btn btn-primary" type="button" style="flex:1" onclick="checkout()">‚úÖ Satƒ±≈üƒ± Kaydet</button>
            </div>
            <div class="muted" style="font-size:12px; margin-top:10px;">
              Se√ßili y√∂ntem: <b id="payMethodLabel">Nakit</b>
            </div>
          </div>
        </div>
      </section>

      <!-- DASHBOARD -->
      <section class="page-view" id="view-dashboard">
        <div class="panel" style="margin-bottom:14px;">
          <h2>
            <span>Rapor</span>
            <span class="muted" style="font-size:12px;">≈ûube bazlƒ± √∂zet</span>
          </h2>

          <div class="cards">
            <div class="card">
              <div class="label">Toplam Ciro</div>
              <div class="value" id="repTurnover">0.00 ‚Ç∫</div>
            </div>
            <div class="card">
              <div class="label">Toplam Gider</div>
              <div class="value" id="repExpense">0.00 ‚Ç∫</div>
            </div>
            <div class="card">
              <div class="label">Satƒ±≈ü Adedi</div>
              <div class="value" id="repCount">0</div>
            </div>
            <div class="card">
              <div class="label">Net</div>
              <div class="value" id="repNet">0.00 ‚Ç∫</div>
            </div>
          </div>
        </div>

        <div class="panel">
          <h2>
            <span>Satƒ±≈ülar</span>
            <span class="muted" style="font-size:12px;">D√ºzenle / sil</span>
          </h2>

          <div class="row" style="flex-wrap:wrap; margin-bottom:12px;">
            <div style="min-width:200px; flex:1;">
              <div class="muted" style="font-size:12px; margin-bottom:6px;">√ñdeme</div>
              <select id="salesMethodFilter" onchange="filterSales()">
                <option value="">T√ºm√º</option>
                <option value="nakit">Nakit</option>
                <option value="kart">Kart</option>
                <option value="iban">IBAN</option>
              </select>
            </div>
            <div style="min-width:200px; flex:1;">
              <div class="muted" style="font-size:12px; margin-bottom:6px;">Kanal</div>
              <select id="salesChannelFilter" onchange="filterSales()"></select>
            </div>
            <div style="min-width:200px; flex:1;">
              <div class="muted" style="font-size:12px; margin-bottom:6px;">Ara</div>
              <input id="salesSearch" placeholder="√úr√ºn/kanal/ID ara..." oninput="filterSales()">
            </div>
          </div>

          <div style="overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th>Tarih</th>
                  <th>Kanal</th>
                  <th>√ñdeme</th>
                  <th>Toplam</th>
                  <th>Detay</th>
                </tr>
              </thead>
              <tbody id="salesTableBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- INVENTORY -->
      <section class="page-view" id="view-inventory">
        <div class="content-grid">
          <div class="panel">
            <h2>
              <span id="formTitle">Yeni √úr√ºn Ekle</span>
              <span class="muted" style="font-size:12px;">≈ûube bazlƒ± stok</span>
            </h2>

            <input id="editProductId" class="hidden" />

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
              <div style="grid-column:1/-1;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">√úr√ºn Adƒ±</div>
                <input id="prodName" placeholder="√ñrn: D√ºr√ºm (Normal)">
              </div>
              <div style="grid-column:1/-1;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">A√ßƒ±klama (opsiyonel)</div>
                <input id="prodDesc" placeholder="√ñrn: Acƒ± / ekstra nar ek≈üisi">
              </div>
              <div>
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Fiyat (‚Ç∫)</div>
                <input id="prodPrice" type="number" step="0.01" placeholder="0.00">
              </div>
              <div>
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Stok</div>
                <input id="prodStock" type="number" step="1" value="100">
              </div>
              <div style="grid-column:1/-1;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Kategori</div>
                <select id="prodCat"></select>
              </div>
              <div style="grid-column:1/-1;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">ƒ∞kon (opsiyonel)</div>
                <input id="prodIcon" placeholder="√ñrn: üåØ">
              </div>
            </div>

            <div class="row" style="margin-top:12px; flex-wrap:wrap;">
              <button class="btn btn-primary" id="btnSaveProd" type="button" onclick="saveProduct()">Kaydet</button>
              <button class="btn" id="btnCancelEdit" type="button" onclick="cancelProductEdit()" style="display:none;">ƒ∞ptal</button>
            </div>
          </div>

          <div class="panel">
            <h2>
              <span>√úr√ºnler</span>
              <span class="muted" style="font-size:12px;">Filtrele / d√ºzenle</span>
            </h2>

            <div class="row" style="flex-wrap:wrap; margin-bottom:12px;">
              <div style="min-width:220px; flex:1;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Kategori</div>
                <select id="invCatFilter" onchange="filterProducts()">
                  <option value="">T√ºm√º</option>
                </select>
              </div>
              <div style="min-width:220px; flex:1;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Ara</div>
                <input id="invSearch" placeholder="√úr√ºn adƒ± ara..." oninput="filterProducts()">
              </div>
            </div>

            <div style="overflow:auto;">
              <table id="inventoryTable">
                <thead>
                  <tr>
                    <th>√úr√ºn</th>
                    <th>Kategori</th>
                    <th>Fiyat</th>
                    <th>Stok</th>
                    <th>ƒ∞≈ülem</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- EXPENSES -->
      <section class="page-view" id="view-expenses">
        <div class="content-grid">
          <div class="panel">
            <h2>
              <span>Gider Ekle</span>
              <span class="muted" style="font-size:12px;">Kayƒ±t tut</span>
            </h2>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
              <div style="grid-column:1/-1;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Gider Tipi</div>
                <select id="expenseType"></select>
              </div>
              <div>
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Tutar (‚Ç∫)</div>
                <input id="expenseAmount" type="number" step="0.01" placeholder="0.00">
              </div>
              <div>
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Tarih</div>
                <input id="expenseDate" type="date">
              </div>
              <div style="grid-column:1/-1;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">A√ßƒ±klama (opsiyonel)</div>
                <input id="expenseDesc" placeholder="√ñrn: Kasa po≈üeti / deterjan">
              </div>
            </div>

            <div class="row" style="margin-top:12px; flex-wrap:wrap;">
              <button class="btn btn-primary" type="button" onclick="addExpense()">‚ûï Ekle</button>
            </div>

            <div class="box" style="margin-top:12px;">
              <div class="muted" style="font-size:12px; margin-bottom:8px;">Gider Tipleri</div>
              <div class="category-scroll" id="expTypeList" style="padding-bottom:2px;"></div>
            </div>
          </div>

          <div class="panel">
            <h2>
              <span>Giderler</span>
              <span class="muted" style="font-size:12px;">Filtrele / sil</span>
            </h2>

            <div class="row" style="flex-wrap:wrap; margin-bottom:12px;">
              <div style="min-width:220px; flex:1;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Tip</div>
                <select id="expTypeFilter" onchange="filterExpenses()">
                  <option value="">T√ºm√º</option>
                </select>
              </div>
              <div style="min-width:220px; flex:1;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Ara</div>
                <input id="expSearch" placeholder="A√ßƒ±klama ara..." oninput="filterExpenses()">
              </div>
            </div>

            <div style="overflow:auto;">
              <table>
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>Tip</th>
                    <th>A√ßƒ±klama</th>
                    <th>Tutar</th>
                    <th>ƒ∞≈ülem</th>
                  </tr>
                </thead>
                <tbody id="expensesTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- EDIT SALE MODAL -->
      <div class="modal-backdrop hidden" id="editSaleModal">
        <div class="modal">
          <div class="modal-head">
            <b>Satƒ±≈üƒ± D√ºzenle</b>
            <button class="btn btn-sm" type="button" onclick="closeEditModal()">‚úñ</button>
          </div>
          <div class="modal-body" id="editSaleContent"></div>
          <div class="modal-foot">
            <button class="btn btn-danger" type="button" onclick="deleteSale()">Satƒ±≈üƒ± Sil</button>
            <button class="btn btn-primary" type="button" onclick="updateSale()">Kaydet</button>
          </div>
        </div>
      </div>

    </main>
  </div>

  <script>
    /* ========= STORAGE ========= */
    var STORAGE_KEY = 'MAHSUM_USTA_APP_V5';
    var THEME_KEY = 'MAHSUM_USTA_THEME';

    /* ========= DEFAULTS ========= */
    var DEFAULTS = {
      categories: ['D√ºr√ºmler','Porsiyonlar','ƒ∞√ßecekler','Ek Paketler'],
      expenseTypes: ['Kira','Elektrik Faturasƒ±','Su Faturasƒ±','Manav','Mutfak Malzemesi','Temizlik Malzemesi','Personel','Diƒüer'],
      salesChannels: ['D√ºkkan ƒ∞√ßi','Telefon','Yemeksepeti','Getir','Trendyol Yemek'],
      branches: {
        hastane: {
          name: 'Hastane ≈ûubesi',
          products: [
            {id:101, name:'D√ºr√ºm (Normal)', description:'Standart d√ºr√ºm', price:90, stock:120, cat:'D√ºr√ºmler', icon:'üåØ'},
            {id:102, name:'D√ºr√ºm (Mega)', description:'B√ºy√ºk boy', price:120, stock:90, cat:'D√ºr√ºmler', icon:'üåØ'},
            {id:201, name:'Porsiyon', description:'Tabakta servis', price:130, stock:80, cat:'Porsiyonlar', icon:'ü•ô'},
            {id:301, name:'Ayran', description:'200 ml', price:20, stock:200, cat:'ƒ∞√ßecekler', icon:'ü•õ'},
            {id:302, name:'Kola', description:'330 ml', price:35, stock:150, cat:'ƒ∞√ßecekler', icon:'ü•§'},
            {id:401, name:'Ek Nar Ek≈üisi', description:'', price:10, stock:300, cat:'Ek Paketler', icon:'üßÄ'}
          ],
          sales: [],
          expenses: []
        },
        cihanpol: {
          name: 'Cihanpol ≈ûubesi',
          products: [
            {id:111, name:'D√ºr√ºm (Normal)', description:'Standart d√ºr√ºm', price:90, stock:100, cat:'D√ºr√ºmler', icon:'üåØ'},
            {id:112, name:'D√ºr√ºm (Mega)', description:'B√ºy√ºk boy', price:120, stock:70, cat:'D√ºr√ºmler', icon:'üåØ'},
            {id:211, name:'Porsiyon', description:'Tabakta servis', price:130, stock:60, cat:'Porsiyonlar', icon:'ü•ô'},
            {id:311, name:'Ayran', description:'200 ml', price:20, stock:180, cat:'ƒ∞√ßecekler', icon:'ü•õ'},
            {id:312, name:'Kola', description:'330 ml', price:35, stock:120, cat:'ƒ∞√ßecekler', icon:'ü•§'},
            {id:411, name:'Ek Nar Ek≈üisi', description:'', price:10, stock:250, cat:'Ek Paketler', icon:'üßÄ'}
          ],
          sales: [],
          expenses: []
        }
      }
    };

    /* ========= STATE ========= */
    var state = loadStateOrDefault();
    var cart = [];
    var activeCat = 'Hepsi';
    var activeChannel = 'D√ºkkan ƒ∞√ßi';
    var activePayMethod = 'nakit';

    var editingSaleId = null;
    var saleDraft = null;
    var saleOriginalSnapshot = null;

    /* ========= INIT ========= */
    (function init(){
      bindNav();
      bindBranchSelect();
      bindBackup();
      bindTheme();
      bindPOSDelegates(); // kategori/kanal click handler (kayma + g√ºvenli)

      // Expense date default today
      var ed = document.getElementById('expenseDate');
      if(ed) ed.value = toDateInputValue(new Date());

      renderSelectors();
      renderAll();
      refreshBranchLabel();
      setPayMethod('nakit');
    })();

    /* ========= UI BINDINGS ========= */
    function toggleSidebar(){
      var sb = document.getElementById('sidebar');
      if(!sb) return;
      if(sb.classList.contains('open')) sb.classList.remove('open');
      else sb.classList.add('open');
    }

    function bindNav(){
      var items = document.querySelectorAll('.nav-item');
      for(var i=0;i<items.length;i++){
        items[i].addEventListener('click', function(){
          var view = this.getAttribute('data-view');
          switchView(view);
          if(window.innerWidth <= 840){
            var sb = document.getElementById('sidebar');
            if(sb) sb.classList.remove('open');
          }
        });
      }
    }

    function switchView(view){
      var items = document.querySelectorAll('.nav-item');
      for(var i=0;i<items.length;i++){
        items[i].classList.toggle('active', items[i].getAttribute('data-view')===view);
      }

      var views = document.querySelectorAll('.page-view');
      for(i=0;i<views.length;i++){
        views[i].classList.toggle('active', views[i].id === ('view-' + view));
      }

      var hint = document.getElementById('topHint');
      if(hint){
        var map = {pos:'| Satƒ±≈ü', dashboard:'| Rapor', inventory:'| √úr√ºnler', expenses:'| Gider'};
        hint.textContent = map[view] || '| Hƒ±zlƒ± Y√∂netim';
      }

      if(view === 'dashboard') renderDashboard();
      if(view === 'inventory') renderInventory();
      if(view === 'expenses') renderExpenses();
      if(view === 'pos'){ renderPOS(); renderCart(); }
    }

    function bindBranchSelect(){
      var sel = document.getElementById('branchSelect');
      if(!sel) return;
      sel.addEventListener('change', function(){
        refreshBranchLabel();
        cart = [];
        activeCat = 'Hepsi';
        activeChannel = 'D√ºkkan ƒ∞√ßi';
        setPayMethod('nakit');
        renderAll();
        save();
      });
    }

    function refreshBranchLabel(){
      var b = getBranch();
      var el = document.getElementById('currentBranchName');
      if(el && b) el.textContent = '| ' + b.name;
    }

    function bindBackup(){
      var saveBtn = document.getElementById('manualSaveBtn');
      var loadBtn = document.getElementById('loadBackupBtn');
      var fileInput = document.getElementById('backupFileInput');

      if(saveBtn){
        saveBtn.addEventListener('click', function(){
          downloadBackup();
        });
      }

      if(loadBtn && fileInput){
        loadBtn.addEventListener('click', function(){
          fileInput.value = '';
          fileInput.click();
        });

        fileInput.addEventListener('change', function(e){
          var f = (e && e.target && e.target.files) ? e.target.files[0] : null;
          if(!f) return;

          var reader = new FileReader();
          reader.onload = function(){
            try{
              var obj = JSON.parse(String(reader.result||''));
              if(!obj || !obj.branches){
                alert('Ge√ßersiz yedek dosyasƒ±!');
                return;
              }
              if(!confirm('Yedeƒüi y√ºklemek mevcut verileri deƒüi≈ütirecek. Devam edilsin mi?')) return;

              state = obj;
              normalizeAndBackfill(state);

              cart = [];
              activeCat = 'Hepsi';
              activeChannel = 'D√ºkkan ƒ∞√ßi';
              setPayMethod('nakit');

              save(true);
              renderSelectors();
              renderAll();
              refreshBranchLabel();
              showSaveStatus('Yedek y√ºklendi', 'success');
            }catch(err){
              alert('Yedek okunamadƒ±: ' + err);
            }
          };
          reader.readAsText(f);
        });
      }
    }

    function bindTheme(){
      var btn = document.getElementById('themeToggle');
      if(btn){
        btn.addEventListener('click', function(){
          var html = document.documentElement;
          var cur = html.getAttribute('data-theme') || 'dark';
          var next = (cur === 'dark') ? 'light' : 'dark';
          html.setAttribute('data-theme', next);
          try{ localStorage.setItem(THEME_KEY, next); }catch(e){}
          btn.textContent = (next === 'dark') ? 'üåô' : '‚òÄÔ∏è';
        });
      }

      try{
        var t = localStorage.getItem(THEME_KEY);
        if(t === 'light' || t === 'dark'){
          document.documentElement.setAttribute('data-theme', t);
          if(btn) btn.textContent = (t === 'dark') ? 'üåô' : '‚òÄÔ∏è';
        }
      }catch(e){}
    }

    function bindPOSDelegates(){
      var catBar = document.getElementById('catBar');
      var channelButtons = document.getElementById('channelButtons');

      if(catBar){
        catBar.addEventListener('click', function(ev){
          var el = ev.target;
          while(el && el !== catBar && !el.classList.contains('chip')) el = el.parentNode;
          if(!el || el === catBar) return;
          var c = el.getAttribute('data-cat') || 'Hepsi';
          filterCat(c);
        });
      }

      if(channelButtons){
        channelButtons.addEventListener('click', function(ev){
          var el = ev.target;
          while(el && el !== channelButtons && !el.classList.contains('channel-btn')) el = el.parentNode;
          if(!el || el === channelButtons) return;
          var ch = el.getAttribute('data-channel') || 'D√ºkkan ƒ∞√ßi';
          setActiveChannel(ch);
        });
      }
    }

    /* ========= HELPERS ========= */
    function showSaveStatus(message, type){
      if(typeof type === 'undefined') type = 'success';
      var el = document.getElementById('saveStatus');
      if(!el) return;
      el.textContent = message;
      el.style.color = (type === 'error') ? 'var(--danger)' : 'var(--success)';
      setTimeout(function(){ el.textContent=''; }, 2200);
    }

    function save(silent){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        if(!silent) showSaveStatus('Kaydedildi', 'success');
        return true;
      }catch(e){
        if(!silent) showSaveStatus('Kaydetme hatasƒ±!', 'error');
        return false;
      }
    }

    function deepClone(x){
      return JSON.parse(JSON.stringify(x));
    }

    function newId(){
      return (new Date().getTime()) + Math.floor(Math.random()*100000);
    }

    function getBranchKey(){
      var sel = document.getElementById('branchSelect');
      return sel ? sel.value : 'hastane';
    }

    function getBranch(){
      var k = getBranchKey();
      return state.branches[k];
    }

    function esc(s){
      s = String(s);
      return s.replace(/&/g,'&amp;')
              .replace(/</g,'&lt;')
              .replace(/>/g,'&gt;')
              .replace(/"/g,'&quot;')
              .replace(/'/g,'&#039;');
    }

    function toDateInputValue(d){
      var yyyy = d.getFullYear();
      var mm = String(d.getMonth()+1); if(mm.length<2) mm='0'+mm;
      var dd = String(d.getDate()); if(dd.length<2) dd='0'+dd;
      return yyyy + '-' + mm + '-' + dd;
    }

    function fmtDateTime(iso){
      try{
        var d = new Date(iso);
        return d.toLocaleString('tr-TR');
      }catch(e){
        return String(iso||'');
      }
    }

    function getCategoryIcon(category){
      var icons = {'D√ºr√ºmler':'üåØ','Porsiyonlar':'ü•ô','ƒ∞√ßecekler':'ü•§','Ek Paketler':'üßÄ'};
      return icons[category] || 'üì¶';
    }

    function getExpenseIcon(type){
      var icons = {
        'Kira':'üè†','Elektrik Faturasƒ±':'üí°','Su Faturasƒ±':'üíß','Manav':'ü•¶',
        'Mutfak Malzemesi':'üî™','Temizlik Malzemesi':'üßπ','Personel':'üë•','Diƒüer':'üì¶'
      };
      return icons[type] || 'üí∞';
    }

    function getChannelIcon(channel){
      var icons = {'D√ºkkan ƒ∞√ßi':'üè™','Telefon':'üìû','Yemeksepeti':'üõµ','Getir':'‚ö°','Trendyol Yemek':'üì±'};
      return icons[channel] || 'üè™';
    }

    function findProduct(products, id){
      for(var i=0;i<products.length;i++){
        if(Number(products[i].id) === Number(id)) return products[i];
      }
      return null;
    }

    function findSale(sales, id){
      for(var i=0;i<sales.length;i++){
        if(Number(sales[i].id)===Number(id)) return sales[i];
      }
      return null;
    }

    function calcItemsTotal(items){
      var t = 0;
      items = items || [];
      for(var i=0;i<items.length;i++){
        t += (Number(items[i].price)||0) * (Number(items[i].qty)||0);
      }
      return t;
    }

    /* ========= DATA NORMALIZE + OLD PRODUCTS BACKFILL ========= */
    function isValidState(obj){
      return obj && obj.branches && obj.branches.hastane && obj.branches.cihanpol
        && obj.branches.hastane.products && obj.branches.cihanpol.products;
    }

    function sanitizeBranch(b){
      if(!b) return;
      b.products = b.products || [];
      b.sales = b.sales || [];
      b.expenses = b.expenses || [];
      for(var i=0;i<b.products.length;i++){
        var p = b.products[i];
        if(!p) continue;
        p.id = Number(p.id) || (Date.now() + Math.floor(Math.random()*100000));
        p.price = Number(p.price) || 0;
        p.stock = Number(p.stock) || 0;
        p.cat = p.cat || 'D√ºr√ºmler';
        p.name = p.name || '√úr√ºn';
        if(typeof p.description === 'undefined') p.description = '';
        if(typeof p.icon === 'undefined') p.icon = '';
      }
    }

    function mergeProductsById(targetProducts, defaultProducts){
      // target i√ßinde default yoksa ekle
      var map = {};
      for(var i=0;i<targetProducts.length;i++){
        map[String(targetProducts[i].id)] = true;
      }
      for(i=0;i<defaultProducts.length;i++){
        var dp = defaultProducts[i];
        if(!dp) continue;
        if(!map[String(dp.id)]){
          targetProducts.push(deepClone(dp));
        }
      }
    }

    function normalizeAndBackfill(obj){
      // listeler yoksa default
      if(!obj.categories) obj.categories = deepClone(DEFAULTS.categories);
      if(!obj.expenseTypes) obj.expenseTypes = deepClone(DEFAULTS.expenseTypes);
      if(!obj.salesChannels) obj.salesChannels = deepClone(DEFAULTS.salesChannels);

      // branch yoksa default
      if(!obj.branches) obj.branches = deepClone(DEFAULTS.branches);
      if(!obj.branches.hastane) obj.branches.hastane = deepClone(DEFAULTS.branches.hastane);
      if(!obj.branches.cihanpol) obj.branches.cihanpol = deepClone(DEFAULTS.branches.cihanpol);

      // sanitize
      sanitizeBranch(obj.branches.hastane);
      sanitizeBranch(obj.branches.cihanpol);

      // DEFAULTS √ºr√ºnleri geri ekle (id bazlƒ±)
      mergeProductsById(obj.branches.hastane.products, DEFAULTS.branches.hastane.products);
      mergeProductsById(obj.branches.cihanpol.products, DEFAULTS.branches.cihanpol.products);

      return obj;
    }

    function findBestOldStateInLocalStorage(){
      // Ama√ß: eski key'i bilmeden, localStorage i√ßinden branches/products yapƒ±sƒ±nƒ± ta≈üƒ±yan en iyi state'i bulmak
      var best = null;
      var bestScore = -1;

      try{
        for(var i=0;i<localStorage.length;i++){
          var k = localStorage.key(i);
          if(!k || k === STORAGE_KEY) continue;

          var raw = localStorage.getItem(k);
          if(!raw || raw.length < 20) continue;
          if(raw.charAt(0) !== '{' && raw.charAt(0) !== '[') continue;

          try{
            var obj = JSON.parse(raw);
            if(!obj || !obj.branches) continue;

            // farklƒ± yapƒ±larƒ± da yakalamak i√ßin esnek kontrol
            var h = obj.branches.hastane;
            var c = obj.branches.cihanpol;
            if(!h || !c) continue;
            if(!Array.isArray(h.products) || !Array.isArray(c.products)) continue;

            var score = (h.products.length || 0) + (c.products.length || 0)
                      + (Array.isArray(h.sales)?h.sales.length:0) + (Array.isArray(c.sales)?c.sales.length:0);

            if(score > bestScore){
              bestScore = score;
              best = obj;
            }
          }catch(e2){
            // ignore
          }
        }
      }catch(e){}

      return best;
    }

    function loadStateOrDefault(){
      try{
        // 1) Yeni key varsa oku
        var raw = localStorage.getItem(STORAGE_KEY);
        if(raw){
          var obj = JSON.parse(raw);
          if(obj && obj.branches){
            return normalizeAndBackfill(obj);
          }
        }

        // 2) Yeni key yoksa: eski state'i otomatik bul
        var old = findBestOldStateInLocalStorage();
        if(old && old.branches){
          old = normalizeAndBackfill(old);
          // yeni key'e ta≈üƒ±
          try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(old)); }catch(e){}
          // kullanƒ±cƒ±ya k√º√ß√ºk bilgi
          setTimeout(function(){
            showSaveStatus('Eski veriler geri y√ºklendi', 'success');
          }, 200);
          return old;
        }

        // 3) hi√ß yoksa defaults
        return deepClone(DEFAULTS);
      }catch(e){
        return deepClone(DEFAULTS);
      }
    }

    /* ========= SELECTOR RENDER ========= */
    function renderSelectors(){
      var catSelect = document.getElementById('prodCat');
      var filterSelect = document.getElementById('invCatFilter');
      var expSelect = document.getElementById('expenseType');
      var expFilter = document.getElementById('expTypeFilter');
      var salesChannelSel = document.getElementById('salesChannelFilter');

      var html = '';
      if(catSelect){
        html = '';
        for(var i=0;i<state.categories.length;i++){
          html += '<option value="'+esc(state.categories[i])+'">'+esc(state.categories[i])+'</option>';
        }
        catSelect.innerHTML = html;
      }
      if(filterSelect){
        html = '<option value="">T√ºm√º</option>';
        for(i=0;i<state.categories.length;i++){
          html += '<option value="'+esc(state.categories[i])+'">'+esc(state.categories[i])+'</option>';
        }
        filterSelect.innerHTML = html;
      }
      if(expSelect){
        html = '';
        for(i=0;i<state.expenseTypes.length;i++){
          html += '<option value="'+esc(state.expenseTypes[i])+'">'+getExpenseIcon(state.expenseTypes[i])+' '+esc(state.expenseTypes[i])+'</option>';
        }
        expSelect.innerHTML = html;
      }
      if(expFilter){
        html = '<option value="">T√ºm√º</option>';
        for(i=0;i<state.expenseTypes.length;i++){
          html += '<option value="'+esc(state.expenseTypes[i])+'">'+esc(state.expenseTypes[i])+'</option>';
        }
        expFilter.innerHTML = html;
      }
      if(salesChannelSel){
        html = '<option value="">T√ºm√º</option>';
        for(i=0;i<state.salesChannels.length;i++){
          html += '<option value="'+esc(state.salesChannels[i])+'">'+esc(state.salesChannels[i])+'</option>';
        }
        salesChannelSel.innerHTML = html;
      }
    }

    /* ========= RENDER ALL ========= */
    function renderAll(){
      renderPOS();
      renderCart();
      renderInventory();
      renderExpenses();
      renderDashboard();
    }

    /* ========= POS ========= */
    function filterCat(c){ activeCat = c; renderPOS(); }
    function setActiveChannel(ch){ activeChannel = ch; renderPOS(); }

    function setPayMethod(m){
      activePayMethod = m;
      var map = {nakit:'Nakit', kart:'Kart', iban:'IBAN'};
      var lab = document.getElementById('payMethodLabel');
      if(lab) lab.textContent = map[m] || 'Nakit';

      var a = ['nakit','kart','iban'];
      for(var i=0;i<a.length;i++){
        var b = document.getElementById('pm-'+a[i]);
        if(!b) continue;
        b.classList.toggle('btn-primary', a[i]===m);
      }
    }

    function renderPOS(){
      var branch = getBranch();
      var catBar = document.getElementById('catBar');
      var posGrid = document.getElementById('posGrid');
      var channelButtons = document.getElementById('channelButtons');
      if(!branch || !catBar || !posGrid || !channelButtons) return;

      var i, c, html;

      // Kategoriler
      html = '<div class="chip '+(activeCat==='Hepsi'?'active':'')+'" data-cat="Hepsi">üì¶ Hepsi</div>';
      for(i=0;i<state.categories.length;i++){
        c = state.categories[i];
        html += '<div class="chip '+(activeCat===c?'active':'')+'" data-cat="'+esc(c)+'">'+getCategoryIcon(c)+' '+esc(c)+'</div>';
      }
      catBar.innerHTML = html;

      // Kanallar
      html = '';
      for(i=0;i<state.salesChannels.length;i++){
        c = state.salesChannels[i];
        html += '<button class="channel-btn '+(activeChannel===c?'active':'')+'" type="button" data-channel="'+esc(c)+'">'+getChannelIcon(c)+' '+esc(c)+'</button>';
      }
      channelButtons.innerHTML = html;

      // Filtre
      var filtered = [];
      if(activeCat==='Hepsi'){
        filtered = branch.products.slice();
      }else{
        for(i=0;i<branch.products.length;i++){
          if(branch.products[i].cat === activeCat) filtered.push(branch.products[i]);
        }
      }

      if(filtered.length===0){
        posGrid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:2.6rem; color:var(--muted);"><div style="font-size:2.6rem; margin-bottom:.8rem;">üì≠</div><b>Bu kategoride √ºr√ºn yok</b><div class="muted" style="margin-top:6px;">√úr√ºn eklemek i√ßin √úr√ºnler sekmesine gidin</div></div>';
        return;
      }

      html = '';
      for(i=0;i<filtered.length;i++){
        var p = filtered[i];
        var stock = Number(p.stock)||0;
        var stockText = (stock>0) ? ('Stok: '+stock) : 'Stok yok';

        html += ''
          + '<div class="product" data-pid="'+Number(p.id)+'">'
          +   '<div class="pico">'+esc(p.icon || getCategoryIcon(p.cat))+'</div>'
          +   '<div style="min-width:0;">'
          +     '<b style="font-size:1.05rem;">'+esc(p.name)+'</b>'
          +     (p.description ? '<div style="font-size:.8rem; color:var(--muted); margin:5px 0;">'+esc(p.description)+'</div>' : '')
          +     '<div class="price">'+Number(p.price).toFixed(2)+' ‚Ç∫</div>'
          +     '<div class="stock">'+esc(stockText)+'</div>'
          +   '</div>'
          + '</div>';
      }
      posGrid.innerHTML = html;

      // √ºr√ºn tƒ±klama (event delegation)
      posGrid.onclick = function(ev){
        var el = ev.target;
        while(el && el !== posGrid && !el.classList.contains('product')) el = el.parentNode;
        if(!el || el === posGrid) return;
        var pid = Number(el.getAttribute('data-pid'));
        addToCart(pid);
      };
    }

    function addToCart(id){
      var b = getBranch();
      var p = findProduct(b.products, id);
      if(!p){ alert('√úr√ºn bulunamadƒ±!'); return; }

      var stock = Number(p.stock)||0;
      if(stock<=0){ alert('Bu √ºr√ºn stokta yok!'); return; }

      var exist = null;
      for(var i=0;i<cart.length;i++){
        if(Number(cart[i].id)===Number(id)) exist = cart[i];
      }

      if(exist){
        if(exist.qty + 1 > stock){
          alert('Yetersiz stok!');
          return;
        }
        exist.qty += 1;
      }else{
        cart.push({ id:Number(p.id), name:p.name, price:Number(p.price)||0, qty:1 });
      }

      renderCart();
    }

    function removeFromCart(idx){
      if(idx<0 || idx>=cart.length) return;
      cart.splice(idx,1);
      renderCart();
    }

    function changeCartQty(idx, delta){
      if(idx<0 || idx>=cart.length) return;
      var it = cart[idx];
      var b = getBranch();
      var p = findProduct(b.products, it.id);
      var stock = p ? (Number(p.stock)||0) : 0;

      var next = Number(it.qty) + Number(delta);
      if(next < 1){
        cart.splice(idx,1);
      }else{
        if(next > stock){
          alert('Yetersiz stok!');
          return;
        }
        it.qty = next;
      }
      renderCart();
    }

    function renderCart(){
      var container = document.getElementById('cartContainer');
      var emptyCart = document.getElementById('cartEmpty');
      var totalEl = document.getElementById('cartTotal');
      if(!container || !emptyCart || !totalEl) return;

      var total = 0;
      if(cart.length===0){
        container.innerHTML = '';
        emptyCart.style.display = 'block';
        totalEl.textContent = '0.00 ‚Ç∫';
        return;
      }

      emptyCart.style.display = 'none';

      var b = getBranch();
      var html = '';
      for(var i=0;i<cart.length;i++){
        var item = cart[i];
        total += (Number(item.price)||0) * (Number(item.qty)||0);

        var p = findProduct(b.products, item.id);
        var stock = p ? (Number(p.stock)||0) : 0;
        var canIncrease = p && (item.qty < stock);

        html += ''
          + '<div class="cart-item">'
          +   '<div style="flex:1; min-width:0;">'
          +     '<b>'+esc(item.name)+'</b><br>'
          +     '<small class="muted">'+Number(item.price).toFixed(2)+' ‚Ç∫</small>'
          +     '<div style="margin-top:6px; display:flex; align-items:center; gap:8px; flex-wrap:wrap;">'
          +       '<button class="btn btn-sm" type="button" onclick="changeCartQty('+i+',-1)">-</button>'
          +       '<span style="min-width:28px; text-align:center; font-weight:800;">'+Number(item.qty)+'</span>'
          +       '<button class="btn btn-sm" type="button" '+(canIncrease?'':'disabled')+' onclick="changeCartQty('+i+',1)">+</button>'
          +       '<small class="muted" style="margin-left:8px;">Stok: '+stock+'</small>'
          +     '</div>'
          +   '</div>'
          +   '<div style="display:flex; flex-direction:column; align-items:flex-end; gap:8px;">'
          +     '<b style="color:var(--accent);">'+(Number(item.price)*Number(item.qty)).toFixed(2)+' ‚Ç∫</b>'
          +     '<button class="btn btn-sm btn-danger" type="button" onclick="removeFromCart('+i+')">Sil</button>'
          +   '</div>'
          + '</div>';
      }
      container.innerHTML = html;
      totalEl.textContent = total.toFixed(2)+' ‚Ç∫';
    }

    function checkout(){
      if(cart.length===0){ alert('Sepet bo≈ü!'); return; }

      var b = getBranch();

      // stok kontrol + d√º≈ü
      for(var i=0;i<cart.length;i++){
        var it = cart[i];
        var p = findProduct(b.products, it.id);
        if(!p){ alert('√úr√ºn bulunamadƒ±!'); return; }
        var stock = Number(p.stock)||0;
        if(Number(it.qty) > stock){
          alert('Yetersiz stok: '+it.name);
          return;
        }
      }

      var total = calcItemsTotal(cart);

      for(i=0;i<cart.length;i++){
        p = findProduct(b.products, cart[i].id);
        p.stock = (Number(p.stock)||0) - (Number(cart[i].qty)||0);
      }

      b.sales.push({
        id: newId(),
        date: new Date().toISOString(),
        items: deepClone(cart),
        total: total,
        method: activePayMethod,
        channel: activeChannel
      });

      cart = [];
      save();
      renderCart();
      renderPOS();
      renderDashboard();
      alert(total.toFixed(2)+' ‚Ç∫ tutarƒ±ndaki satƒ±≈ü kaydedildi!');
    }

    /* ========= DASHBOARD ========= */
    function renderDashboard(){
      var b = getBranch();
      if(!b) return;

      var turnover = 0, expense = 0;
      for(var i=0;i<b.sales.length;i++) turnover += Number(b.sales[i].total)||0;
      for(i=0;i<b.expenses.length;i++) expense += Number(b.expenses[i].amount)||0;

      setText('repTurnover', turnover.toFixed(2)+' ‚Ç∫');
      setText('repExpense', expense.toFixed(2)+' ‚Ç∫');
      setText('repCount', String(b.sales.length));
      setText('repNet', (turnover-expense).toFixed(2)+' ‚Ç∫');

      filterSales();
    }

    function setText(id, txt){
      var el = document.getElementById(id);
      if(el) el.textContent = txt;
    }

    function filterSales(){
      var b = getBranch();
      var tbody = document.getElementById('salesTableBody');
      if(!b || !tbody) return;

      var method = getVal('salesMethodFilter');
      var channel = getVal('salesChannelFilter');
      var q = (getVal('salesSearch')||'').toLowerCase();

      var html = '';
      var list = b.sales.slice().sort(function(a,b){ return new Date(b.date) - new Date(a.date); });

      for(var i=0;i<list.length;i++){
        var s = list[i];
        if(method && s.method !== method) continue;
        if(channel && s.channel !== channel) continue;

        var hay = (String(s.id)+' '+String(s.channel)+' '+String(s.method)+' '+itemsToText(s.items)).toLowerCase();
        if(q && hay.indexOf(q) === -1) continue;

        html += '<tr>'
          + '<td>'+esc(fmtDateTime(s.date))+'<br><small class="muted">#'+esc(s.id)+'</small></td>'
          + '<td>'+esc(s.channel)+'</td>'
          + '<td>'+esc(payLabel(s.method))+'</td>'
          + '<td><b style="color:var(--accent);">'+Number(s.total).toFixed(2)+' ‚Ç∫</b></td>'
          + '<td><button class="btn btn-sm btn-warning" type="button" onclick="openEditSale('+Number(s.id)+')">D√ºzenle</button></td>'
          + '</tr>';
      }

      if(!html){
        html = '<tr><td colspan="5" class="muted" style="text-align:center; padding:18px;">Kayƒ±t yok</td></tr>';
      }
      tbody.innerHTML = html;
    }

    function itemsToText(items){
      var t = '';
      items = items || [];
      for(var i=0;i<items.length;i++){
        t += (items[i].name||'') + ' ';
      }
      return t;
    }

    function payLabel(m){
      return (m==='kart')?'Kart':(m==='iban')?'IBAN':'Nakit';
    }

    function getVal(id){
      var el = document.getElementById(id);
      return el ? el.value : '';
    }

    /* ========= EDIT SALE MODAL (stok g√ºvenli) ========= */
    function cloneItems(items){
      var out = [];
      items = items || [];
      for(var i=0;i<items.length;i++){
        out.push({
          id:Number(items[i].id),
          name:items[i].name,
          price:Number(items[i].price)||0,
          qty:Number(items[i].qty)||0
        });
      }
      return out;
    }

    function getOriginalQty(id){
      var items = (saleOriginalSnapshot && saleOriginalSnapshot.items) ? saleOriginalSnapshot.items : [];
      for(var i=0;i<items.length;i++){
        if(Number(items[i].id)===Number(id)) return Number(items[i].qty)||0;
      }
      return 0;
    }

    function openEditSale(saleId){
      var b = getBranch();
      var sale = findSale(b.sales, saleId);
      if(!sale) return;

      editingSaleId = saleId;

      saleOriginalSnapshot = {
        method: sale.method,
        channel: sale.channel,
        items: cloneItems(sale.items)
      };

      saleDraft = {
        method: sale.method,
        channel: sale.channel,
        items: cloneItems(sale.items)
      };

      renderEditSaleModal();
    }

    function closeEditModal(){
      var modal = document.getElementById('editSaleModal');
      if(modal) modal.classList.add('hidden');
      editingSaleId = null;
      saleDraft = null;
      saleOriginalSnapshot = null;
    }

    function renderEditSaleModal(){
      var b = getBranch();
      var sale = findSale(b.sales, editingSaleId);
      if(!sale || !saleDraft) return;

      var modal = document.getElementById('editSaleModal');
      var content = document.getElementById('editSaleContent');
      if(!modal || !content) return;

      var total = calcItemsTotal(saleDraft.items);

      var html = '';
      html += '<div style="margin-bottom:12px;"><div class="muted" style="font-size:12px;">Tarih: '+esc(fmtDateTime(sale.date))+'</div></div>';

      html += '<div style="margin-bottom:12px;">'
        + '<div class="muted" style="font-size:12px; margin-bottom:6px;">√ñdeme Y√∂ntemi</div>'
        + '<select id="editSaleMethod">'
        +   '<option value="nakit" '+(saleDraft.method==='nakit'?'selected':'')+'>Nakit</option>'
        +   '<option value="kart" '+(saleDraft.method==='kart'?'selected':'')+'>Kart</option>'
        +   '<option value="iban" '+(saleDraft.method==='iban'?'selected':'')+'>IBAN</option>'
        + '</select>'
        + '</div>';

      html += '<div style="margin-bottom:12px;">'
        + '<div class="muted" style="font-size:12px; margin-bottom:6px;">Satƒ±≈ü Kanalƒ±</div>'
        + '<select id="editSaleChannel">';
      for(var i=0;i<state.salesChannels.length;i++){
        var ch = state.salesChannels[i];
        html += '<option value="'+esc(ch)+'" '+(saleDraft.channel===ch?'selected':'')+'>'+esc(ch)+'</option>';
      }
      html += '</select></div>';

      html += '<div>'
        + '<div class="muted" style="font-size:12px; margin-bottom:8px;">√úr√ºnler</div>'
        + '<div style="padding:10px; background:var(--panel2); border:1px solid var(--border); border-radius:14px;">';

      if(saleDraft.items.length===0){
        html += '<div class="muted" style="text-align:center; padding:10px;">√úr√ºn yok</div>';
      }else{
        for(i=0;i<saleDraft.items.length;i++){
          var it = saleDraft.items[i];

          var p = findProduct(b.products, it.id);
          var stock = p ? (Number(p.stock)||0) : 0;
          var originalQty = getOriginalQty(it.id);
          var maxAllowed = stock + originalQty;
          var canInc = (Number(it.qty) < maxAllowed);

          html += '<div style="display:flex; justify-content:space-between; align-items:flex-start; padding:10px 0; border-bottom:1px solid var(--border); gap:10px;">'
            + '<div style="padding-right:10px; flex:1; min-width:0;">'
            +   '<b>'+esc(it.name)+'</b><br>'
            +   '<small class="muted">'+Number(it.price).toFixed(2)+' ‚Ç∫ x '+Number(it.qty)+' = '+(Number(it.price)*Number(it.qty)).toFixed(2)+' ‚Ç∫</small>'
            +   '<div class="muted" style="font-size:12px; margin-top:4px;">Stok: '+stock+' ‚Ä¢ Bu satƒ±≈ü i√ßin max: '+maxAllowed+'</div>'
            + '</div>'
            + '<div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">'
            +   '<button class="btn btn-sm" type="button" onclick="updateSaleItemQty('+i+',-1)">-</button>'
            +   '<span style="min-width:30px; text-align:center; font-weight:900;">'+Number(it.qty)+'</span>'
            +   '<button class="btn btn-sm" type="button" '+(canInc?'':'disabled')+' onclick="updateSaleItemQty('+i+',1)">+</button>'
            +   '<button class="btn btn-sm btn-danger" type="button" onclick="removeSaleItem('+i+')">Sil</button>'
            + '</div>'
            + '</div>';
        }
      }

      html += '</div>'
        + '<div style="margin-top:12px; display:flex; justify-content:flex-end; align-items:center; gap:10px; flex-wrap:wrap;">'
        +   '<div style="text-align:right; font-size:16px; font-weight:950;">Toplam: <span style="color:var(--accent)">'+total.toFixed(2)+' ‚Ç∫</span></div>'
        + '</div>'
        + '</div>';

      content.innerHTML = html;
      modal.classList.remove('hidden');
    }

    function updateSaleItemQty(itemIdx, change){
      if(!saleDraft) return;

      var b = getBranch();
      var it = saleDraft.items[itemIdx];
      if(!it) return;

      var p = findProduct(b.products, it.id);
      var stock = p ? (Number(p.stock)||0) : 0;
      var originalQty = getOriginalQty(it.id);
      var maxAllowed = stock + originalQty;

      var newQty = Number(it.qty) + Number(change);
      if(newQty < 1){
        saleDraft.items.splice(itemIdx,1);
      }else{
        if(change>0 && newQty>maxAllowed){
          alert('Yetersiz stok! Bu satƒ±≈ü i√ßin maksimum '+maxAllowed+' adet.');
          return;
        }
        it.qty = newQty;
      }
      renderEditSaleModal();
    }

    function removeSaleItem(itemIdx){
      if(!saleDraft) return;
      saleDraft.items.splice(itemIdx,1);
      renderEditSaleModal();
    }

    function updateSale(){
      var b = getBranch();
      var sale = findSale(b.sales, editingSaleId);
      if(!sale || !saleDraft || !saleOriginalSnapshot) return;

      var newMethod = getVal('editSaleMethod') || 'nakit';
      var newChannel = getVal('editSaleChannel') || 'D√ºkkan ƒ∞√ßi';

      // 1) eski satƒ±≈üƒ±n stok etkisini geri al
      for(var i=0;i<saleOriginalSnapshot.items.length;i++){
        var oi = saleOriginalSnapshot.items[i];
        var p1 = findProduct(b.products, oi.id);
        if(p1) p1.stock = (Number(p1.stock)||0) + (Number(oi.qty)||0);
      }

      // 2) yeni taslaƒüa g√∂re d√º≈ü (kontrol)
      for(i=0;i<saleDraft.items.length;i++){
        var ni = saleDraft.items[i];
        var p2 = findProduct(b.products, ni.id);
        if(!p2){ alert('√úr√ºn bulunamadƒ±: '+ni.name); return; }
        var st = Number(p2.stock)||0;
        if(Number(ni.qty) > st){
          // fail-safe: eskiyi tekrar d√º≈ü
          for(var j=0;j<saleOriginalSnapshot.items.length;j++){
            var oi2 = saleOriginalSnapshot.items[j];
            var pp = findProduct(b.products, oi2.id);
            if(pp) pp.stock = (Number(pp.stock)||0) - (Number(oi2.qty)||0);
          }
          alert('Yetersiz stok: '+ni.name+' (Mevcut: '+st+')');
          return;
        }
      }
      for(i=0;i<saleDraft.items.length;i++){
        ni = saleDraft.items[i];
        p2 = findProduct(b.products, ni.id);
        p2.stock = (Number(p2.stock)||0) - (Number(ni.qty)||0);
      }

      sale.method = newMethod;
      sale.channel = newChannel;
      sale.items = cloneItems(saleDraft.items);
      sale.total = calcItemsTotal(sale.items);

      save();
      closeEditModal();
      renderAll();
      alert('Satƒ±≈ü g√ºncellendi!');
    }

    function deleteSale(){
      var b = getBranch();
      var sale = findSale(b.sales, editingSaleId);
      if(!sale) return;

      if(!confirm('Bu satƒ±≈üƒ± silmek istiyor musunuz?')) return;

      // stoklarƒ± geri ver
      for(var i=0;i<sale.items.length;i++){
        var it = sale.items[i];
        var p = findProduct(b.products, it.id);
        if(p) p.stock = (Number(p.stock)||0) + (Number(it.qty)||0);
      }

      // satƒ±≈ütan √ßƒ±kar
      for(i=0;i<b.sales.length;i++){
        if(Number(b.sales[i].id)===Number(editingSaleId)){
          b.sales.splice(i,1);
          break;
        }
      }

      save();
      closeEditModal();
      renderAll();
      alert('Satƒ±≈ü silindi.');
    }

    /* ========= INVENTORY ========= */
    function saveProduct(){
      var b = getBranch();
      if(!b) return;

      var idRaw = getVal('editProductId');
      var name = getVal('prodName').trim();
      var desc = getVal('prodDesc').trim();
      var price = Number(getVal('prodPrice'));
      var stock = Number(getVal('prodStock'));
      var cat = getVal('prodCat');
      var icon = getVal('prodIcon').trim();

      if(!name){ alert('√úr√ºn adƒ± girin'); return; }
      if(!(price>=0)){ alert('Fiyat ge√ßersiz'); return; }
      if(!(stock>=0)){ alert('Stok ge√ßersiz'); return; }

      if(idRaw){
        var pid = Number(idRaw);
        var p = findProduct(b.products, pid);
        if(!p){ alert('√úr√ºn bulunamadƒ±'); return; }
        p.name = name;
        p.description = desc;
        p.price = price;
        p.stock = stock;
        p.cat = cat;
        p.icon = icon;
        cancelProductEdit();
      }else{
        b.products.push({
          id: newId(),
          name:name,
          description:desc,
          price:price,
          stock:stock,
          cat:cat,
          icon:icon
        });
      }

      save();
      renderAll();
      alert('Kaydedildi!');
    }

    function startEditProduct(id){
      var p = findProduct(getBranch().products, id);
      if(!p) return;
      setVal('editProductId', p.id);
      setVal('prodName', p.name);
      setVal('prodDesc', p.description || '');
      setVal('prodPrice', p.price);
      setVal('prodStock', p.stock);
      setVal('prodCat', p.cat);
      setVal('prodIcon', p.icon || '');

      var t = document.getElementById('formTitle');
      if(t) t.textContent = '√úr√ºn√º G√ºncelle';

      var btn = document.getElementById('btnSaveProd');
      if(btn) btn.textContent = 'G√ºncelle';

      var cancel = document.getElementById('btnCancelEdit');
      if(cancel) cancel.style.display = 'inline-flex';
    }

    function cancelProductEdit(){
      setVal('editProductId', '');
      setVal('prodName', '');
      setVal('prodDesc', '');
      setVal('prodPrice', '');
      setVal('prodStock', '100');
      setVal('prodIcon', '');

      var t = document.getElementById('formTitle');
      if(t) t.textContent = 'Yeni √úr√ºn Ekle';

      var btn = document.getElementById('btnSaveProd');
      if(btn) btn.textContent = 'Kaydet';

      var cancel = document.getElementById('btnCancelEdit');
      if(cancel) cancel.style.display = 'none';
    }

    function deleteProduct(id){
      if(!confirm('√úr√ºn√º silmek istiyor musunuz?')) return;
      var b = getBranch();
      for(var i=0;i<b.products.length;i++){
        if(Number(b.products[i].id)===Number(id)){
          b.products.splice(i,1);
          break;
        }
      }
      save();
      renderAll();
    }

    function renderInventory(){
      var b = getBranch();
      var tbody = document.querySelector('#inventoryTable tbody');
      if(!b || !tbody) return;

      var html = '';
      for(var i=0;i<b.products.length;i++){
        var p = b.products[i];
        html += '<tr data-name="'+esc(p.name)+'" data-cat="'+esc(p.cat)+'">'
          + '<td><b>'+esc(p.name)+'</b>'+(p.description?'<br><small class="muted">'+esc(p.description)+'</small>':'')+'</td>'
          + '<td><span class="chip" style="font-size:11px; height:30px; padding:0 10px;">'+esc(p.cat)+'</span></td>'
          + '<td><b style="color:var(--accent);">'+Number(p.price).toFixed(2)+' ‚Ç∫</b></td>'
          + '<td>'+Number(p.stock)+'</td>'
          + '<td>'
          +   '<button class="btn btn-sm btn-warning" type="button" onclick="startEditProduct('+Number(p.id)+')">D√ºzenle</button> '
          +   '<button class="btn btn-sm btn-danger" type="button" onclick="deleteProduct('+Number(p.id)+')">Sil</button>'
          + '</td>'
          + '</tr>';
      }
      tbody.innerHTML = html;
      filterProducts();
    }

    function filterProducts(){
      var cat = getVal('invCatFilter');
      var q = (getVal('invSearch')||'').toLowerCase();

      var rows = document.querySelectorAll('#inventoryTable tbody tr');
      for(var i=0;i<rows.length;i++){
        var r = rows[i];
        var rc = r.getAttribute('data-cat') || '';
        var rn = (r.getAttribute('data-name') || '').toLowerCase();

        var ok = true;
        if(cat && rc !== cat) ok = false;
        if(q && rn.indexOf(q) === -1) ok = false;

        r.style.display = ok ? '' : 'none';
      }
    }

    function setVal(id, v){
      var el = document.getElementById(id);
      if(el) el.value = v;
    }

    /* ========= EXPENSES ========= */
    function addExpense(){
      var b = getBranch();
      if(!b) return;

      var type = getVal('expenseType');
      var amount = Number(getVal('expenseAmount'));
      var date = getVal('expenseDate');
      var desc = getVal('expenseDesc').trim();

      if(!type){ alert('Gider tipi se√ßin'); return; }
      if(!(amount>0)){ alert('Tutar girin'); return; }
      if(!date){ alert('Tarih se√ßin'); return; }

      b.expenses.push({
        id: newId(),
        type: type,
        amount: amount,
        date: date,
        desc: desc
      });

      setVal('expenseAmount','');
      setVal('expenseDesc','');

      save();
      renderExpenses();
      renderDashboard();
      alert('Gider eklendi!');
    }

    function deleteExpense(id){
      if(!confirm('Gider silinsin mi?')) return;
      var b = getBranch();
      for(var i=0;i<b.expenses.length;i++){
        if(Number(b.expenses[i].id)===Number(id)){
          b.expenses.splice(i,1);
          break;
        }
      }
      save();
      renderExpenses();
      renderDashboard();
    }

    function renderExpenses(){
      var expTypeList = document.getElementById('expTypeList');
      if(expTypeList){
        var html = '';
        for(var i=0;i<state.expenseTypes.length;i++){
          var t = state.expenseTypes[i];
          html += '<span class="chip" style="height:36px; padding:0 12px; font-size:12px;">'+getExpenseIcon(t)+' '+esc(t)+'</span>';
        }
        expTypeList.innerHTML = html;
      }
      filterExpenses();
    }

    function filterExpenses(){
      var b = getBranch();
      var tbody = document.getElementById('expensesTableBody');
      if(!b || !tbody) return;

      var type = getVal('expTypeFilter');
      var q = (getVal('expSearch')||'').toLowerCase();

      var list = b.expenses.slice().sort(function(a,b){ return String(b.date).localeCompare(String(a.date)); });

      var html = '';
      for(var i=0;i<list.length;i++){
        var e = list[i];
        if(type && e.type !== type) continue;

        var hay = (String(e.type)+' '+String(e.desc||'')).toLowerCase();
        if(q && hay.indexOf(q)===-1) continue;

        html += '<tr>'
          + '<td>'+esc(e.date)+'</td>'
          + '<td>'+esc(e.type)+'</td>'
          + '<td>'+(e.desc?esc(e.desc):'<span class="muted">-</span>')+'</td>'
          + '<td><b style="color:var(--warning);">'+Number(e.amount).toFixed(2)+' ‚Ç∫</b></td>'
          + '<td><button class="btn btn-sm btn-danger" type="button" onclick="deleteExpense('+Number(e.id)+')">Sil</button></td>'
          + '</tr>';
      }

      if(!html){
        html = '<tr><td colspan="5" class="muted" style="text-align:center; padding:18px;">Kayƒ±t yok</td></tr>';
      }

      tbody.innerHTML = html;
    }

    /* ========= BACKUP DOWNLOAD ========= */
    function downloadBackup(){
      try{
        var json = JSON.stringify(state, null, 2);
        var blob = new Blob([json], {type:'application/json'});
        var url = URL.createObjectURL(blob);

        var a = document.createElement('a');
        a.href = url;
        a.download = 'mahsum_usta_yedek_' + toDateInputValue(new Date()) + '.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        setTimeout(function(){ URL.revokeObjectURL(url); }, 1000);
        showSaveStatus('Yedek indirildi', 'success');
      }catch(e){
        showSaveStatus('Yedek alƒ±namadƒ±!', 'error');
        alert('Yedek hatasƒ±: ' + e);
      }
    }
  </script>
</body>
</html>
