<!DOCTYPE html>
<html lang="tr" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>√áiƒük√∂fteci Pro V5 | Profesyonel Y√∂netim</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --font-main: "Inter", sans-serif;
      --radius: 20px;
      --radius-sm: 14px;
      --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      
      /* √áiƒük√∂fteci temasƒ±na uygun modern renkler */
      --primary: #E53935;
      --primary-hover: #C62828;
      --primary-light: #FF6B6B;
      --secondary: #FF9800;
      --success: #4CAF50;
      --warning: #FFB74D;
      --danger: #D32F2F;
      --info: #2196F3;
      
      --bg-body: #0F1419;
      --bg-panel: #1A2029;
      --bg-panel-light: #232B36;
      --bg-input: #2D3748;
      --border: #3A4556;
      --text-main: #F7FAFC;
      --text-muted: #A0AEC0;
      --shadow: 0 20px 40px -15px rgba(0, 0, 0, 0.5);
      --gradient-primary: linear-gradient(135deg, var(--primary), var(--secondary));
    }

    html[data-theme="light"] {
      --bg-body: #F5F7FA;
      --bg-panel: #FFFFFF;
      --bg-panel-light: #F8FAFC;
      --bg-input: #EDF2F7;
      --border: #E2E8F0;
      --text-main: #1A202C;
      --text-muted: #718096;
      --shadow: 0 20px 40px -15px rgba(0, 0, 0, 0.08);
    }

    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }

    body {
      font-family: var(--font-main);
      background: var(--bg-body);
      color: var(--text-main);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* HEADER */
    header {
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 100;
      box-shadow: var(--shadow);
    }
    
    .brand { 
      display: flex; 
      align-items: center; 
      gap: 15px; 
    }
    
    .logo { 
      background: var(--gradient-primary);
      color: white; 
      padding: 12px 18px; 
      border-radius: var(--radius-sm);
      font-weight: 900; 
      font-size: 1.5rem;
      box-shadow: 0 8px 20px rgba(229, 57, 53, 0.3);
    }
    
    .header-controls {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .save-btn {
      background: var(--success);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: var(--radius-sm);
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    #themeToggle {
      background: var(--bg-input);
      border: 1px solid var(--border);
      color: var(--text-main);
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.2rem;
    }
    
    #themeToggle:hover {
      background: var(--primary);
      color: white;
    }

    /* LAYOUT */
    .app-container { 
      display: flex; 
      flex: 1; 
      height: calc(100vh - 70px); 
    }
    
    nav.sidebar {
      width: 100px; 
      background: var(--bg-panel); 
      border-right: 1px solid var(--border);
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      padding: 25px 0; 
      gap: 20px;
    }
    
    .nav-item {
      width: 70px; 
      height: 70px; 
      border-radius: var(--radius-sm);
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center;
      color: var(--text-muted); 
      cursor: pointer; 
      transition: var(--transition);
      border: none; 
      background: transparent; 
      font-size: 0.75rem; 
      gap: 6px;
    }
    
    .nav-item svg { 
      width: 26px; 
      height: 26px; 
      stroke: currentColor; 
      fill: none; 
      stroke-width: 2; 
    }
    
    .nav-item:hover {
      background: var(--bg-input);
      color: var(--text-main);
    }
    
    .nav-item.active { 
      background: var(--gradient-primary); 
      color: white; 
      box-shadow: 0 10px 20px rgba(229, 57, 53, 0.3);
    }
    
    .main-viewport { 
      flex: 1; 
      position: relative; 
      overflow: hidden; 
    }
    
    .page-view { 
      position: absolute; 
      inset: 0; 
      padding: 2rem; 
      display: flex; 
      flex-direction: column; 
      overflow-y: auto;
    }
    
    .hidden { display: none !important; }

    /* POS GRID */
    .pos-grid { 
      display: grid; 
      grid-template-columns: 1fr 420px; 
      gap: 2.5rem; 
      height: 100%; 
    }
    
    .category-scroll { 
      display: flex; 
      gap: 12px; 
      overflow-x: auto; 
      padding: 1rem 0 1.5rem 0;
      margin-bottom: 1rem;
    }
    
    .cat-chip {
      padding: 12px 28px; 
      border-radius: 100px; 
      background: var(--bg-panel);
      border: 2px solid var(--border); 
      color: var(--text-muted); 
      cursor: pointer; 
      white-space: nowrap; 
      font-weight: 600;
      flex-shrink: 0;
    }
    
    .cat-chip.active { 
      background: var(--gradient-primary); 
      color: white; 
      border-color: var(--primary);
      box-shadow: 0 8px 20px rgba(229, 57, 53, 0.3);
    }

    /* √úr√ºn Listesi */
    .product-list { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
      gap: 1.8rem; 
    }
    
    .prod-card {
      background: var(--bg-panel); 
      border: 1px solid var(--border);
      border-radius: var(--radius); 
      overflow: hidden; 
      cursor: pointer; 
      transition: var(--transition);
    }
    
    .prod-card:hover { 
      border-color: var(--primary);
      box-shadow: var(--shadow);
    }
    
    .prod-card .img-box { 
      height: 140px; 
      background: linear-gradient(135deg, var(--bg-input), var(--bg-panel-light));
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 3.5rem;
    }
    
    .prod-card .info { 
      padding: 1rem; 
    }
    
    .prod-card .price {
      color: var(--primary); 
      font-weight: 800; 
      font-size: 1.3rem;
      margin: 8px 0;
    }
    
    .prod-card .stock {
      font-size: 0.75rem; 
      color: var(--text-muted);
    }

    /* SEPET */
    .cart-panel { 
      background: var(--bg-panel); 
      border-radius: var(--radius); 
      border: 1px solid var(--border); 
      display: flex; 
      flex-direction: column;
      box-shadow: var(--shadow);
    }
    
    .cart-items { 
      flex: 1; 
      overflow-y: auto; 
      padding: 1.5rem; 
      display: flex; 
      flex-direction: column; 
      gap: 12px;
    }
    
    .cart-item { 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      background: var(--bg-input); 
      padding: 1rem; 
      border-radius: var(--radius-sm); 
      border-left: 4px solid var(--primary);
    }
    
    .total-row { 
      display: flex; 
      justify-content: space-between; 
      font-size: 1.8rem; 
      font-weight: 900; 
      padding: 1.5rem; 
      border-top: 2px solid var(--border);
      background: var(--bg-panel-light);
      color: var(--primary);
    }
    
    .cart-empty {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-muted);
    }

    /* Satƒ±≈ü Kanalƒ± Se√ßimi */
    .sales-channel-selector {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      background: var(--bg-panel-light);
    }
    
    .channel-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    
    .channel-btn {
      padding: 8px 16px;
      border-radius: var(--radius-sm);
      border: 2px solid var(--border);
      background: var(--bg-panel);
      color: var(--text-main);
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: var(--transition);
    }
    
    .channel-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .channel-btn:hover {
      border-color: var(--primary);
    }

    /* √ñdeme Butonlarƒ± */
    .payment-grid { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 12px; 
      padding: 1.5rem; 
      background: var(--bg-panel-light);
      border-top: 1px solid var(--border);
    }
    
    .pay-btn { 
      height: 70px; 
      border-radius: var(--radius-sm); 
      border: 2px solid var(--border); 
      background: var(--bg-panel); 
      color: var(--text-main); 
      font-weight: 800; 
      cursor: pointer; 
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .pay-btn.cash { 
      border-color: var(--success); 
      color: var(--success); 
    }
    
    .pay-btn.card { 
      border-color: var(--info); 
      color: var(--info); 
    }
    
    .pay-btn.iban { 
      grid-column: span 2; 
      border-color: var(--warning); 
      color: var(--warning); 
    }

    /* KPI Kartlarƒ± */
    .kpi-card { 
      background: var(--bg-panel); 
      padding: 1.8rem; 
      border-radius: var(--radius); 
      border: 1px solid var(--border); 
      margin-bottom: 1.5rem; 
      box-shadow: var(--shadow);
    }

    /* Tablolar */
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 1rem; 
    }
    
    th, td { 
      text-align: left; 
      padding: 1rem; 
      border-bottom: 1px solid var(--border); 
    }

    /* Formlar */
    .form-group { 
      margin-bottom: 1.5rem; 
    }
    
    label { 
      display: block; 
      margin-bottom: 8px; 
      font-size: 0.9rem; 
      color: var(--text-muted); 
      font-weight: 600;
    }
    
    input, select { 
      width: 100%; 
      padding: 12px 16px; 
      background: var(--bg-input); 
      border: 2px solid var(--border); 
      border-radius: var(--radius-sm); 
      color: var(--text-main); 
      font-family: var(--font-main);
      font-size: 1rem;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    /* Butonlar */
    .btn { 
      padding: 12px 24px; 
      border-radius: var(--radius-sm); 
      border: none; 
      font-weight: 700; 
      cursor: pointer; 
      font-family: var(--font-main);
      font-size: 0.95rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-primary { 
      background: var(--gradient-primary); 
      color: white; 
    }
    
    .btn-danger { 
      background: var(--danger); 
      color: white; 
    }
    
    .btn-warning { 
      background: var(--warning); 
      color: #000; 
    }
    
    .btn-sm { 
      padding: 8px 16px; 
      font-size: 0.85rem; 
    }

    /* Filtreleme Alanlarƒ± */
    .filter-container {
      display: flex;
      gap: 12px;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    
    .filter-input {
      flex: 1;
      min-width: 200px;
    }
    
    .filter-btn {
      background: var(--bg-input);
      color: var(--text-main);
      border: 1px solid var(--border);
      padding: 10px 20px;
      border-radius: var(--radius-sm);
      cursor: pointer;
    }
    
    .filter-btn.active {
      background: var(--primary);
      color: white;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .pos-grid {
        grid-template-columns: 1fr;
      }
      
      .cart-panel {
        max-height: 400px;
      }
    }
  </style>
</head>
<body>

  <!-- HTML'ye G√∂m√ºl√º Ba≈ülangƒ±√ß Verileri -->
  <script type="application/json" id="defaultData">
  {
    "categories": ["D√ºr√ºmler", "Porsiyonlar", "ƒ∞√ßecekler", "Ek Paketler"],
    "expenseTypes": ["Kira", "Elektrik Faturasƒ±", "Su Faturasƒ±", "Manav", "Mutfak Malzemesi", "Temizlik Malzemesi", "Personel", "Diƒüer"],
    "salesChannels": ["D√ºkkan ƒ∞√ßi", "Telefon", "Yemeksepeti", "Getir", "Trendyol Yemek"],
    "theme": "dark"
  }
  </script>

  <!-- ≈ûube 1: Hastane ≈ûubesi √úr√ºnleri -->
  <script type="application/json" id="branchHastaneProducts">
  [
    {"id": 1, "name": "D√ºr√ºm 90gr", "cat": "D√ºr√ºmler", "price": 60, "stock": 100, "icon": "üåØ", "description": "Normal boy d√ºr√ºm"},
    {"id": 2, "name": "Mega D√ºr√ºm 130gr", "cat": "D√ºr√ºmler", "price": 90, "stock": 80, "icon": "üåØ", "description": "Mega boy d√ºr√ºm"},
    {"id": 3, "name": "Ultra Mega D√ºr√ºm 160gr", "cat": "D√ºr√ºmler", "price": 110, "stock": 60, "icon": "üåØ", "description": "Ultra mega boy d√ºr√ºm"},
    {"id": 4, "name": "Duble D√ºr√ºm 190gr", "cat": "D√ºr√ºmler", "price": 135, "stock": 40, "icon": "üåØ", "description": "Duble boy d√ºr√ºm"},
    
    {"id": 5, "name": "Doritos (Normal D√ºr√ºm)", "cat": "Ek Paketler", "price": 15, "stock": 200, "icon": "üåÆ", "description": "Normal d√ºr√ºme eklenir"},
    {"id": 6, "name": "Doritos (B√ºy√ºk D√ºr√ºm)", "cat": "Ek Paketler", "price": 20, "stock": 200, "icon": "üåÆ", "description": "Mega, Ultra Mega, Duble d√ºr√ºmlere eklenir"},
    
    {"id": 7, "name": "250 gr Porsiyon", "cat": "Porsiyonlar", "price": 90, "stock": 50, "icon": "ü•ô", "description": "K√º√ß√ºk porsiyon"},
    {"id": 8, "name": "350 gr Porsiyon", "cat": "Porsiyonlar", "price": 115, "stock": 40, "icon": "ü•ô", "description": "Orta porsiyon"},
    {"id": 9, "name": "500 gr Porsiyon", "cat": "Porsiyonlar", "price": 150, "stock": 30, "icon": "ü•ô", "description": "B√ºy√ºk porsiyon"},
    {"id": 10, "name": "750 gr Porsiyon", "cat": "Porsiyonlar", "price": 225, "stock": 20, "icon": "ü•ô", "description": "√áok b√ºy√ºk porsiyon"},
    {"id": 11, "name": "1 kg Porsiyon", "cat": "Porsiyonlar", "price": 300, "stock": 15, "icon": "ü•ô", "description": "Aile boy porsiyon"},
    
    {"id": 12, "name": "K√º√ß√ºk Ye≈üilik", "cat": "Ek Paketler", "price": 20, "stock": 80, "icon": "ü•ó", "description": "K√º√ß√ºk ye≈üillik paketi"},
    {"id": 13, "name": "B√ºy√ºk Ye≈üilik", "cat": "Ek Paketler", "price": 35, "stock": 60, "icon": "ü•ó", "description": "B√ºy√ºk ye≈üillik paketi"},
    {"id": 14, "name": "Tur≈üu Paketi", "cat": "Ek Paketler", "price": 35, "stock": 50, "icon": "ü•í", "description": "Karƒ±≈üƒ±k tur≈üu paketi"},
    {"id": 15, "name": "2 Lava≈ü", "cat": "Ek Paketler", "price": 8, "stock": 150, "icon": "ü´ì", "description": "2 adet lava≈ü ekmeƒüi"},
    
    {"id": 16, "name": "Su 500ml", "cat": "ƒ∞√ßecekler", "price": 10, "stock": 300, "icon": "üíß", "description": "≈ûi≈üe su"},
    {"id": 17, "name": "K√º√ß√ºk Ayran", "cat": "ƒ∞√ßecekler", "price": 20, "stock": 200, "icon": "ü•õ", "description": "200ml ayran"},
    {"id": 18, "name": "B√ºy√ºk Ayran", "cat": "ƒ∞√ßecekler", "price": 25, "stock": 150, "icon": "ü•õ", "description": "330ml ayran"},
    {"id": 19, "name": "1 Lt Kola", "cat": "ƒ∞√ßecekler", "price": 30, "stock": 100, "icon": "ü•§", "description": "1 litre kola"},
    {"id": 20, "name": "2.5 Lt Kola", "cat": "ƒ∞√ßecekler", "price": 50, "stock": 80, "icon": "ü•§", "description": "2.5 litre kola"},
    {"id": 21, "name": "Cam ≈ûi≈üe Kola", "cat": "ƒ∞√ßecekler", "price": 25, "stock": 120, "icon": "ü•§", "description": "250ml cam ≈üi≈üe kola"},
    {"id": 22, "name": "Cam ≈ûi≈üe Fanta", "cat": "ƒ∞√ßecekler", "price": 25, "stock": 120, "icon": "ü•§", "description": "250ml cam ≈üi≈üe fanta"},
    {"id": 23, "name": "≈ûalgam 330ml", "cat": "ƒ∞√ßecekler", "price": 20, "stock": 100, "icon": "üßÉ", "description": "K√º√ß√ºk ≈üalgam"},
    {"id": 24, "name": "1 Lt ≈ûalgam", "cat": "ƒ∞√ßecekler", "price": 40, "stock": 60, "icon": "üßÉ", "description": "1 litre ≈üalgam"},
    {"id": 25, "name": "Limonata", "cat": "ƒ∞√ßecekler", "price": 25, "stock": 80, "icon": "üçã", "description": "Taze limonata"}
  ]
  </script>

  <!-- ≈ûube 2: Cihanpol ≈ûubesi √úr√ºnleri -->
  <script type="application/json" id="branchCihanpolProducts">
  [
    {"id": 1, "name": "D√ºr√ºm 90gr", "cat": "D√ºr√ºmler", "price": 60, "stock": 80, "icon": "üåØ", "description": "Normal boy d√ºr√ºm"},
    {"id": 2, "name": "Mega D√ºr√ºm 130gr", "cat": "D√ºr√ºmler", "price": 90, "stock": 60, "icon": "üåØ", "description": "Mega boy d√ºr√ºm"},
    {"id": 3, "name": "Ultra Mega D√ºr√ºm 160gr", "cat": "D√ºr√ºmler", "price": 110, "stock": 40, "icon": "üåØ", "description": "Ultra mega boy d√ºr√ºm"},
    {"id": 4, "name": "Duble D√ºr√ºm 190gr", "cat": "D√ºr√ºmler", "price": 135, "stock": 30, "icon": "üåØ", "description": "Duble boy d√ºr√ºm"},
    
    {"id": 5, "name": "Doritos (Normal D√ºr√ºm)", "cat": "Ek Paketler", "price": 15, "stock": 150, "icon": "üåÆ", "description": "Normal d√ºr√ºme eklenir"},
    {"id": 6, "name": "Doritos (B√ºy√ºk D√ºr√ºm)", "cat": "Ek Paketler", "price": 20, "stock": 150, "icon": "üåÆ", "description": "Mega, Ultra Mega, Duble d√ºr√ºmlere eklenir"},
    
    {"id": 7, "name": "250 gr Porsiyon", "cat": "Porsiyonlar", "price": 90, "stock": 40, "icon": "ü•ô", "description": "K√º√ß√ºk porsiyon"},
    {"id": 8, "name": "350 gr Porsiyon", "cat": "Porsiyonlar", "price": 115, "stock": 30, "icon": "ü•ô", "description": "Orta porsiyon"},
    {"id": 9, "name": "500 gr Porsiyon", "cat": "Porsiyonlar", "price": 150, "stock": 20, "icon": "ü•ô", "description": "B√ºy√ºk porsiyon"},
    {"id": 10, "name": "750 gr Porsiyon", "cat": "Porsiyonlar", "price": 225, "stock": 15, "icon": "ü•ô", "description": "√áok b√ºy√ºk porsiyon"},
    {"id": 11, "name": "1 kg Porsiyon", "cat": "Porsiyonlar", "price": 300, "stock": 10, "icon": "ü•ô", "description": "Aile boy porsiyon"},
    
    {"id": 12, "name": "K√º√ß√ºk Ye≈üilik", "cat": "Ek Paketler", "price": 20, "stock": 80, "icon": "ü•ó", "description": "K√º√ß√ºk ye≈üillik paketi"},
    {"id": 13, "name": "B√ºy√ºk Ye≈üilik", "cat": "Ek Paketler", "price": 35, "stock": 60, "icon": "ü•ó", "description": "B√ºy√ºk ye≈üillik paketi"},
    {"id": 14, "name": "Tur≈üu Paketi", "cat": "Ek Paketler", "price": 35, "stock": 50, "icon": "ü•í", "description": "Karƒ±≈üƒ±k tur≈üu paketi"},
    {"id": 15, "name": "2 Lava≈ü", "cat": "Ek Paketler", "price": 8, "stock": 150, "icon": "ü´ì", "description": "2 adet lava≈ü ekmeƒüi"},
    
    {"id": 16, "name": "Su 500ml", "cat": "ƒ∞√ßecekler", "price": 10, "stock": 200, "icon": "üíß", "description": "≈ûi≈üe su"},
    {"id": 17, "name": "K√º√ß√ºk Ayran", "cat": "ƒ∞√ßecekler", "price": 20, "stock": 150, "icon": "ü•õ", "description": "200ml ayran"},
    {"id": 18, "name": "B√ºy√ºk Ayran", "cat": "ƒ∞√ßecekler", "price": 25, "stock": 100, "icon": "ü•õ", "description": "330ml ayran"},
    {"id": 19, "name": "1 Lt Kola", "cat": "ƒ∞√ßecekler", "price": 30, "stock": 80, "icon": "ü•§", "description": "1 litre kola"},
    {"id": 20, "name": "2.5 Lt Kola", "cat": "ƒ∞√ßecekler", "price": 50, "stock": 60, "icon": "ü•§", "description": "2.5 litre kola"},
    {"id": 21, "name": "Cam ≈ûi≈üe Kola", "cat": "ƒ∞√ßecekler", "price": 25, "stock": 100, "icon": "ü•§", "description": "250ml cam ≈üi≈üe kola"},
    {"id": 22, "name": "Cam ≈ûi≈üe Fanta", "cat": "ƒ∞√ßecekler", "price": 25, "stock": 100, "icon": "ü•§", "description": "250ml cam ≈üi≈üe fanta"},
    {"id": 23, "name": "≈ûalgam 330ml", "cat": "ƒ∞√ßecekler", "price": 20, "stock": 80, "icon": "üßÉ", "description": "K√º√ß√ºk ≈üalgam"},
    {"id": 24, "name": "1 Lt ≈ûalgam", "cat": "ƒ∞√ßecekler", "price": 40, "stock": 50, "icon": "üßÉ", "description": "1 litre ≈üalgam"},
    {"id": 25, "name": "Limonata", "cat": "ƒ∞√ßecekler", "price": 25, "stock": 60, "icon": "üçã", "description": "Taze limonata"}
  ]
  </script>

  <header>
    <div class="brand">
      <div class="logo">üåØ</div>
      <div>
        <h1 style="font-size: 1.3rem; font-weight: 800;">√áiƒük√∂fteci Pro V5</h1>
        <div style="display: flex; align-items: center; gap: 10px; margin-top: 2px;">
          <span id="currentBranchName" style="font-size: 0.9rem; color: var(--text-muted);"></span>
          <div class="save-status" id="saveStatus" style="font-size: 0.8rem; color: var(--text-muted);"></div>
        </div>
      </div>
    </div>
    <div class="header-controls">
      <select id="branchSelect" style="width: 220px; padding: 10px; border-radius: 10px; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main);">
        <option value="hastane">üè• Hastane ≈ûubesi</option>
        <option value="cihanpol">üìç Cihanpol ≈ûubesi</option>
      </select>
      
      <button class="save-btn" id="manualSaveBtn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
          <polyline points="17 21 17 13 7 13 7 21"></polyline>
          <polyline points="7 3 7 8 15 8"></polyline>
        </svg>
        Yedek Al
      </button>
      
      <button id="themeToggle" class="btn">üåô</button>
    </div>
  </header>

  <div class="app-container">
    <nav class="sidebar">
      <button class="nav-item active" data-view="pos">
        <svg viewBox="0 0 24 24"><path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
        <span>SATI≈û</span>
      </button>
      <button class="nav-item" data-view="dashboard">
        <svg viewBox="0 0 24 24"><path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
        <span>RAPOR</span>
      </button>
      <button class="nav-item" data-view="inventory">
        <svg viewBox="0 0 24 24"><path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
        <span>√úR√úNLER</span>
      </button>
      <button class="nav-item" data-view="expenses">
        <svg viewBox="0 0 24 24"><path d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.407 2.67 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.407-2.67-1M12 16v1m4-12H8a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2z"></path></svg>
        <span>Gƒ∞DER</span>
      </button>
    </nav>

    <main class="main-viewport">
      
      <!-- SATI≈û (POS) -->
      <section id="view-pos" class="page-view">
        <div class="pos-grid">
          <div style="display:flex; flex-direction:column; overflow:hidden;">
            <div class="category-scroll" id="catBar"></div>
            <div class="product-list" id="posGrid"></div>
          </div>
          <div class="cart-panel">
            <div class="sales-channel-selector">
              <div style="font-weight: 600; color: var(--text-muted); margin-bottom: 5px;">Satƒ±≈ü Kanalƒ±:</div>
              <div class="channel-buttons" id="channelButtons">
                <!-- Satƒ±≈ü kanallarƒ± buraya eklenecek -->
              </div>
            </div>
            <div style="padding: 1.5rem; border-bottom: 1px solid var(--border);">
              <h3 style="margin:0;">üõí Sepet</h3>
            </div>
            <div class="cart-items" id="cartContainer"></div>
            <div id="cartEmpty" class="cart-empty">
              <div style="font-size: 3rem; margin-bottom: 1rem;">üõí</div>
              <h4>Sepet Bo≈ü</h4>
              <p style="font-size: 0.9rem;">√úr√ºn eklemek i√ßin listeden se√ßim yapƒ±n</p>
            </div>
            <div class="total-row"><span>Toplam</span><span id="cartTotal">0.00 ‚Ç∫</span></div>
            <div class="payment-grid">
              <button class="pay-btn cash" onclick="doCheckout('nakit')">
                <span>üíµ</span> NAKƒ∞T
              </button>
              <button class="pay-btn card" onclick="doCheckout('kart')">
                <span>üí≥</span> KART
              </button>
              <button class="pay-btn iban" onclick="doCheckout('iban')">
                <span>üè¶</span> IBAN
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- √úR√úN Y√ñNETƒ∞Mƒ∞ -->
      <section id="view-inventory" class="page-view hidden">
        <div style="display:grid; grid-template-columns: 380px 1fr; gap:2.5rem;">
          <div class="kpi-card">
            <h3 id="formTitle">Yeni √úr√ºn Ekle</h3>
            <input type="hidden" id="editProductId">
            <div class="form-group"><label>Kategori</label>
              <select id="prodCat">
                <option value="D√ºr√ºmler">D√ºr√ºmler</option>
                <option value="Porsiyonlar">Porsiyonlar</option>
                <option value="ƒ∞√ßecekler">ƒ∞√ßecekler</option>
                <option value="Ek Paketler">Ek Paketler</option>
              </select>
            </div>
            <div class="form-group"><label>√úr√ºn Adƒ±</label><input type="text" id="prodName" placeholder="√ñr: Mega D√ºr√ºm"></div>
            <div class="form-group"><label>A√ßƒ±klama</label><input type="text" id="prodDesc" placeholder="√úr√ºn a√ßƒ±klamasƒ±"></div>
            <div class="form-group"><label>Fiyat (‚Ç∫)</label><input type="number" id="prodPrice" placeholder="0.00" step="0.01"></div>
            <div class="form-group"><label>Stok Adedi</label><input type="number" id="prodStock" value="100"></div>
            <div style="display:flex; gap:10px; margin-top: 2rem;">
                <button class="btn btn-primary" style="flex:1" onclick="handleProductSubmit()" id="btnSaveProd">Kaydet</button>
                <button class="btn hidden" style="flex:1; background:var(--bg-input)" id="btnCancelEdit" onclick="cancelProductEdit()">ƒ∞ptal</button>
            </div>
          </div>
          <div class="kpi-card">
            <h3>√úr√ºn Listesi</h3>
            <div class="filter-container">
              <input type="text" id="searchProduct" class="filter-input" placeholder="√úr√ºn ara..." onkeyup="searchProducts()">
              <select id="filterCategory" class="filter-input" onchange="filterProducts()">
                <option value="">T√ºm Kategoriler</option>
                <option value="D√ºr√ºmler">D√ºr√ºmler</option>
                <option value="Porsiyonlar">Porsiyonlar</option>
                <option value="ƒ∞√ßecekler">ƒ∞√ßecekler</option>
                <option value="Ek Paketler">Ek Paketler</option>
              </select>
            </div>
            <table id="inventoryTable">
              <thead><tr><th>√úr√ºn</th><th>Kategori</th><th>Fiyat</th><th>Stok</th><th>ƒ∞≈ülem</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Gƒ∞DER Y√ñNETƒ∞Mƒ∞ -->
      <section id="view-expenses" class="page-view hidden">
        <div style="display:grid; grid-template-columns: 380px 1fr; gap:2.5rem;">
            <div class="kpi-card">
                <h3>Gider T√ºrleri</h3>
                <div id="expTypeList" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:1.5rem;"></div>
                <hr style="margin:25px 0; border:none; height:1px; background:var(--border); opacity:0.3;">
                <h3>Gider Ekle</h3>
                <div class="form-group">
                  <label>Gider T√ºr√º</label>
                  <select id="expTypeSelect">
                    <option value="Kira">Kira</option>
                    <option value="Elektrik Faturasƒ±">Elektrik Faturasƒ±</option>
                    <option value="Su Faturasƒ±">Su Faturasƒ±</option>
                    <option value="Manav">Manav</option>
                    <option value="Mutfak Malzemesi">Mutfak Malzemesi</option>
                    <option value="Temizlik Malzemesi">Temizlik Malzemesi</option>
                    <option value="Personel">Personel</option>
                    <option value="Diƒüer">Diƒüer</option>
                  </select>
                </div>
                <div class="form-group"><label>Tutar (‚Ç∫)</label><input type="number" id="expAmount" placeholder="0.00" step="0.01"></div>
                <button class="btn btn-danger" style="width:100%; padding:14px;" onclick="addExpense()">Gideri Kaydet</button>
            </div>
            <div class="kpi-card">
                <h3>Gider Kayƒ±tlarƒ±</h3>
                <div class="filter-container">
                  <input type="date" id="expenseDateFrom" class="filter-input" onchange="filterExpenses()">
                  <input type="date" id="expenseDateTo" class="filter-input" onchange="filterExpenses()">
                  <select id="expenseTypeFilter" class="filter-input" onchange="filterExpenses()">
                    <option value="">T√ºm T√ºrler</option>
                    <option value="Kira">Kira</option>
                    <option value="Elektrik Faturasƒ±">Elektrik</option>
                    <option value="Su Faturasƒ±">Su</option>
                    <option value="Manav">Manav</option>
                    <option value="Mutfak Malzemesi">Mutfak</option>
                    <option value="Temizlik Malzemesi">Temizlik</option>
                    <option value="Personel">Personel</option>
                    <option value="Diƒüer">Diƒüer</option>
                  </select>
                </div>
                <table id="expenseTable">
                    <thead><tr><th>Tarih</th><th>T√ºr</th><th>Tutar</th><th>ƒ∞≈ülem</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
      </section>

      <!-- RAPORLAR -->
      <section id="view-dashboard" class="page-view hidden">
        <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:1.5rem; margin-bottom:2.5rem;">
            <div class="kpi-card" style="text-align:center;">
              <h5>Cƒ∞RO</h5>
              <h2 id="repTurnover" style="color:var(--primary); margin-top:10px; font-size:2.2rem;">0 ‚Ç∫</h2>
            </div>
            <div class="kpi-card" style="text-align:center;">
              <h5>Gƒ∞DER</h5>
              <h2 id="repExpense" style="color:var(--danger); margin-top:10px; font-size:2.2rem;">0 ‚Ç∫</h2>
            </div>
            <div class="kpi-card" style="text-align:center;">
              <h5>SATI≈û ADET</h5>
              <h2 id="repCount" style="margin-top:10px; font-size:2.2rem;">0</h2>
            </div>
            <div class="kpi-card" style="text-align:center;">
              <h5>NET K√ÇR</h5>
              <h2 id="repNet" style="color:var(--success); margin-top:10px; font-size:2.2rem;">0 ‚Ç∫</h2>
            </div>
        </div>
        <div class="kpi-card">
            <h3>Son Satƒ±≈ülar</h3>
            <div class="filter-container">
              <input type="date" id="salesDateFilter" class="filter-input" onchange="filterSales()">
              <select id="salesChannelFilter" class="filter-input" onchange="filterSales()">
                <option value="">T√ºm Kanallar</option>
                <option value="D√ºkkan ƒ∞√ßi">D√ºkkan ƒ∞√ßi</option>
                <option value="Telefon">Telefon</option>
                <option value="Yemeksepeti">Yemeksepeti</option>
                <option value="Getir">Getir</option>
                <option value="Trendyol Yemek">Trendyol Yemek</option>
              </select>
              <select id="salesPaymentFilter" class="filter-input" onchange="filterSales()">
                <option value="">T√ºm √ñdemeler</option>
                <option value="nakit">Nakit</option>
                <option value="kart">Kart</option>
                <option value="iban">IBAN</option>
              </select>
            </div>
            <table id="recentSalesTable">
                <thead><tr><th>Tarih</th><th>Kanal</th><th>√úr√ºnler</th><th>√ñdeme</th><th>Toplam</th><th>ƒ∞≈ülem</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
      </section>

    </main>
  </div>

  <!-- Satƒ±≈ü D√ºzenleme Modalƒ± -->
  <div id="editSaleModal" class="hidden" style="position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:1000;">
    <div class="kpi-card" style="width:90%; max-width:600px; max-height:80vh; overflow-y:auto;">
      <h3>Satƒ±≈üƒ± D√ºzenle</h3>
      <div id="editSaleContent"></div>
      <div style="display:flex; gap:10px; margin-top:2rem;">
        <button class="btn btn-primary" onclick="updateSale()">G√ºncelle</button>
        <button class="btn" onclick="closeEditModal()" style="background:var(--bg-input);">ƒ∞ptal</button>
      </div>
    </div>
  </div>

  <script>
    // HTML'den verileri al
    const DEFAULT_DATA = JSON.parse(document.getElementById('defaultData').textContent);
    const BRANCH_HASTANE_PRODUCTS = JSON.parse(document.getElementById('branchHastaneProducts').textContent);
    const BRANCH_CIHANPOL_PRODUCTS = JSON.parse(document.getElementById('branchCihanpolProducts').textContent);

    // Yedek dosya adƒ±
    const BACKUP_FILE_NAME = "cigkofte_yedek.json";
    
    // Varsayƒ±lan state yapƒ±sƒ±
    const DEFAULTS = {
        categories: DEFAULT_DATA.categories,
        expenseTypes: DEFAULT_DATA.expenseTypes,
        salesChannels: DEFAULT_DATA.salesChannels,
        theme: DEFAULT_DATA.theme,
        branches: {
            hastane: { 
              products: BRANCH_HASTANE_PRODUCTS,
              sales: [],
              expenses: []
            },
            cihanpol: { 
              products: BRANCH_CIHANPOL_PRODUCTS,
              sales: [],
              expenses: []
            }
        }
    };

    // State'i localStorage'dan al veya varsayƒ±lanlarƒ± kullan
    let state = DEFAULTS;
    let cart = [];
    let activeCat = "Hepsi";
    let activeChannel = "D√ºkkan ƒ∞√ßi";
    let editingSaleId = null;

    // TEMA Y√∂netimi
    function initTheme() {
      const savedTheme = state.theme || 'dark';
      document.documentElement.setAttribute('data-theme', savedTheme);
      document.getElementById('themeToggle').textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
      
      document.getElementById('themeToggle').addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        
        document.documentElement.setAttribute('data-theme', newTheme);
        document.getElementById('themeToggle').textContent = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        
        state.theme = newTheme;
        save();
      });
    }

    // Kaydetme fonksiyonu (sadece localStorage'a kaydeder)
    function save() {
      try {
        // localStorage'da sakla
        localStorage.setItem('cigkofte_temp', JSON.stringify(state));
        showSaveStatus('Otomatik kaydedildi', 'success');
        return true;
      } catch (e) {
        showSaveStatus('Kaydetme hatasƒ±!', 'error');
        return false;
      }
    }

    // Yedek dosyasƒ±na kaydet (MANUEL olarak √ßaƒürƒ±lacak)
    function saveToBackupFile() {
      try {
        // JSON verisini hazƒ±rla
        const jsonData = JSON.stringify(state, null, 2);
        
        // Blob olu≈ütur
        const blob = new Blob([jsonData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        // Link olu≈ütur ve tƒ±kla
        const a = document.createElement('a');
        a.href = url;
        a.download = BACKUP_FILE_NAME;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        // URL'i temizle
        URL.revokeObjectURL(url);
        
        showSaveStatus('Yedek dosyasƒ±na kaydedildi', 'success');
        return true;
      } catch (error) {
        console.error('Yedek dosyasƒ±na kaydetme hatasƒ±:', error);
        showSaveStatus('Yedek dosyasƒ±na kaydedilemedi!', 'error');
        return false;
      }
    }

    function showSaveStatus(message, type = 'success') {
      const statusEl = document.getElementById('saveStatus');
      statusEl.textContent = message;
      statusEl.style.color = type === 'error' ? 'var(--danger)' : 'var(--success)';
      setTimeout(() => {
        statusEl.textContent = '';
      }, 2000);
    }

    // Manuel kaydetme butonu - SADECE yedek dosyasƒ±na kaydet
    document.getElementById('manualSaveBtn').addEventListener('click', () => {
      saveToBackupFile();
    });

    // Yardƒ±mcƒ± fonksiyonlar
    function getBranch() { 
      return state.branches[document.getElementById('branchSelect').value]; 
    }

    // RENDER Fonksiyonlarƒ±
    function renderPOS() {
        const branch = getBranch();
        const catBar = document.getElementById('catBar');
        const posGrid = document.getElementById('posGrid');
        const channelButtons = document.getElementById('channelButtons');

        // Kategorileri render et
        let catHtml = `<div class="cat-chip ${activeCat === 'Hepsi' ? 'active' : ''}" onclick="filterCat('Hepsi')">üì¶ Hepsi</div>`;
        state.categories.forEach(c => {
            catHtml += `<div class="cat-chip ${activeCat === c ? 'active' : ''}" onclick="filterCat('${c}')">${getCategoryIcon(c)} ${c}</div>`;
        });
        catBar.innerHTML = catHtml;

        // Satƒ±≈ü kanallarƒ±nƒ± render et
        channelButtons.innerHTML = state.salesChannels.map(channel => `
            <button class="channel-btn ${activeChannel === channel ? 'active' : ''}" onclick="setActiveChannel('${channel}')">
                ${getChannelIcon(channel)} ${channel}
            </button>
        `).join('');

        // √úr√ºnleri render et
        const filtered = activeCat === 'Hepsi' ? branch.products : branch.products.filter(p => p.cat === activeCat);
        
        if (filtered.length === 0) {
          posGrid.innerHTML = `
            <div style="grid-column: 1 / -1; text-align:center; padding:3rem; color:var(--text-muted);">
              <div style="font-size:3rem; margin-bottom:1rem;">üì≠</div>
              <h3>Bu kategoride √ºr√ºn bulunamadƒ±</h3>
              <p>Yeni √ºr√ºn eklemek i√ßin √úr√ºnler sekmesine gidin</p>
            </div>
          `;
          return;
        }
        
        posGrid.innerHTML = filtered.map(p => {
          const stockText = p.stock > 0 ? `Stok: ${p.stock}` : 'Stok yok';
          const stockColor = p.stock > 20 ? 'var(--success)' : p.stock > 0 ? 'var(--warning)' : 'var(--danger)';
          
          return `
            <div class="prod-card" onclick="addToCart(${p.id})" ${p.stock === 0 ? 'style="opacity:0.6; cursor:not-allowed;"' : ''}>
                <div class="img-box">${p.icon || 'üì¶'}</div>
                <div class="info">
                    <b style="font-size:1.1rem;">${p.name}</b>
                    ${p.description ? `<div style="font-size:0.8rem; color:var(--text-muted); margin:5px 0;">${p.description}</div>` : ''}
                    <div class="price">${p.price.toFixed(2)} ‚Ç∫</div>
                    <div class="stock" style="color:${stockColor}">${stockText}</div>
                </div>
            </div>
        `}).join('');
    }

    function renderCart() {
        const container = document.getElementById('cartContainer');
        const emptyCart = document.getElementById('cartEmpty');
        let total = 0;
        
        if (cart.length === 0) {
            container.innerHTML = '';
            emptyCart.style.display = 'block';
        } else {
            emptyCart.style.display = 'none';
            container.innerHTML = cart.map((item, idx) => {
                total += item.price * item.qty;
                return `<div class="cart-item">
                    <div>
                        <b>${item.name}</b><br>
                        <small style="color:var(--text-muted);">${item.price.toFixed(2)} ‚Ç∫ x ${item.qty}</small>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removeFromCart(${idx})">Sil</button>
                </div>`;
            }).join('');
        }
        document.getElementById('cartTotal').innerText = total.toFixed(2) + " ‚Ç∫";
    }

    function renderInventory() {
        const branch = getBranch();
        
        // √úr√ºn tablosunu doldur
        const tbody = document.getElementById('inventoryTable').querySelector('tbody');
        tbody.innerHTML = branch.products.map(p => `
            <tr>
                <td><b>${p.name}</b>${p.description ? `<br><small style="color:var(--text-muted);">${p.description}</small>` : ''}</td>
                <td><span class="cat-chip" style="font-size:0.7rem; padding:4px 10px;">${p.cat}</span></td>
                <td><b style="color:var(--primary);">${p.price.toFixed(2)} ‚Ç∫</b></td>
                <td>${p.stock}</td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick="startEditProduct(${p.id})">D√ºzenle</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteProduct(${p.id})">Sil</button>
                </td>
            </tr>
        `).join('');
    }

    function renderExpenses() {
        const branch = getBranch();
        
        // Gider t√ºr√º listesini doldur
        const expTypeList = document.getElementById('expTypeList');
        expTypeList.innerHTML = state.expenseTypes.map(t => `
            <span class="cat-chip" style="font-size:0.8rem; padding:8px 15px;">
              ${getExpenseIcon(t)} ${t}
            </span>
        `).join('');
        
        // Gider tablosunu doldur (filtreleme uygulanacak)
        filterExpenses();
    }

    function renderDashboard() {
        const b = getBranch();
        const turnover = b.sales.reduce((a, s) => a + s.total, 0);
        const expense = b.expenses.reduce((a, e) => a + e.amount, 0);
        
        document.getElementById('repTurnover').innerText = turnover.toFixed(2) + " ‚Ç∫";
        document.getElementById('repExpense').innerText = expense.toFixed(2) + " ‚Ç∫";
        document.getElementById('repCount').innerText = b.sales.length;
        document.getElementById('repNet').innerText = (turnover - expense).toFixed(2) + " ‚Ç∫";

        // Satƒ±≈ülar tablosunu doldur (filtreleme uygulanacak)
        filterSales();
    }

    // Yardƒ±mcƒ± fonksiyonlar
    function getCategoryIcon(category) {
      const icons = {
        'D√ºr√ºmler': 'üåØ',
        'Porsiyonlar': 'ü•ô',
        'ƒ∞√ßecekler': 'ü•§',
        'Ek Paketler': 'üßÄ'
      };
      return icons[category] || 'üì¶';
    }

    function getExpenseIcon(type) {
      const icons = {
        'Kira': 'üè†',
        'Elektrik Faturasƒ±': 'üí°',
        'Su Faturasƒ±': 'üíß',
        'Manav': 'ü•¶',
        'Mutfak Malzemesi': 'üî™',
        'Temizlik Malzemesi': 'üßπ',
        'Personel': 'üë•',
        'Diƒüer': 'üì¶'
      };
      return icons[type] || 'üí∞';
    }

    function getChannelIcon(channel) {
      const icons = {
        'D√ºkkan ƒ∞√ßi': 'üè™',
        'Telefon': 'üìû',
        'Yemeksepeti': 'üõµ',
        'Getir': '‚ö°',
        'Trendyol Yemek': 'üì±'
      };
      return icons[channel] || 'üè™';
    }

    // SEPET ƒ∞≈ülemleri
    function filterCat(c) { 
      activeCat = c; 
      renderPOS(); 
    }
    
    function setActiveChannel(channel) {
      activeChannel = channel;
      renderPOS();
    }
    
    function addToCart(id) {
        const p = getBranch().products.find(x => x.id === id);
        if(!p || p.stock <= 0) {
          alert('Bu √ºr√ºn stokta yok!');
          return;
        }
        const exist = cart.find(c => c.id === id);
        if(exist) {
          exist.qty++;
        } else {
          cart.push({...p, qty: 1});
        }
        renderCart();
    }
    
    function removeFromCart(idx) {
      cart.splice(idx, 1);
      renderCart();
    }

    function doCheckout(method) {
        if(cart.length === 0) {
          alert('Sepet bo≈ü!');
          return;
        }
        
        const b = getBranch();
        const total = cart.reduce((a, c) => a + (c.price * c.qty), 0);
        
        // Stok kontrol√º ve g√ºncelleme
        cart.forEach(item => {
            const p = b.products.find(x => x.id === item.id);
            if(p) {
              p.stock -= item.qty;
            }
        });

        // Satƒ±≈üƒ± kaydet
        b.sales.push({ 
          id: Date.now(),
          date: new Date().toISOString(), 
          items: [...cart], 
          total, 
          method,
          channel: activeChannel
        });
        
        // Sepeti temizle
        cart = [];
        
        // Kaydet ve render et
        save();
        renderCart();
        renderPOS();
        renderDashboard();
        
        alert(`${total.toFixed(2)} ‚Ç∫ tutarƒ±ndaki satƒ±≈ü kaydedildi!`);
    }

    // SATI≈û D√ºzenleme
    function openEditSale(saleId) {
      const b = getBranch();
      const sale = b.sales.find(s => s.id === saleId);
      if (!sale) return;
      
      editingSaleId = saleId;
      const modal = document.getElementById('editSaleModal');
      const content = document.getElementById('editSaleContent');
      
      let html = `
        <div style="margin-bottom:1.5rem;">
          <div style="color:var(--text-muted); font-size:0.9rem;">Tarih: ${new Date(sale.date).toLocaleString()}</div>
          <div style="color:var(--text-muted); font-size:0.9rem; margin-top:5px;">Kanal: ${sale.channel}</div>
        </div>
        
        <div style="margin-bottom:1.5rem;">
          <label>√ñdeme Y√∂ntemi</label>
          <select id="editSaleMethod" style="margin-top:5px;">
            <option value="nakit" ${sale.method === 'nakit' ? 'selected' : ''}>Nakit</option>
            <option value="kart" ${sale.method === 'kart' ? 'selected' : ''}>Kart</option>
            <option value="iban" ${sale.method === 'iban' ? 'selected' : ''}>IBAN</option>
          </select>
        </div>
        
        <div style="margin-bottom:1.5rem;">
          <label>Satƒ±≈ü Kanalƒ±</label>
          <select id="editSaleChannel" style="margin-top:5px;">
      `;
      
      state.salesChannels.forEach(channel => {
        html += `<option value="${channel}" ${sale.channel === channel ? 'selected' : ''}>${channel}</option>`;
      });
      
      html += `
          </select>
        </div>
        
        <div>
          <label>√úr√ºnler</label>
          <div style="margin-top:10px; padding:10px; background:var(--bg-input); border-radius:var(--radius-sm);">
      `;
      
      sale.items.forEach((item, idx) => {
        html += `
          <div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid var(--border);">
            <div>
              <b>${item.name}</b><br>
              <small style="color:var(--text-muted);">${item.price} ‚Ç∫ x ${item.qty} = ${(item.price * item.qty).toFixed(2)} ‚Ç∫</small>
            </div>
            <div style="display:flex; gap:5px;">
              <button class="btn btn-sm" onclick="updateSaleItemQty(${idx}, -1)">-</button>
              <span style="min-width:30px; text-align:center;">${item.qty}</span>
              <button class="btn btn-sm" onclick="updateSaleItemQty(${idx}, 1)">+</button>
              <button class="btn btn-sm btn-danger" onclick="removeSaleItem(${idx})">Sil</button>
            </div>
          </div>
        `;
      });
      
      html += `
          </div>
          <div style="margin-top:15px; text-align:right; font-size:1.2rem; font-weight:bold;">
            Toplam: ${sale.total.toFixed(2)} ‚Ç∫
          </div>
        </div>
      `;
      
      content.innerHTML = html;
      modal.classList.remove('hidden');
    }
    
    function updateSaleItemQty(itemIdx, change) {
      const b = getBranch();
      const sale = b.sales.find(s => s.id === editingSaleId);
      if (!sale) return;
      
      const item = sale.items[itemIdx];
      const newQty = item.qty + change;
      
      if (newQty < 1) {
        sale.items.splice(itemIdx, 1);
      } else {
        item.qty = newQty;
      }
      
      // Toplamƒ± yeniden hesapla
      sale.total = sale.items.reduce((sum, item) => sum + (item.price * item.qty), 0);
      
      // Modalƒ± g√ºncelle
      openEditSale(editingSaleId);
    }
    
    function removeSaleItem(itemIdx) {
      const b = getBranch();
      const sale = b.sales.find(s => s.id === editingSaleId);
      if (!sale) return;
      
      sale.items.splice(itemIdx, 1);
      
      // Toplamƒ± yeniden hesapla
      sale.total = sale.items.reduce((sum, item) => sum + (item.price * item.qty), 0);
      
      // Modalƒ± g√ºncelle
      openEditSale(editingSaleId);
    }
    
    function updateSale() {
      const b = getBranch();
      const sale = b.sales.find(s => s.id === editingSaleId);
      if (!sale) return;
      
      sale.method = document.getElementById('editSaleMethod').value;
      sale.channel = document.getElementById('editSaleChannel').value;
      
      save();
      closeEditModal();
      renderDashboard();
      alert('Satƒ±≈ü g√ºncellendi!');
    }
    
    function closeEditModal() {
      document.getElementById('editSaleModal').classList.add('hidden');
      editingSaleId = null;
    }

    // √úR√úN Y√∂netimi
    function startEditProduct(id) {
        const p = getBranch().products.find(x => x.id === id);
        if(!p) return;
        document.getElementById('editProductId').value = p.id;
        document.getElementById('prodName').value = p.name;
        document.getElementById('prodDesc').value = p.description || '';
        document.getElementById('prodPrice').value = p.price;
        document.getElementById('prodStock').value = p.stock;
        document.getElementById('prodCat').value = p.cat;
        
        document.getElementById('formTitle').innerText = "√úr√ºn√º G√ºncelle";
        document.getElementById('btnSaveProd').innerText = "G√ºncelle";
        document.getElementById('btnCancelEdit').classList.remove('hidden');
    }

    function cancelProductEdit() {
        document.getElementById('editProductId').value = "";
        document.getElementById('prodName').value = "";
        document.getElementById('prodDesc').value = "";
        document.getElementById('prodPrice').value = "";
        document.getElementById('prodStock').value = "100";
        document.getElementById('formTitle').innerText = "Yeni √úr√ºn Ekle";
        document.getElementById('btnSaveProd').innerText = "Kaydet";
        document.getElementById('btnCancelEdit').classList.add('hidden');
    }

    function handleProductSubmit() {
        const id = document.getElementById('editProductId').value;
        const name = document.getElementById('prodName').value.trim();
        const description = document.getElementById('prodDesc').value.trim();
        const price = parseFloat(document.getElementById('prodPrice').value);
        const stock = parseInt(document.getElementById('prodStock').value);
        const cat = document.getElementById('prodCat').value;

        if(!name || isNaN(price)) {
          alert('L√ºtfen ge√ßerli bir √ºr√ºn adƒ± ve fiyat giriniz!');
          return;
        }
        
        const b = getBranch();

        if(id) {
            // G√ºncelleme
            const p = b.products.find(x => x.id == id);
            if(p) { 
              p.name = name; 
              p.description = description;
              p.price = price; 
              p.stock = stock; 
              p.cat = cat;
              p.icon = p.icon || getCategoryIcon(cat);
            }
        } else {
            // Yeni √ºr√ºn
            const newId = Date.now();
            b.products.push({ 
              id: newId, 
              name, 
              description,
              price, 
              stock, 
              cat,
              icon: getCategoryIcon(cat)
            });
        }
        
        save();
        cancelProductEdit();
        renderInventory();
        renderPOS();
    }

    function deleteProduct(id) {
        if(!confirm("Bu √ºr√ºn√º silmek istediƒüinize emin misiniz?")) return;
        const b = getBranch();
        b.products = b.products.filter(p => p.id !== id);
        save();
        renderInventory();
        renderPOS();
    }

    // Filtreleme fonksiyonlarƒ±
    function filterProducts() {
      const searchTerm = document.getElementById('searchProduct').value.toLowerCase();
      const categoryFilter = document.getElementById('filterCategory').value;
      const rows = document.querySelectorAll('#inventoryTable tbody tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const category = row.cells[1].textContent;
        
        const matchesSearch = text.includes(searchTerm);
        const matchesCategory = !categoryFilter || category.includes(categoryFilter);
        
        row.style.display = matchesSearch && matchesCategory ? '' : 'none';
      });
    }
    
    function searchProducts() {
      filterProducts();
    }

    function filterExpenses() {
      const b = getBranch();
      const dateFrom = document.getElementById('expenseDateFrom').value;
      const dateTo = document.getElementById('expenseDateTo').value;
      const typeFilter = document.getElementById('expenseTypeFilter').value;
      
      let filtered = [...b.expenses];
      
      if (dateFrom) {
        filtered = filtered.filter(e => e.date >= dateFrom + 'T00:00:00');
      }
      
      if (dateTo) {
        filtered = filtered.filter(e => e.date <= dateTo + 'T23:59:59');
      }
      
      if (typeFilter) {
        filtered = filtered.filter(e => e.type.includes(typeFilter));
      }
      
      const tbody = document.getElementById('expenseTable').querySelector('tbody');
      tbody.innerHTML = filtered.reverse().map((e, idx) => `
          <tr>
              <td><small>${new Date(e.date).toLocaleDateString('tr-TR')}</small></td>
              <td><b>${e.type}</b></td>
              <td style="color:var(--danger); font-weight:700;">-${e.amount.toFixed(2)} ‚Ç∫</td>
              <td><button class="btn btn-sm btn-danger" onclick="deleteExpense(${b.expenses.findIndex(exp => exp.date === e.date)})">Sil</button></td>
          </tr>
      `).join('');
    }

    function filterSales() {
      const b = getBranch();
      const dateFilter = document.getElementById('salesDateFilter').value;
      const channelFilter = document.getElementById('salesChannelFilter').value;
      const paymentFilter = document.getElementById('salesPaymentFilter').value;
      
      let filtered = [...b.sales];
      
      if (dateFilter) {
        filtered = filtered.filter(s => s.date.startsWith(dateFilter));
      }
      
      if (channelFilter) {
        filtered = filtered.filter(s => s.channel === channelFilter);
      }
      
      if (paymentFilter) {
        filtered = filtered.filter(s => s.method === paymentFilter);
      }
      
      const tbody = document.getElementById('recentSalesTable').querySelector('tbody');
      tbody.innerHTML = filtered.reverse().slice(0, 20).map(s => `
          <tr>
              <td><small>${new Date(s.date).toLocaleTimeString()}</small></td>
              <td><span class="cat-chip" style="font-size:0.6rem; padding:4px 8px;">${s.channel}</span></td>
              <td>${s.items.map(i => i.name).join(', ')}</td>
              <td><span class="cat-chip" style="font-size:0.6rem; padding:4px 8px;">${s.method.toUpperCase()}</span></td>
              <td><b>${s.total.toFixed(2)} ‚Ç∫</b></td>
              <td><button class="btn btn-sm btn-warning" onclick="openEditSale(${s.id})">D√ºzenle</button></td>
          </tr>
      `).join('');
    }

    // Gƒ∞DER Y√∂netimi
    function addExpense() {
        const type = document.getElementById('expTypeSelect').value;
        const amount = parseFloat(document.getElementById('expAmount').value);
        
        if(!type || isNaN(amount) || amount <= 0) {
          alert('L√ºtfen ge√ßerli bir gider t√ºr√º ve tutar giriniz!');
          return;
        }
        
        getBranch().expenses.push({ 
          date: new Date().toISOString(), 
          type, 
          amount
        });
        
        save();
        renderExpenses();
        renderDashboard();
        
        document.getElementById('expAmount').value = "";
    }

    function deleteExpense(idx) {
        if(!confirm("Bu gider kaydƒ±nƒ± silmek istediƒüinize emin misiniz?")) return;
        getBranch().expenses.splice(idx, 1);
        save();
        renderExpenses();
        renderDashboard();
    }

    // Sƒ∞STEM ƒ∞≈ülemleri
    document.querySelectorAll('.nav-item').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const view = btn.dataset.view;
            document.querySelectorAll('.page-view').forEach(v => v.classList.add('hidden'));
            document.getElementById(`view-${view}`).classList.remove('hidden');
            
            // ƒ∞lgili sayfayƒ± render et
            if(view === 'inventory') renderInventory();
            if(view === 'expenses') renderExpenses();
            if(view === 'dashboard') renderDashboard();
            if(view === 'pos') renderPOS();
        });
    });

    document.getElementById('branchSelect').addEventListener('change', () => {
        const name = document.getElementById('branchSelect').options[document.getElementById('branchSelect').selectedIndex].text;
        document.getElementById('currentBranchName').innerText = `| ${name}`;
        cart = []; // ≈ûube deƒüi≈üince sepeti temizle
        renderPOS();
        renderInventory();
        renderExpenses();
        renderDashboard();
        renderCart();
    });

    // Uygulama Ba≈ülangƒ±cƒ±
    window.onload = () => {
        document.getElementById('currentBranchName').innerText = "| Hastane ≈ûubesi";
        
        // Verileri localStorage'dan y√ºkle (eƒüer varsa)
        try {
          const savedData = localStorage.getItem('cigkofte_temp');
          if (savedData) {
            const parsedData = JSON.parse(savedData);
            if (parsedData && parsedData.branches) {
              // Varsayƒ±lan verilerle birle≈ütir
              state = {
                ...DEFAULTS,
                ...parsedData,
                branches: {
                  hastane: { 
                    ...DEFAULTS.branches.hastane,
                    ...parsedData.branches.hastane,
                    products: [...BRANCH_HASTANE_PRODUCTS, ...(parsedData.branches?.hastane?.products || [])]
                      .filter((v, i, a) => a.findIndex(t => t.id === v.id) === i)
                  },
                  cihanpol: { 
                    ...DEFAULTS.branches.cihanpol,
                    ...parsedData.branches.cihanpol,
                    products: [...BRANCH_CIHANPOL_PRODUCTS, ...(parsedData.branches?.cihanpol?.products || [])]
                      .filter((v, i, a) => a.findIndex(t => t.id === v.id) === i)
                  }
                }
              };
              console.log('Veriler localStorage\'dan y√ºklendi');
            }
          }
        } catch (error) {
          console.log('localStorage\'dan veri y√ºklenemedi, varsayƒ±lan veriler kullanƒ±lƒ±yor');
        }
        
        // Tema ba≈ülat
        initTheme();
        
        // ƒ∞lk render
        renderPOS();
        renderCart();
        renderExpenses();
    };
  </script>
</body>
</html>
