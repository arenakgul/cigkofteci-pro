<!DOCTYPE html>
<html lang="tr" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <!-- Android tablet iÃ§in daha saÄŸlÄ±klÄ± viewport (pinch-zoom aÃ§Ä±k) -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#871918" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />

  <title>Ã‡iÄŸ KÃ¶fteci Mahsum Usta | YÃ¶netim Paneli</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Google Identity Services (GIS) -->
  <script src="https://accounts.google.com/gsi/client" async defer onload="window.__GIS_LOADED__ && window.__GIS_LOADED__()"></script>

<style>
    :root{
      --font:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      --r:18px;
      --rs:12px;
      --t:.18s ease;

      /* LOGO ANA RENK: #871918 */
      --primary:#871918;
      --primary-2:#a11c1b;
      --primary-3:#661111;

      /* DÃ¼z (flat) modern zeminler */
      --bg:#0f0b0b;
      --panel:#171011;
      --panel2:#1f1617;
      --input:#241a1b;
      --border:rgba(255,255,255,.10);

      --text:#fbfbfc;
      --muted:rgba(251,251,252,.65);

      --accent:#f5d0cd;
      --price:#ffd166;
      --price-bg:rgba(255,209,102,.16);
      --price-bd:rgba(255,209,102,.35);
      --success:#22c55e;
      --warning:#f59e0b;
      --danger:#ef4444;

      --shadow:0 14px 40px rgba(0,0,0,.40);
      --shadow2:0 10px 26px rgba(0,0,0,.32);
      --focus:0 0 0 4px rgba(135,25,24,.20);
    }

    html[data-theme="light"]{
      --bg:#fbf7f6;
      --panel:#ffffff;
      --panel2:#fff6f6;
      --input:#f4ecec;
      --border:rgba(20,11,11,.10);

      --text:#140b0b;
      --muted:rgba(20,11,11,.62);

      --price:#b45309;
      --price-bg:rgba(180,83,9,.12);
      --price-bd:rgba(180,83,9,.22);

      --shadow:0 12px 35px rgba(15,20,25,.10);
      --shadow2:0 10px 22px rgba(15,20,25,.08);
      --focus:0 0 0 4px rgba(135,25,24,.18);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      background:var(--bg);
      color:var(--text);
      overflow-x:hidden;
      -webkit-tap-highlight-color: transparent; /* Android dokunma highlight azalt */
    }

    /* Android dokunma iÃ§in: yanlÄ±ÅŸlÄ±kla zoom/Ã§ift tÄ±k davranÄ±ÅŸÄ±nÄ± azaltÄ±r */
    button, .btn, .nav-item, .chip, .channel-btn, .product { touch-action: manipulation; }

    .hidden{display:none !important}
    .row{display:flex; gap:10px; align-items:center}
    .muted{color:var(--muted)}
    .pill{border-radius:999px}

    /* Layout */
    .app{display:flex; min-height:100vh;
      height:100dvh;}
    .main{flex:1; padding:16px; min-width:0;}

    /* Sidebar */
    .sidebar{
      width:285px;
      padding:18px;
      border-right:1px solid var(--border);
      background:var(--panel);
      position:sticky;
      top:0;
      height:100vh;
      height:100dvh;
      display:flex;
      flex-direction:column;
      gap:14px;
      z-index:50;
    }

    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:46px; height:46px;
      border-radius:14px;
      background:rgba(135,25,24,.14);
      border:1px solid rgba(135,25,24,.35);
      display:grid; place-items:center;
      overflow:hidden;
      box-shadow:var(--shadow2);
      flex:0 0 auto;
    }
    .logo img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .brand b{display:block; font-size:15px; letter-spacing:.2px;}
    .brand span{display:block; font-size:12px; color:var(--muted); margin-top:2px;}

    .box{
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:var(--r);
      padding:12px;
    }

    select,input,button,textarea{
      font-family:inherit;
      font-size:14px;
      outline:none;
    }
    select,input,textarea{
      width:100%;
      padding:10px 12px;
      background:var(--input);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:14px;
      transition:var(--t);
    }
    select:focus,input:focus,textarea:focus{box-shadow:var(--focus); border-color:rgba(135,25,24,.45);}

    /* Nav */
    .nav{display:flex; flex-direction:column; gap:10px;}
    .nav-item{
      display:flex;
      gap:12px;
      align-items:center;
      width:100%;
      padding:12px;
      border-radius:var(--r);
      background:transparent;
      border:1px solid transparent;
      color:var(--text);
      cursor:pointer;
      transition:var(--t);
      text-align:left;
    }
    .nav-item:hover{
      background:rgba(255,255,255,.03);
      border-color:var(--border);
      transform:translateY(-1px);
    }
    .nav-item.active{
      background:rgba(135,25,24,.12);
      border-color:rgba(135,25,24,.35);
      box-shadow:var(--shadow2);
    }
    .ico{
      width:40px; height:40px;
      border-radius:14px;
      display:grid; place-items:center;
      background:rgba(255,255,255,.03);
      border:1px solid var(--border);
      flex:0 0 auto;
      font-size:18px;
    }
    .nav-item.active .ico{
      background:rgba(135,25,24,.12);
      border-color:rgba(135,25,24,.35);
    }

    .sidebar-footer{margin-top:auto; display:flex; flex-direction:column; gap:10px;}
    #saveStatus{font-size:12px; min-height:16px;}

    /* Buttons */
    .btn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition:var(--t);
      user-select:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.05);}
    .btn:active{transform:translateY(0);}

    .btn-primary{
      background:var(--primary);
      border-color:rgba(0,0,0,0);
      color:#fff;
      font-weight:800;
    }
    .btn-primary:hover{background:var(--primary-2);}

    .btn-danger{background:rgba(239,68,68,.12); border-color:rgba(239,68,68,.35); color:#ffd6d6; font-weight:800;}
    .btn-warning{background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.35); color:#ffe7be; font-weight:800;}
    .btn-success{background:rgba(34,197,94,.12); border-color:rgba(34,197,94,.35); color:#c8ffd9; font-weight:800;}

    .btn-sm{padding:8px 10px; border-radius:12px; font-size:13px;}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none;}

    /* Topbar */
    .topbar{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--r);
      padding:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      box-shadow:var(--shadow2);
      margin-bottom:14px;
    }
    .topbar h1{
      font-size:16px;
      margin:0;
      letter-spacing:.2px;
    }
    .topbar h1 span{font-size:12px; color:var(--muted); font-weight:600; margin-left:8px;}

    /* Panels */
    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--r);
      padding:14px;
      box-shadow:var(--shadow2);
      min-width:0;
    }
    .panel h2{
      margin:0 0 10px 0;
      font-size:14px;
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
    }

    /* === Kategori/Kanal BarÄ±: kayma fix === */
    .category-scroll{
      display:flex;
      align-items:center;
      gap:8px;

      flex-wrap:nowrap;
      overflow-x:auto;
      overflow-y:hidden;
      white-space:nowrap;

      -webkit-overflow-scrolling:touch;
      scrollbar-gutter:stable;
      padding:2px 2px 8px 2px;
    }
    .category-scroll::-webkit-scrollbar{height:8px}
    .category-scroll::-webkit-scrollbar-thumb{
      background:rgba(255,255,255,.18);
      border-radius:999px;
    }
    .category-scroll::-webkit-scrollbar-track{background:transparent}

    /* Chips */
    .chip, .channel-btn{
      flex:0 0 auto;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;

      height:40px;
      padding:0 14px;

      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
      transition:var(--t);
      user-select:none;
      font-size:13px;
      white-space:nowrap;

      line-height:1;
      vertical-align:middle;
    }
    .chip:hover,.channel-btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.05);}
    .chip.active,.channel-btn.active{
      background:rgba(135,25,24,.12);
      border-color:rgba(135,25,24,.35);
      box-shadow:var(--shadow2);
    }

    /* POS layout */
    .content-grid{
      display:grid;
      grid-template-columns:1.7fr 1fr;
      gap:14px;
      align-items:start;
    }
    .pos-tools{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:flex-start;
    }

    /* POS grid: auto-fit */
    .product-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(170px, 1fr));
      gap:12px;
      margin-top:10px;
    }
    .product{
      border:1px solid var(--border);
      background:var(--panel2);
      border-radius:var(--r);
      padding:14px;
      cursor:pointer;
      transition:var(--t);
      display:flex;
      gap:12px;
      align-items:center;
      min-height:82px;
    }
    .product:hover{
      transform:translateY(-2px);
      border-color:rgba(135,25,24,.30);
      box-shadow:var(--shadow2);
    }
    .pico{
      width:46px; height:46px;
      border-radius:16px;
      display:grid; place-items:center;
      background:rgba(135,25,24,.12);
      border:1px solid rgba(135,25,24,.20);
      font-size:22px;
      flex:0 0 auto;
    }
    .pname{
      display:block;
      font-size:clamp(.95rem, 2.8vw, 1.05rem);
      line-height:1.15;
      font-weight:900;
      word-break:break-word;
    }
    .price{
      font-weight:950;
      color:var(--price);
      margin-top:6px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:var(--price-bg);
      border:1px solid var(--price-bd);
      width:fit-content;
    }
    .stock{font-size:12px; color:var(--muted); margin-top:6px;}

    /* Cart */
    .cart-box{position:sticky; top:16px;}
    .cart-empty{
      padding:12px;
      border-radius:var(--r);
      border:1px dashed var(--border);
      color:var(--muted);
      text-align:center;
    }
    .cart-item{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:12px 0;
      border-bottom:1px solid var(--border);
    }
    .cart-summary{
      display:flex; justify-content:space-between; align-items:center;
      padding-top:12px; margin-top:12px;
      border-top:1px solid var(--border);
    }
    .cart-total{font-size:18px; font-weight:950; color:var(--price);}
    .pay-row{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}

    /* Cards */
    .cards{display:grid; grid-template-columns:repeat(auto-fit, minmax(170px, 1fr)); gap:12px;}
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--r);
      padding:14px;
      box-shadow:var(--shadow2);
    }
    .card .label{font-size:12px; color:var(--muted)}
    .card .value{font-size:20px; font-weight:950; margin-top:6px;}
    /* Para deÄŸerlerini daha belirgin yap */
    #repTurnover{color:var(--price);}
    #repExpense{color:var(--warning);}
    #repNet{color:var(--success);}

    /* Tables */
    table{
      width:100%;
      border-collapse:collapse;
      border-radius:16px;
      overflow:hidden;
      border:1px solid var(--border);
      background:rgba(255,255,255,.02);
    }
    th,td{padding:12px 10px; border-bottom:1px solid var(--border); font-size:12px; text-align:left; vertical-align:top;}
    th{color:var(--muted); font-weight:900; text-transform:uppercase; font-size:11px; letter-spacing:.3px; background:rgba(255,255,255,.03)}
    tr:last-child td{border-bottom:none}

    /* Pages */
    .page-view{display:none;}
    .page-view.active{display:block;}

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:999;
    }
    .modal{
      width:min(720px, 100%);
      border-radius:22px;
      border:1px solid var(--border);
      background:var(--panel);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modal-head{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modal-head b{font-size:14px}
    .modal-body{padding:14px 16px;}
    .modal-foot{
      padding:14px 16px;
      border-top:1px solid var(--border);
      display:flex;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }

    /* Mobile sidebar overlay */
    .sb-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      z-index:998;
    }

    /* iOS input zoom engeli + mobil rahatlÄ±k */
    @media (max-width: 560px){
      select,input,textarea{font-size:16px;}
      .product{padding:12px; min-height:74px; align-items:flex-start;}
      .pico{width:42px; height:42px; border-radius:14px; font-size:20px;}
      .main{padding:12px; padding-bottom:calc(12px + env(safe-area-inset-bottom));}
      .topbar{position:sticky; top:8px; z-index:60;}
    }

    /* Responsive */
    @media (max-width: 1180px){
      .product-grid{grid-template-columns:repeat(auto-fit, minmax(170px, 1fr));}
      .content-grid{grid-template-columns:1.4fr 1fr;}
    }
    @media (max-width: 980px){
      .cards{grid-template-columns:repeat(2, minmax(0,1fr));}
      .content-grid{grid-template-columns:1fr;}
      .cart-box{position:relative; top:auto;}
    }
    @media (max-width: 840px){
      .sidebar{
        position:fixed;
        left:-320px;
        top:0;
        height:100vh;
        height:100dvh;
        z-index:999;
        transition:var(--t);
        box-shadow:var(--shadow);
      }
      .sidebar.open{left:0;}
      .main{padding:12px;}
    }
    @media (max-width: 560px){
      .product-grid{grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));}
    }
    @media (max-width: 420px){
      .product-grid{grid-template-columns:1fr;}
    }

    /* Sync panel */
    .sync-row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .sync-pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
    }
    .sync-ok{color:var(--success); border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.10);}
    .sync-warn{color:var(--warning); border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.10);}
    .sync-bad{color:var(--danger); border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.10);}
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div class="logo" title="Logo">
          <img src="logo.png" alt="Ã‡iÄŸ KÃ¶fteci Mahsum Usta">
        </div>
        <div>
          <b>Ã‡iÄŸ KÃ¶fteci Mahsum Usta</b>
          <span>YÃ¶netim Paneli</span>
        </div>
      </div>

      <div class="box">
        <div class="muted" style="font-size:12px; margin-bottom:8px;">Åube SeÃ§</div>
        <select id="branchSelect">
          <option value="hastane">Hastane Åubesi</option>
          <option value="cihanpol">Cihanpol Åubesi</option>
        </select>
      </div>

      <div class="nav">
        <button class="nav-item active" data-view="pos" type="button">
          <div class="ico">ğŸ§¾</div>
          <div><b>SatÄ±ÅŸ</b><br><span class="muted" style="font-size:12px;">POS ekranÄ±</span></div>
        </button>
        <button class="nav-item" data-view="dashboard" type="button">
          <div class="ico">ğŸ“ˆ</div>
          <div><b>Rapor</b><br><span class="muted" style="font-size:12px;">GÃ¼nlÃ¼k/Genel</span></div>
        </button>
        <button class="nav-item" data-view="inventory" type="button">
          <div class="ico">ğŸ“¦</div>
          <div><b>ÃœrÃ¼nler</b><br><span class="muted" style="font-size:12px;">Stok yÃ¶netimi</span></div>
        </button>
        <button class="nav-item" data-view="expenses" type="button">
          <div class="ico">ğŸ§¾</div>
          <div><b>Gider</b><br><span class="muted" style="font-size:12px;">Gider kaydÄ±</span></div>
        </button>
      </div>

      <div class="sidebar-footer">
        <div class="box">
          <div class="row" style="justify-content:space-between;">
            <div>
              <div class="muted" style="font-size:12px;">Tema</div>
              <div style="font-weight:900;">KaranlÄ±k / AydÄ±nlÄ±k</div>
            </div>
            <button class="btn btn-sm" id="themeToggle" type="button">ğŸŒ™</button>
          </div>
        </div>

        <!-- LIVE SYNC -->
        <div class="box" id="syncBox">
          <div class="muted" style="font-size:12px; margin-bottom:8px;">CanlÄ± Senkron (Google Sheets)</div>
          <div class="sync-row" style="margin-bottom:8px;">
            <span id="syncPill" class="sync-pill sync-warn">â³ HazÄ±rlanÄ±yorâ€¦</span>
            <span id="syncLast" class="sync-pill">Son: -</span>
          </div>
          <div class="sync-row">
            <button class="btn btn-sm btn-primary" id="btnGoogleConnect" type="button">ğŸ” Google BaÄŸlan</button>
            <button class="btn btn-sm" id="btnSyncPull" type="button">â¬‡ï¸ Ã‡ek</button>
            <button class="btn btn-sm" id="btnSyncPush" type="button">â¬†ï¸ GÃ¶nder</button>
          </div>
          <div class="muted" style="font-size:11px; margin-top:8px;" id="syncHint">
            Not: Uygulama â€œTestingâ€ modundaysa sadece Test Users giriÅŸ yapabilir.
          </div>
        </div>

        <div class="box">
          <div class="muted" style="font-size:12px; margin-bottom:8px;">Yedek</div>
          <div class="row">
            <button class="btn btn-sm" id="btnExport" type="button">â¬‡ï¸ Yedek Al</button>
            <button class="btn btn-sm" id="btnImport" type="button">â¬†ï¸ YedeÄŸi YÃ¼kle</button>
            <input type="file" id="importFile" accept="application/json" class="hidden">
          </div>
          <div id="saveStatus" class="muted" style="margin-top:8px;"></div>
        </div>

        <div class="box">
          <div class="muted" style="font-size:11px;">
            Veri KaynaÄŸÄ±: <b id="dataSourceLabel">-</b>
          </div>
        </div>
      </div>
    </aside>

    <div id="sbOverlay" class="sb-overlay hidden" onclick="toggleSidebar(true)"></div>

    <main class="main">
      <div class="topbar">
        <h1>
          Ã‡iÄŸ KÃ¶fteci Mahsum Usta
          <span id="activeBranchLabel" class="muted"></span>
          <span id="dataSourceTop" style="font-size:12px; color:var(--muted); font-weight:600; margin-left:8px;"></span>
        </h1>
        <div class="row">
          <button class="btn" type="button" onclick="toggleSidebar()">â˜° MenÃ¼</button>
        </div>
      </div>

      <!-- POS -->
      <section class="page-view active" id="view-pos">
        <div class="content-grid">
          <div class="panel">
            <h2>
              <span>ÃœrÃ¼nler</span>
              <span class="muted" style="font-size:12px;">Sepete ekle</span>
            </h2>

            <div class="pos-tools">
              <div style="flex:1; min-width:220px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Kategori</div>
                <div class="category-scroll" id="catBar"></div>
              </div>
              <div style="flex:1; min-width:220px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">SatÄ±ÅŸ KanalÄ±</div>
                <div class="category-scroll" id="channelButtons"></div>
              </div>
            </div>

            <div class="product-grid" id="posGrid"></div>
          </div>

          <div class="panel cart-box">
            <h2>
              <span>Sepet</span>
              <span class="muted" style="font-size:12px;">Ã–deme al</span>
            </h2>

            <div id="cartList"></div>

            <div class="cart-summary">
              <div class="muted">Toplam</div>
              <div class="cart-total" id="cartTotal">0.00 â‚º</div>
            </div>

            <div style="margin-top:14px;">
              <div class="muted" style="font-size:12px; margin-bottom:8px;">Ã–deme YÃ¶ntemi</div>
              <div class="pay-row" id="payButtons"></div>
            </div>

            <div class="row" style="margin-top:12px;">
              <button class="btn btn-danger" type="button" onclick="clearCart()">ğŸ§¹ Temizle</button>
              <button class="btn btn-primary" type="button" onclick="checkout()">âœ… SatÄ±ÅŸÄ± Kaydet</button>
            </div>
          </div>
        </div>
      </section>

      <!-- DASHBOARD -->
      <section class="page-view" id="view-dashboard">
        <div class="panel" style="margin-bottom:14px;">
          <h2>
            <span>Ã–zet</span>
            <span class="muted" style="font-size:12px;">Ciro / Gider / Net</span>
          </h2>

          <div class="cards">
            <div class="card">
              <div class="label">Toplam Ciro</div>
              <div class="value" id="repTurnover">0.00 â‚º</div>
            </div>
            <div class="card">
              <div class="label">Toplam Gider</div>
              <div class="value" id="repExpense">0.00 â‚º</div>
            </div>
            <div class="card">
              <div class="label">SatÄ±ÅŸ Adedi</div>
              <div class="value" id="repCount">0</div>
            </div>
            <div class="card">
              <div class="label">Net</div>
              <div class="value" id="repNet">0.00 â‚º</div>
            </div>
          </div>
        </div>

        <div class="panel">
          <h2>
            <span>SatÄ±ÅŸlar</span>
            <span class="muted" style="font-size:12px;">DÃ¼zenle/Sil</span>
          </h2>

          <div class="row" style="flex-wrap:wrap; gap:12px; margin-bottom:12px;">
            <div style="flex:1; min-width:220px;">
              <div class="muted" style="font-size:12px; margin-bottom:6px;">Tarih</div>
              <input type="date" id="salesDateFilter" onchange="filterSales()">
            </div>
            <div style="flex:1; min-width:220px;">
              <div class="muted" style="font-size:12px; margin-bottom:6px;">Kanal</div>
              <select id="salesChannelFilter" onchange="filterSales()"></select>
            </div>
            <div style="flex:1; min-width:220px;">
              <div class="muted" style="font-size:12px; margin-bottom:6px;">Ara</div>
              <input id="salesSearch" placeholder="ÃœrÃ¼n/kanal/ID ara..." oninput="filterSales()">
            </div>
          </div>

          <div style="overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th>Tarih</th>
                  <th>Kanal</th>
                  <th>Ã–deme</th>
                  <th>Toplam</th>
                  <th>ÃœrÃ¼nler</th>
                  <th>Ä°ÅŸlem</th>
                </tr>
              </thead>
              <tbody id="salesTable"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- INVENTORY -->
      <section class="page-view" id="view-inventory">
        <div class="content-grid">
          <div class="panel">
            <h2>
              <span>ÃœrÃ¼n Ekle / GÃ¼ncelle</span>
              <span class="muted" style="font-size:12px;">Stok / Fiyat</span>
            </h2>

            <div class="row" style="flex-wrap:wrap;">
              <div style="flex:1; min-width:240px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">ÃœrÃ¼n AdÄ±</div>
                <input id="pName" placeholder="Ã–rn: AcÄ±lÄ± Ã‡iÄŸ KÃ¶fte">
              </div>
              <div style="flex:1; min-width:240px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Kategori</div>
                <select id="pCat"></select>
              </div>
            </div>

            <div class="row" style="flex-wrap:wrap; margin-top:10px;">
              <div style="flex:1; min-width:160px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Fiyat (â‚º)</div>
                <input id="pPrice" type="number" step="0.01" min="0" placeholder="0.00">
              </div>
              <div style="flex:1; min-width:160px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Stok</div>
                <input id="pStock" type="number" step="1" min="0" placeholder="0">
              </div>
              <div style="flex:1; min-width:200px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Ä°kon (Emoji)</div>
                <input id="pIcon" placeholder="Ã–rn: ğŸŒ¯">
              </div>
            </div>

            <div style="margin-top:10px;">
              <div class="muted" style="font-size:12px; margin-bottom:6px;">AÃ§Ä±klama (opsiyonel)</div>
              <textarea id="pDesc" rows="3" placeholder="ÃœrÃ¼n aÃ§Ä±klamasÄ±..."></textarea>
            </div>

            <div class="row" style="margin-top:12px; flex-wrap:wrap;">
              <input type="hidden" id="pId">
              <button class="btn btn-primary" type="button" onclick="saveProduct()">ğŸ’¾ Kaydet</button>
              <button class="btn" type="button" onclick="resetProductForm()">â†©ï¸ SÄ±fÄ±rla</button>
            </div>
          </div>

          <div class="panel">
            <h2>
              <span>ÃœrÃ¼n Listesi</span>
              <span class="muted" style="font-size:12px;">DÃ¼zenle/Sil</span>
            </h2>

            <div class="row" style="flex-wrap:wrap; gap:12px; margin-bottom:12px;">
              <div style="flex:1; min-width:220px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Kategori</div>
                <select id="invCatFilter" onchange="filterProducts()"></select>
              </div>
              <div style="flex:1; min-width:220px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Ara</div>
                <input id="invSearch" placeholder="ÃœrÃ¼n adÄ± ara..." oninput="filterProducts()">
              </div>
            </div>

            <div style="overflow:auto;">
              <table id="inventoryTable">
                <thead>
                  <tr>
                    <th>ÃœrÃ¼n</th>
                    <th>Kategori</th>
                    <th>Fiyat</th>
                    <th>Stok</th>
                    <th>Ä°ÅŸlem</th>
                  </tr>
                </thead>
                <tbody id="inventoryBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- EXPENSES -->
      <section class="page-view" id="view-expenses">
        <div class="content-grid">
          <div class="panel">
            <h2>
              <span>Gider Ekle</span>
              <span class="muted" style="font-size:12px;">Masraf kaydÄ±</span>
            </h2>

            <div class="row" style="flex-wrap:wrap;">
              <div style="flex:1; min-width:220px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Tarih</div>
                <input id="expDate" type="date">
              </div>
              <div style="flex:1; min-width:220px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Tip</div>
                <select id="expType"></select>
              </div>
            </div>

            <div class="row" style="flex-wrap:wrap; margin-top:10px;">
              <div style="flex:1; min-width:220px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">AÃ§Ä±klama</div>
                <input id="expDesc" placeholder="Ã–rn: Elektrik faturasÄ±">
              </div>
              <div style="flex:1; min-width:160px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Tutar (â‚º)</div>
                <input id="expAmount" type="number" step="0.01" min="0" placeholder="0.00">
              </div>
            </div>

            <div class="row" style="margin-top:12px; flex-wrap:wrap;">
              <button class="btn btn-primary" type="button" onclick="addExpense()">â• Gider Ekle</button>
              <button class="btn" type="button" onclick="resetExpenseForm()">â†©ï¸ SÄ±fÄ±rla</button>
            </div>
          </div>

          <div class="panel">
            <h2>
              <span>Gider Listesi</span>
              <span class="muted" style="font-size:12px;">Sil</span>
            </h2>

            <div class="row" style="flex-wrap:wrap; gap:12px; margin-bottom:12px;">
              <div style="flex:1; min-width:220px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Tip</div>
                <select id="expTypeFilter" onchange="filterExpenses()"></select>
              </div>
              <div style="flex:1; min-width:220px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Ara</div>
                <input id="expSearch" placeholder="AÃ§Ä±klama ara..." oninput="filterExpenses()">
              </div>
            </div>

            <div style="overflow:auto;">
              <table>
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>Tip</th>
                    <th>AÃ§Ä±klama</th>
                    <th>Tutar</th>
                    <th>Ä°ÅŸlem</th>
                  </tr>
                </thead>
                <tbody id="expensesTable"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Edit Sale Modal -->
      <div id="editModal" class="modal-backdrop hidden">
        <div class="modal">
          <div class="modal-head">
            <b>SatÄ±ÅŸ DÃ¼zenle</b>
            <button class="btn btn-sm" type="button" onclick="closeEditModal()">âœ–</button>
          </div>
          <div class="modal-body">
            <div class="row" style="flex-wrap:wrap;">
              <div style="flex:1; min-width:220px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Kanal</div>
                <select id="editSaleChannel"></select>
              </div>
              <div style="flex:1; min-width:220px;">
                <div class="muted" style="font-size:12px; margin-bottom:6px;">Ã–deme</div>
                <select id="editSaleMethod">
                  <option value="nakit">Nakit</option>
                  <option value="kart">Kart</option>
                  <option value="online">Online</option>
                </select>
              </div>
            </div>

            <div style="margin-top:12px;">
              <div class="muted" style="font-size:12px; margin-bottom:6px;">ÃœrÃ¼nler</div>
              <div id="editSaleItems"></div>
            </div>

            <div class="row" style="margin-top:12px; justify-content:space-between;">
              <div class="muted">Yeni Toplam</div>
              <div style="font-weight:950;" id="editSaleTotal">0.00 â‚º</div>
            </div>
          </div>
          <div class="modal-foot">
            <button class="btn btn-danger" type="button" onclick="deleteSale()">ğŸ—‘ï¸ SatÄ±ÅŸÄ± Sil</button>
            <button class="btn btn-primary" type="button" onclick="updateSale()">ğŸ’¾ GÃ¼ncelle</button>
          </div>
        </div>
      </div>

  <!-- =========================
       ÅUBE ÃœRÃœNLERÄ° (JSON)
       Bu listeler DEFAULTS'e aktarÄ±lÄ±yor.
       ========================= -->

  <!-- Åube 1: Hastane Åubesi ÃœrÃ¼nleri -->
  <script type="application/json" id="branchHastaneProducts">
  [
    {"id": 1, "name": "DÃ¼rÃ¼m 90gr", "cat": "DÃ¼rÃ¼mler", "price": 60, "stock": 100, "icon": "ğŸŒ¯", "description": "Normal boy dÃ¼rÃ¼m"},
    {"id": 2, "name": "Mega DÃ¼rÃ¼m 130gr", "cat": "DÃ¼rÃ¼mler", "price": 85, "stock": 80, "icon": "ğŸŒ¯", "description": "BÃ¼yÃ¼k boy mega dÃ¼rÃ¼m"},
    {"id": 3, "name": "Tombik 90gr", "cat": "Tombikler", "price": 65, "stock": 60, "icon": "ğŸ¥™", "description": "Normal boy tombik"},
    {"id": 4, "name": "Mega Tombik 130gr", "cat": "Tombikler", "price": 90, "stock": 50, "icon": "ğŸ¥™", "description": "Mega boy tombik"},
    {"id": 5, "name": "Ã‡iÄŸ KÃ¶fte 250gr", "cat": "Ã‡iÄŸ KÃ¶fte", "price": 90, "stock": 40, "icon": "ğŸ¥—", "description": "250gr porsiyon"},
    {"id": 6, "name": "Ã‡iÄŸ KÃ¶fte 500gr", "cat": "Ã‡iÄŸ KÃ¶fte", "price": 170, "stock": 30, "icon": "ğŸ¥—", "description": "500gr porsiyon"},
    {"id": 7, "name": "Ã‡iÄŸ KÃ¶fte 1kg", "cat": "Ã‡iÄŸ KÃ¶fte", "price": 320, "stock": 20, "icon": "ğŸ¥—", "description": "1kg paket"},
    {"id": 8, "name": "Ayran 200ml", "cat": "Ä°Ã§ecek", "price": 15, "stock": 120, "icon": "ğŸ¥›", "description": "SoÄŸuk ayran"},
    {"id": 9, "name": "Åalgam 300ml", "cat": "Ä°Ã§ecek", "price": 20, "stock": 90, "icon": "ğŸ§ƒ", "description": "AcÄ±lÄ±/AcÄ±sÄ±z"},
    {"id": 10, "name": "Kola 330ml", "cat": "Ä°Ã§ecek", "price": 25, "stock": 90, "icon": "ğŸ¥¤", "description": "Kutu kola"},
    {"id": 11, "name": "Fanta 330ml", "cat": "Ä°Ã§ecek", "price": 25, "stock": 80, "icon": "ğŸ¥¤", "description": "Kutu fanta"},
    {"id": 12, "name": "Su 500ml", "cat": "Ä°Ã§ecek", "price": 10, "stock": 200, "icon": "ğŸ’§", "description": "Su"},
    {"id": 13, "name": "Soda", "cat": "Ä°Ã§ecek", "price": 12, "stock": 100, "icon": "ğŸ«§", "description": "Maden suyu"},
    {"id": 14, "name": "Nar EkÅŸisi", "cat": "Ekstra", "price": 10, "stock": 60, "icon": "ğŸ¯", "description": "Ekstra sos"},
    {"id": 15, "name": "AcÄ± Sos", "cat": "Ekstra", "price": 10, "stock": 60, "icon": "ğŸŒ¶ï¸", "description": "Ekstra acÄ±"},
    {"id": 16, "name": "LavaÅŸ", "cat": "Ekstra", "price": 5, "stock": 200, "icon": "ğŸ«“", "description": "Tek lavaÅŸ"},
    {"id": 17, "name": "Marul", "cat": "Ekstra", "price": 5, "stock": 150, "icon": "ğŸ¥¬", "description": "Tek marul"},
    {"id": 18, "name": "TurÅŸu", "cat": "Ekstra", "price": 5, "stock": 150, "icon": "ğŸ¥’", "description": "Tek turÅŸu"},
    {"id": 19, "name": "Patates KÄ±zartmasÄ±", "cat": "AtÄ±ÅŸtÄ±rmalÄ±k", "price": 40, "stock": 35, "icon": "ğŸŸ", "description": "Porsiyon patates"},
    {"id": 20, "name": "SoÄŸan HalkasÄ±", "cat": "AtÄ±ÅŸtÄ±rmalÄ±k", "price": 45, "stock": 30, "icon": "ğŸ§…", "description": "Porsiyon soÄŸan halkasÄ±"},
    {"id": 21, "name": "Soslu Patates", "cat": "AtÄ±ÅŸtÄ±rmalÄ±k", "price": 50, "stock": 25, "icon": "ğŸŸ", "description": "Ã–zel soslu"},
    {"id": 22, "name": "TatlÄ±", "cat": "TatlÄ±", "price": 35, "stock": 20, "icon": "ğŸ°", "description": "GÃ¼nÃ¼n tatlÄ±sÄ±"},
    {"id": 23, "name": "Brownie", "cat": "TatlÄ±", "price": 40, "stock": 15, "icon": "ğŸ«", "description": "Brownie dilim"},
    {"id": 24, "name": "KÃ¼nefe", "cat": "TatlÄ±", "price": 60, "stock": 12, "icon": "ğŸ§€", "description": "SÄ±cak kÃ¼nefe"},
    {"id": 25, "name": "Ã‡ay", "cat": "Ä°Ã§ecek", "price": 10, "stock": 200, "icon": "ğŸµ", "description": "SÄ±cak Ã§ay"}
  ]
  </script>

  <!-- Åube 2: Cihanpol Åubesi ÃœrÃ¼nleri -->
  <script type="application/json" id="branchCihanpolProducts">
  [
    {"id": 1, "name": "DÃ¼rÃ¼m 90gr", "cat": "DÃ¼rÃ¼mler", "price": 60, "stock": 80, "icon": "ğŸŒ¯", "description": "Normal boy dÃ¼rÃ¼m"},
    {"id": 2, "name": "Mega DÃ¼rÃ¼m 130gr", "cat": "DÃ¼rÃ¼mler", "price": 85, "stock": 70, "icon": "ğŸŒ¯", "description": "BÃ¼yÃ¼k boy mega dÃ¼rÃ¼m"},
    {"id": 3, "name": "Tombik 90gr", "cat": "Tombikler", "price": 65, "stock": 50, "icon": "ğŸ¥™", "description": "Normal boy tombik"},
    {"id": 4, "name": "Mega Tombik 130gr", "cat": "Tombikler", "price": 90, "stock": 45, "icon": "ğŸ¥™", "description": "Mega boy tombik"},
    {"id": 5, "name": "Ã‡iÄŸ KÃ¶fte 250gr", "cat": "Ã‡iÄŸ KÃ¶fte", "price": 90, "stock": 35, "icon": "ğŸ¥—", "description": "250gr porsiyon"},
    {"id": 6, "name": "Ã‡iÄŸ KÃ¶fte 500gr", "cat": "Ã‡iÄŸ KÃ¶fte", "price": 170, "stock": 25, "icon": "ğŸ¥—", "description": "500gr porsiyon"},
    {"id": 7, "name": "Ã‡iÄŸ KÃ¶fte 1kg", "cat": "Ã‡iÄŸ KÃ¶fte", "price": 320, "stock": 18, "icon": "ğŸ¥—", "description": "1kg paket"},
    {"id": 8, "name": "Ayran 200ml", "cat": "Ä°Ã§ecek", "price": 15, "stock": 110, "icon": "ğŸ¥›", "description": "SoÄŸuk ayran"},
    {"id": 9, "name": "Åalgam 300ml", "cat": "Ä°Ã§ecek", "price": 20, "stock": 85, "icon": "ğŸ§ƒ", "description": "AcÄ±lÄ±/AcÄ±sÄ±z"},
    {"id": 10, "name": "Kola 330ml", "cat": "Ä°Ã§ecek", "price": 25, "stock": 80, "icon": "ğŸ¥¤", "description": "Kutu kola"},
    {"id": 11, "name": "Fanta 330ml", "cat": "Ä°Ã§ecek", "price": 25, "stock": 70, "icon": "ğŸ¥¤", "description": "Kutu fanta"},
    {"id": 12, "name": "Su 500ml", "cat": "Ä°Ã§ecek", "price": 10, "stock": 180, "icon": "ğŸ’§", "description": "Su"},
    {"id": 13, "name": "Soda", "cat": "Ä°Ã§ecek", "price": 12, "stock": 90, "icon": "ğŸ«§", "description": "Maden suyu"},
    {"id": 14, "name": "Nar EkÅŸisi", "cat": "Ekstra", "price": 10, "stock": 55, "icon": "ğŸ¯", "description": "Ekstra sos"},
    {"id": 15, "name": "AcÄ± Sos", "cat": "Ekstra", "price": 10, "stock": 55, "icon": "ğŸŒ¶ï¸", "description": "Ekstra acÄ±"},
    {"id": 16, "name": "LavaÅŸ", "cat": "Ekstra", "price": 5, "stock": 180, "icon": "ğŸ«“", "description": "Tek lavaÅŸ"},
    {"id": 17, "name": "Marul", "cat": "Ekstra", "price": 5, "stock": 140, "icon": "ğŸ¥¬", "description": "Tek marul"},
    {"id": 18, "name": "TurÅŸu", "cat": "Ekstra", "price": 5, "stock": 140, "icon": "ğŸ¥’", "description": "Tek turÅŸu"},
    {"id": 19, "name": "Patates KÄ±zartmasÄ±", "cat": "AtÄ±ÅŸtÄ±rmalÄ±k", "price": 40, "stock": 30, "icon": "ğŸŸ", "description": "Porsiyon patates"},
    {"id": 20, "name": "SoÄŸan HalkasÄ±", "cat": "AtÄ±ÅŸtÄ±rmalÄ±k", "price": 45, "stock": 26, "icon": "ğŸ§…", "description": "Porsiyon soÄŸan halkasÄ±"},
    {"id": 21, "name": "Soslu Patates", "cat": "AtÄ±ÅŸtÄ±rmalÄ±k", "price": 50, "stock": 20, "icon": "ğŸŸ", "description": "Ã–zel soslu"},
    {"id": 22, "name": "TatlÄ±", "cat": "TatlÄ±", "price": 35, "stock": 16, "icon": "ğŸ°", "description": "GÃ¼nÃ¼n tatlÄ±sÄ±"},
    {"id": 23, "name": "Brownie", "cat": "TatlÄ±", "price": 40, "stock": 12, "icon": "ğŸ«", "description": "Brownie dilim"},
    {"id": 24, "name": "KÃ¼nefe", "cat": "TatlÄ±", "price": 60, "stock": 10, "icon": "ğŸ§€", "description": "SÄ±cak kÃ¼nefe"},
    {"id": 25, "name": "Ã‡ay", "cat": "Ä°Ã§ecek", "price": 10, "stock": 180, "icon": "ğŸµ", "description": "SÄ±cak Ã§ay"}
  ]
  </script>

      <script>
    // ====== STORAGE ======
    var STORAGE_KEY = 'MAHSUM_USTA_APP_V5';
    var THEME_KEY = 'MAHSUM_USTA_THEME';

    // ====== GOOGLE SHEETS LIVE SYNC CONFIG ======
    var SHEETS_SYNC = {
      enabled: true,
      clientId: '475033237170-hmk421hd221h2ubdu26svt4sgv3709gn.apps.googleusercontent.com',
      spreadsheetId: '14KIWt8HFT-CoYAsyWpBa1YNrMlay2_UKQqBdKMfo4Ck',
      range: 'State!A2:D2',
      scope: 'https://www.googleapis.com/auth/spreadsheets'
      opsAppendRange: 'Ops!A:H',

    };

    // VarsayÄ±lanlar
    var DEFAULTS = {
      categories: ['Ã‡iÄŸ KÃ¶fte','DÃ¼rÃ¼mler','Tombikler','Ä°Ã§ecek','TatlÄ±','AtÄ±ÅŸtÄ±rmalÄ±k','Ekstra'],
      expenseTypes: ['Kira','Elektrik','Su','DoÄŸalgaz','Personel','Malzeme','DiÄŸer'],
      salesChannels: ['DÃ¼kkan Ä°Ã§i','Yemeksepeti','Telefon'],
      branches: {
        hastane: { name:'Hastane Åubesi', products:[], sales:[], expenses:[] },
        cihanpol:{ name:'Cihanpol Åubesi', products:[], sales:[], expenses:[] }
      }
    };

    // Default Ã¼rÃ¼nleri JSON scriptlerden oku ve DEFAULTS iÃ§ine koy
    function readProductsFromScript(scriptId){
      try{
        var el = document.getElementById(scriptId);
        if(!el) return [];
        var txt = (el.textContent || el.innerText || '').trim();
        if(!txt) return [];
        var arr = JSON.parse(txt);
        if(!Array.isArray(arr)) return [];
        return arr;
      }catch(e){ return []; }
    }
    DEFAULTS.branches.hastane.products = readProductsFromScript('branchHastaneProducts');
    DEFAULTS.branches.cihanpol.products = readProductsFromScript('branchCihanpolProducts');

    // Eski localStorage key'lerini otomatik bulup taÅŸÄ± (V5'e)
    function findBestOldStateInLocalStorage(){
      try{
        var bestKey = null;
        var bestScore = -1;

        for(var i=0;i<localStorage.length;i++){
          var k = localStorage.key(i);
          if(!k) continue;
          if(k === STORAGE_KEY) continue;

          var raw = localStorage.getItem(k);
          if(!raw || raw.length < 10) continue;

          var obj = null;
          try{ obj = JSON.parse(raw); }catch(e){ obj=null; }
          if(!obj || typeof obj !== 'object') continue;

          // Skorla: branches varsa yÃ¼ksek, sales/expenses/products varsa artÄ±
          var score = 0;
          if(obj.branches && typeof obj.branches === 'object') score += 5;
          if(obj.categories && Array.isArray(obj.categories)) score += 1;
          if(obj.expenseTypes && Array.isArray(obj.expenseTypes)) score += 1;
          if(obj.salesChannels && Array.isArray(obj.salesChannels)) score += 1;

          // branch iÃ§eriÄŸi
          if(obj.branches){
            var bks = Object.keys(obj.branches);
            for(var j=0;j<bks.length;j++){
              var bk = bks[j];
              var b = obj.branches[bk];
              if(!b) continue;
              if(Array.isArray(b.products)) score += 2;
              if(Array.isArray(b.sales)) score += 2;
              if(Array.isArray(b.expenses)) score += 2;
            }
          }

          if(score > bestScore){
            bestScore = score;
            bestKey = k;
          }
        }

        return bestKey;
      }catch(e){
        return null;
      }
    }

    function deepClone(o){
      return JSON.parse(JSON.stringify(o));
    }

    function normalizeAndBackfill(st){
      // temel alanlar yoksa ekle
      if(!st.categories || !Array.isArray(st.categories) || st.categories.length===0) st.categories = deepClone(DEFAULTS.categories);
      if(!st.expenseTypes || !Array.isArray(st.expenseTypes) || st.expenseTypes.length===0) st.expenseTypes = deepClone(DEFAULTS.expenseTypes);
      if(!st.salesChannels || !Array.isArray(st.salesChannels) || st.salesChannels.length===0) st.salesChannels = deepClone(DEFAULTS.salesChannels);

      if(!st.branches || typeof st.branches !== 'object') st.branches = deepClone(DEFAULTS.branches);

      // ÅŸube objeleri
      var keys = ['hastane','cihanpol'];
      for(var i=0;i<keys.length;i++){
        var k = keys[i];
        if(!st.branches[k]) st.branches[k] = deepClone(DEFAULTS.branches[k]);
        if(!st.branches[k].name) st.branches[k].name = DEFAULTS.branches[k].name;
        if(!Array.isArray(st.branches[k].products)) st.branches[k].products = [];
        if(!Array.isArray(st.branches[k].sales)) st.branches[k].sales = [];
        if(!Array.isArray(st.branches[k].expenses)) st.branches[k].expenses = [];

        // Ã¼rÃ¼nleri geri doldur (id bazlÄ±)
        var defaultProducts = DEFAULTS.branches[k].products || [];
        if(defaultProducts.length){
          var map = {};
          for(var j=0;j<st.branches[k].products.length;j++){
            map[String(st.branches[k].products[j].id)] = st.branches[k].products[j];
          }
          for(j=0;j<defaultProducts.length;j++){
            var dp = defaultProducts[j];
            if(!map[String(dp.id)]){
              st.branches[k].products.push(deepClone(dp));
            }
          }
        }
      }
      return st;
    }

    var dataSourceKey = STORAGE_KEY;

    function loadStateOrDefault(){
      // Ã–nce V5'ten dene
      var raw = localStorage.getItem(STORAGE_KEY);
      if(raw){
        try{
          var st = JSON.parse(raw);
          st = normalizeAndBackfill(st);
          dataSourceKey = STORAGE_KEY;
          return st;
        }catch(e){}
      }

      // V5 yoksa: en iyi eski state'i bul ve migrate et
      var oldKey = findBestOldStateInLocalStorage();
      if(oldKey){
        try{
          var oldRaw = localStorage.getItem(oldKey);
          var oldSt = JSON.parse(oldRaw);
          oldSt = normalizeAndBackfill(oldSt);

          // migrate: V5'e yaz
          localStorage.setItem(STORAGE_KEY, JSON.stringify(oldSt));
          dataSourceKey = oldKey + " â†’ " + STORAGE_KEY;
          return oldSt;
        }catch(e){}
      }

      // hiÃ§ yoksa defaults
      dataSourceKey = 'DEFAULTS';
      return normalizeAndBackfill(deepClone(DEFAULTS));
    }

    var state = loadStateOrDefault();

    // ====== THEME ======
    function loadTheme(){
      var t = localStorage.getItem(THEME_KEY);
      if(t==='light' || t==='dark'){
        document.documentElement.setAttribute('data-theme', t);
        updateThemeButton();
      }
    }
    function toggleTheme(){
      var cur = document.documentElement.getAttribute('data-theme') || 'dark';
      var next = (cur==='dark') ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem(THEME_KEY, next);
      updateThemeButton();
    }
    function updateThemeButton(){
      var btn = document.getElementById('themeToggle');
      if(!btn) return;
      var cur = document.documentElement.getAttribute('data-theme') || 'dark';
      btn.textContent = (cur==='dark') ? 'ğŸŒ™' : 'â˜€ï¸';
    }

    // ====== HELPERS ======
    function esc(s){
      s = (s===null || s===undefined) ? '' : String(s);
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }
    function setText(id, txt){
      var el = document.getElementById(id);
      if(el) el.textContent = txt;
    }
    function getVal(id){
      var el = document.getElementById(id);
      return el ? el.value : '';
    }
    function setVal(id, v){
      var el = document.getElementById(id);
      if(el) el.value = v;
    }
    function showSaveStatus(msg, type){
      var el = document.getElementById('saveStatus');
      if(!el) return;
      el.textContent = msg || '';
      el.style.color = (type==='success') ? 'var(--success)' : (type==='error' ? 'var(--danger)' : 'var(--muted)');
    }

    function newId(){
      return Date.now() + Math.floor(Math.random()*1000);
    }

    function getBranchKey(){
      var sel = document.getElementById('branchSelect');
      return sel ? sel.value : 'hastane';
    }
    function getBranch(){
      var k = getBranchKey();
      return state.branches[k];
    }
    function refreshBranchLabel(){
      var b = getBranch();
      var el = document.getElementById('activeBranchLabel');
      if(el && b) el.textContent = 'â€” ' + b.name;
    }

    function updateDataSourceLabels(){
      var d1 = document.getElementById('dataSourceLabel');
      var d2 = document.getElementById('dataSourceTop');
      if(d1) d1.textContent = dataSourceKey || '-';
      if(d2) d2.textContent = 'Kaynak: ' + (dataSourceKey || '-');
    }

    function save(silent){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        dataSourceKey = STORAGE_KEY;
        if(!silent) showSaveStatus('Kaydedildi', 'success');
        updateDataSourceLabels();

        // Sheets push (debounced)
        if(SheetsSync && SheetsSync.isReady()){
          SheetsSync.pushDebounced();
        }

        return true;
      }catch(e){
        if(!silent) showSaveStatus('Kaydetme hatasÄ±!', 'error');
        return false;
      }
    }

    function cloneItems(items){
      return items.map(function(it){
        return { id:it.id, name:it.name, price:Number(it.price)||0, qty:Number(it.qty)||0 };
      });
    }

    function findProduct(products, id){
      for(var i=0;i<products.length;i++){
        if(Number(products[i].id)===Number(id)) return products[i];
      }
      return null;
    }

    function getCategoryIcon(cat){
      var map = {
        'Ã‡iÄŸ KÃ¶fte':'ğŸ¥—',
        'DÃ¼rÃ¼mler':'ğŸŒ¯',
        'Tombikler':'ğŸ¥™',
        'Ä°Ã§ecek':'ğŸ¥¤',
        'TatlÄ±':'ğŸ°',
        'AtÄ±ÅŸtÄ±rmalÄ±k':'ğŸŸ',
        'Ekstra':'âœ¨'
      };
      return map[cat] || 'ğŸ“¦';
    }

    // ====== SIDEBAR & VIEW ======
    function bindNav(){
      var items = document.querySelectorAll('.nav-item');
      for(var i=0;i<items.length;i++){
        items[i].addEventListener('click', function(){
          var view = this.getAttribute('data-view');
          switchView(view);
          if(window.innerWidth <= 840){
            toggleSidebar(true);
          }
        });
      }
    }

    function switchView(view){
      var items = document.querySelectorAll('.nav-item');
      for(var i=0;i<items.length;i++){
        items[i].classList.toggle('active', items[i].getAttribute('data-view')===view);
      }
      var views = document.querySelectorAll('.page-view');
      for(i=0;i<views.length;i++){
        views[i].classList.remove('active');
      }
      var target = document.getElementById('view-' + view);
      if(target) target.classList.add('active');

      if(view==='pos') renderPOS();
      if(view==='dashboard'){ renderDashboard(); renderSalesTable(); }
      if(view==='inventory'){ renderInventory(); }
      if(view==='expenses'){ renderExpenses(); }
    }

    function toggleSidebar(forceClose){
      var sb = document.getElementById('sidebar');
      var ov = document.getElementById('sbOverlay');
      if(!sb) return;

      var open = sb.classList.contains('open');
      var shouldOpen = !open;

      if(forceClose === true) shouldOpen = false;
      if(forceClose === false) shouldOpen = true;

      if(shouldOpen){
        sb.classList.add('open');
        if(ov) ov.classList.remove('hidden');
      }else{
        sb.classList.remove('open');
        if(ov) ov.classList.add('hidden');
      }
    }

    // ====== POS ======
    var activeCat = 'Hepsi';
    var activeChannel = (state.salesChannels && state.salesChannels[0]) || 'DÃ¼kkan Ä°Ã§i';
    var activePayMethod = 'nakit';
    var cart = [];

    function renderPayButtons(){
      var el = document.getElementById('payButtons');
      if(!el) return;
      var methods = [
        {k:'nakit', t:'ğŸ’µ Nakit'},
        {k:'kart', t:'ğŸ’³ Kart'},
        {k:'online', t:'ğŸŒ Online'}
      ];
      var html = '';
      for(var i=0;i<methods.length;i++){
        html += '<div class="chip '+(activePayMethod===methods[i].k?'active':'')+'" data-pay="'+methods[i].k+'">'+methods[i].t+'</div>';
      }
      el.innerHTML = html;

      el.onclick = function(ev){
        var t = ev.target;
        while(t && t!==el && !t.getAttribute('data-pay')) t = t.parentElement;
        if(t && t.getAttribute('data-pay')){
          activePayMethod = t.getAttribute('data-pay');
          renderPayButtons();
        }
      };
    }

    function renderPOS(){
      var branch = getBranch();
      var catBar = document.getElementById('catBar');
      var posGrid = document.getElementById('posGrid');
      var channelButtons = document.getElementById('channelButtons');
      if(!branch || !catBar || !posGrid || !channelButtons) return;

      var i, c, html;

      // Kategoriler
      html = '<div class="chip '+(activeCat==='Hepsi'?'active':'')+'" data-cat="Hepsi">ğŸ“¦ Hepsi</div>';
      for(i=0;i<state.categories.length;i++){
        c = state.categories[i];
        html += '<div class="chip '+(activeCat===c?'active':'')+'" data-cat="'+esc(c)+'">'+getCategoryIcon(c)+' '+esc(c)+'</div>';
      }
      catBar.innerHTML = html;

      // Kanallar
      html = '';
      for(i=0;i<state.salesChannels.length;i++){
        c = state.salesChannels[i];
        html += '<div class="chip '+(activeChannel===c?'active':'')+'" data-channel="'+esc(c)+'">ğŸ“ '+esc(c)+'</div>';
      }
      channelButtons.innerHTML = html;

      // ÃœrÃ¼nler
      var prods = branch.products || [];
      html = '';
      for(i=0;i<prods.length;i++){
        var p = prods[i];
        if(activeCat!=='Hepsi' && p.cat!==activeCat) continue;

        var st = Number(p.stock)||0;
        var stockText = (st<=0) ? 'Stok Yok' : ('Stok: '+st);

        html += '<div class="product" data-pid="'+esc(p.id)+'" title="Sepete ekle">'
          +   '<div class="pico">'+esc(p.icon || getCategoryIcon(p.cat))+'</div>'
          +   '<div style="min-width:0;">'
          +     '<b class="pname">'+esc(p.name)+'</b>'
          +     (p.description ? '<div style="font-size:.8rem; color:var(--muted); margin:5px 0;">'+esc(p.description)+'</div>' : '')
          +     '<div class="price">'+Number(p.price).toFixed(2)+' â‚º</div>'
          +     '<div class="stock">'+esc(stockText)+'</div>'
          +   '</div>'
          + '</div>';
      }
      posGrid.innerHTML = html;

      // Ã¼rÃ¼n tÄ±klama (event delegation)
      posGrid.onclick = function(ev){
        var el = ev.target;
        while(el && el!==posGrid && !el.getAttribute('data-pid')) el = el.parentElement;
        if(el && el.getAttribute('data-pid')){
          addToCart(Number(el.getAttribute('data-pid')));
        }
      };

      // kategori tÄ±klama
      catBar.onclick = function(ev){
        var el = ev.target;
        while(el && el!==catBar && !el.getAttribute('data-cat')) el = el.parentElement;
        if(el && el.getAttribute('data-cat')){
          activeCat = el.getAttribute('data-cat');
          renderPOS();
        }
      };

      // kanal tÄ±klama
      channelButtons.onclick = function(ev){
        var el = ev.target;
        while(el && el!==channelButtons && !el.getAttribute('data-channel')) el = el.parentElement;
        if(el && el.getAttribute('data-channel')){
          activeChannel = el.getAttribute('data-channel');
          renderPOS();
        }
      };

      renderCart();
      renderPayButtons();
    }

    function calcCartTotal(){
      var t = 0;
      for(var i=0;i<cart.length;i++){
        t += (Number(cart[i].price)||0) * (Number(cart[i].qty)||0);
      }
      return t;
    }

    function renderCart(){
      var el = document.getElementById('cartList');
      if(!el) return;

      if(cart.length===0){
        el.innerHTML = '<div class="cart-empty">Sepet boÅŸ</div>';
        setText('cartTotal', '0.00 â‚º');
        return;
      }

      var html = '';
      for(var i=0;i<cart.length;i++){
        var it = cart[i];
        html += '<div class="cart-item">'
          +   '<div style="min-width:0;">'
          +     '<div style="font-weight:900;">'+esc(it.name)+'</div>'
          +     '<div class="muted" style="font-size:12px; margin-top:3px;">'+Number(it.price).toFixed(2)+' â‚º</div>'
          +   '</div>'
          +   '<div class="row" style="gap:6px;">'
          +     '<button class="btn btn-sm" type="button" onclick="changeCartQty('+it.id+', -1)">âˆ’</button>'
          +     '<div style="min-width:28px; text-align:center; font-weight:900;">'+it.qty+'</div>'
          +     '<button class="btn btn-sm" type="button" onclick="changeCartQty('+it.id+', 1)">+</button>'
          +   '</div>'
          + '</div>';
      }
      el.innerHTML = html;

      setText('cartTotal', calcCartTotal().toFixed(2)+' â‚º');
    }

    function addToCart(pid){
      var b = getBranch();
      var p = findProduct(b.products, pid);
      if(!p) return;

      var stock = Number(p.stock)||0;
      if(stock<=0){
        alert('Stok yok!');
        return;
      }

      // sepette var mÄ±
      for(var i=0;i<cart.length;i++){
        if(Number(cart[i].id)===Number(pid)){
          if(cart[i].qty + 1 > stock){
            alert('Yetersiz stok! (Mevcut: '+stock+')');
            return;
          }
          cart[i].qty += 1;
          renderCart();
          return;
        }
      }

      cart.push({ id:p.id, name:p.name, price:Number(p.price)||0, qty:1 });
      renderCart();
    }

    function changeCartQty(pid, delta){
      var b = getBranch();
      var p = findProduct(b.products, pid);
      if(!p) return;
      var stock = Number(p.stock)||0;

      for(var i=0;i<cart.length;i++){
        if(Number(cart[i].id)===Number(pid)){
          var next = cart[i].qty + delta;
          if(next<=0){
            cart.splice(i,1);
            renderCart();
            return;
          }
          if(next > stock){
            alert('Yetersiz stok! (Mevcut: '+stock+')');
            return;
          }
          cart[i].qty = next;
          renderCart();
          return;
        }
      }
    }

    function clearCart(){
      if(cart.length===0) return;
      if(!confirm('Sepeti temizlemek istiyor musunuz?')) return;
      cart = [];
      renderCart();
    }

    function checkout(){
      var b = getBranch();
      if(cart.length===0){
        alert('Sepet boÅŸ!');
        return;
      }

      // stok kontrol + dÃ¼ÅŸ
      for(var i=0;i<cart.length;i++){
        var it = cart[i];
        var p = findProduct(b.products, it.id);
        if(!p){ alert('ÃœrÃ¼n bulunamadÄ±: '+it.name); return; }
        var st = Number(p.stock)||0;
        if(it.qty > st){
          alert('Yetersiz stok: '+it.name+' (Mevcut: '+st+')');
          return;
        }
      }
      for(i=0;i<cart.length;i++){
        it = cart[i];
        p = findProduct(b.products, it.id);
        p.stock = (Number(p.stock)||0) - (Number(it.qty)||0);
      }

      var total = calcCartTotal();
      var sale = {
        id: newId(),
        date: new Date().toISOString(),
        items: cloneItems(cart),
        total: total,
        method: activePayMethod,
        channel: activeChannel
      };
      b.sales.push(sale);
      if(SheetsSync && SheetsSync.isReady()){
        SheetsSync.logSale(getBranchKey(), sale);
      }
      save();
      cart = [];
      renderPOS();
      alert('SatÄ±ÅŸ kaydedildi!');
    }

    // ====== DASHBOARD / SALES TABLE ======
    function renderDashboard(){
      var b = getBranch();
      if(!b) return;

      var turnover = 0, expense = 0;
      for(var i=0;i<b.sales.length;i++) turnover += Number(b.sales[i].total)||0;
      for(i=0;i<b.expenses.length;i++) expense += Number(b.expenses[i].amount)||0;

      setText('repTurnover', turnover.toFixed(2)+' â‚º');
      setText('repExpense', expense.toFixed(2)+' â‚º');
      setText('repCount', String(b.sales.length));
      setText('repNet', (turnover-expense).toFixed(2)+' â‚º');

      filterSales();
    }

    function findSale(sales, id){
      for(var i=0;i<sales.length;i++){
        if(Number(sales[i].id)===Number(id)) return sales[i];
      }
      return null;
    }

    function renderSalesTable(list){
      var b = getBranch();
      var tb = document.getElementById('salesTable');
      if(!tb || !b) return;

      var sales = list || b.sales || [];
      var html = '';

      // en yeni en Ã¼stte
      sales = sales.slice().sort(function(a,b){ return (new Date(b.date)) - (new Date(a.date)); });

      for(var i=0;i<sales.length;i++){
        var s = sales[i];
        var d = new Date(s.date);
        var ds = d.toLocaleString('tr-TR');

        var itemsStr = '';
        for(var j=0;j<s.items.length;j++){
          itemsStr += s.items[j].name + ' x' + s.items[j].qty + (j<s.items.length-1 ? ', ' : '');
        }

        html += '<tr>'
          + '<td>'+esc(ds)+'</td>'
          + '<td>'+esc(s.channel||'')+'</td>'
          + '<td>'+esc((s.method||'').toUpperCase())+'</td>'
          + '<td>'+Number(s.total||0).toFixed(2)+' â‚º</td>'
          + '<td>'+esc(itemsStr)+'</td>'
          + '<td><button class="btn btn-sm" type="button" onclick="openEditSale('+s.id+')">âœï¸</button></td>'
          + '</tr>';
      }

      tb.innerHTML = html || '<tr><td colspan="6" class="muted">SatÄ±ÅŸ yok</td></tr>';
    }

    function filterSales(){
      var b = getBranch();
      if(!b) return;

      var dateFilter = getVal('salesDateFilter');
      var chFilter = getVal('salesChannelFilter');
      var q = (getVal('salesSearch')||'').toLowerCase().trim();

      var out = [];
      for(var i=0;i<b.sales.length;i++){
        var s = b.sales[i];

        if(dateFilter){
          var sd = new Date(s.date);
          var y = sd.getFullYear();
          var m = String(sd.getMonth()+1).padStart(2,'0');
          var da = String(sd.getDate()).padStart(2,'0');
          var sDate = y+'-'+m+'-'+da;
          if(sDate !== dateFilter) continue;
        }

        if(chFilter && chFilter!=='Hepsi'){
          if((s.channel||'') !== chFilter) continue;
        }

        if(q){
          var hay = (String(s.id)+' '+(s.channel||'')+' '+(s.method||'')+' ');
          for(var j=0;j<s.items.length;j++){
            hay += (s.items[j].name||'')+' ';
          }
          if(hay.toLowerCase().indexOf(q)===-1) continue;
        }

        out.push(s);
      }

      renderSalesTable(out);
    }

    function renderSalesChannelFilter(){
      var el = document.getElementById('salesChannelFilter');
      if(!el) return;
      var html = '<option value="Hepsi">Hepsi</option>';
      for(var i=0;i<state.salesChannels.length;i++){
        html += '<option value="'+esc(state.salesChannels[i])+'">'+esc(state.salesChannels[i])+'</option>';
      }
      el.innerHTML = html;

      var el2 = document.getElementById('editSaleChannel');
      if(el2){
        var html2 = '';
        for(i=0;i<state.salesChannels.length;i++){
          html2 += '<option value="'+esc(state.salesChannels[i])+'">'+esc(state.salesChannels[i])+'</option>';
        }
        el2.innerHTML = html2;
      }
    }

    // ====== EDIT SALE MODAL ======
    var editingSaleId = null;
    var saleDraft = null;
    var saleOriginalSnapshot = null;

    function openEditSale(id){
      var b = getBranch();
      var sale = findSale(b.sales, id);
      if(!sale) return;

      editingSaleId = id;

      // snapshot'lar
      saleOriginalSnapshot = deepClone(sale);
      saleDraft = deepClone(sale);

      setVal('editSaleChannel', sale.channel || state.salesChannels[0] || 'DÃ¼kkan Ä°Ã§i');
      setVal('editSaleMethod', sale.method || 'nakit');

      renderEditSaleItems();
      document.getElementById('editModal').classList.remove('hidden');
    }

    function closeEditModal(){
      var m = document.getElementById('editModal');
      if(m) m.classList.add('hidden');
      editingSaleId = null;
      saleDraft = null;
      saleOriginalSnapshot = null;
    }

    function renderEditSaleItems(){
      var el = document.getElementById('editSaleItems');
      if(!el || !saleDraft) return;

      var b = getBranch();
      var html = '';

      for(var i=0;i<saleDraft.items.length;i++){
        var it = saleDraft.items[i];
        var p = findProduct(b.products, it.id);
        var stock = p ? Number(p.stock)||0 : 0;

        // max qty = mevcut stok + (orijinal satÄ±ÅŸta bu Ã¼rÃ¼nden kaÃ§ vardÄ±)
        var origQty = 0;
        for(var j=0;j<saleOriginalSnapshot.items.length;j++){
          if(Number(saleOriginalSnapshot.items[j].id)===Number(it.id)){
            origQty = Number(saleOriginalSnapshot.items[j].qty)||0;
            break;
          }
        }
        var maxQty = stock + origQty;

        html += '<div class="cart-item" style="border-bottom:1px solid var(--border); padding:10px 0;">'
          +   '<div style="min-width:0;">'
          +     '<div style="font-weight:900;">'+esc(it.name)+'</div>'
          +     '<div class="muted" style="font-size:12px; margin-top:3px;">Mevcut stok: '+stock+' | Limit: '+maxQty+'</div>'
          +   '</div>'
          +   '<div class="row" style="gap:6px;">'
          +     '<button class="btn btn-sm" type="button" onclick="editSaleQty('+it.id+', -1)">âˆ’</button>'
          +     '<div style="min-width:28px; text-align:center; font-weight:900;">'+it.qty+'</div>'
          +     '<button class="btn btn-sm" type="button" onclick="editSaleQty('+it.id+', 1)">+</button>'
          +   '</div>'
          + '</div>';
      }

      el.innerHTML = html;

      setText('editSaleTotal', calcItemsTotal(saleDraft.items).toFixed(2)+' â‚º');
    }

    function calcItemsTotal(items){
      var t = 0;
      for(var i=0;i<items.length;i++){
        t += (Number(items[i].price)||0) * (Number(items[i].qty)||0);
      }
      return t;
    }

    function editSaleQty(pid, delta){
      if(!saleDraft || !saleOriginalSnapshot) return;
      var b = getBranch();
      var p = findProduct(b.products, pid);
      var stock = p ? Number(p.stock)||0 : 0;

      // orijinal qty
      var origQty = 0;
      for(var j=0;j<saleOriginalSnapshot.items.length;j++){
        if(Number(saleOriginalSnapshot.items[j].id)===Number(pid)){
          origQty = Number(saleOriginalSnapshot.items[j].qty)||0;
          break;
        }
      }
      var maxQty = stock + origQty;

      for(var i=0;i<saleDraft.items.length;i++){
        if(Number(saleDraft.items[i].id)===Number(pid)){
          var next = saleDraft.items[i].qty + delta;
          if(next<1) next = 1;
          if(next>maxQty){
            alert('Limit aÅŸÄ±ldÄ±! Maks: '+maxQty);
            return;
          }
          saleDraft.items[i].qty = next;
          break;
        }
      }
      renderEditSaleItems();
    }

    function updateSale(){
      var b = getBranch();
      var sale = findSale(b.sales, editingSaleId);
      if(!sale || !saleDraft || !saleOriginalSnapshot) return;

      var newMethod = getVal('editSaleMethod') || 'nakit';
      var newChannel = getVal('editSaleChannel') || (state.salesChannels && state.salesChannels[0]) || 'DÃ¼kkan Ä°Ã§i';

      // 1) eski satÄ±ÅŸÄ±n stok etkisini geri al
      for(var i=0;i<saleOriginalSnapshot.items.length;i++){
        var oi = saleOriginalSnapshot.items[i];
        var p1 = findProduct(b.products, oi.id);
        if(p1) p1.stock = (Number(p1.stock)||0) + (Number(oi.qty)||0);
      }

      // 2) yeni taslaÄŸa gÃ¶re dÃ¼ÅŸ (kontrol)
      for(i=0;i<saleDraft.items.length;i++){
        var ni = saleDraft.items[i];
        var p2 = findProduct(b.products, ni.id);
        if(!p2){
          // fail-safe: eskiyi tekrar dÃ¼ÅŸ
          for(var j=0;j<saleOriginalSnapshot.items.length;j++){
            var oi2 = saleOriginalSnapshot.items[j];
            var pp = findProduct(b.products, oi2.id);
            if(pp) pp.stock = (Number(pp.stock)||0) - (Number(oi2.qty)||0);
          }
          alert('ÃœrÃ¼n bulunamadÄ±: '+ni.name+' (Bu Ã¼rÃ¼n geÃ§miÅŸte silinmiÅŸ olabilir)');
          return;
        }
        var st = Number(p2.stock)||0;
        if(Number(ni.qty) > st){
          // fail-safe: eskiyi tekrar dÃ¼ÅŸ
          for(var j2=0;j2<saleOriginalSnapshot.items.length;j2++){
            var oi22 = saleOriginalSnapshot.items[j2];
            var pp2 = findProduct(b.products, oi22.id);
            if(pp2) pp2.stock = (Number(pp2.stock)||0) - (Number(oi22.qty)||0);
          }
          alert('Yetersiz stok: '+ni.name+' (Mevcut: '+st+')');
          return;
        }
      }
      for(i=0;i<saleDraft.items.length;i++){
        ni = saleDraft.items[i];
        p2 = findProduct(b.products, ni.id);
        p2.stock = (Number(p2.stock)||0) - (Number(ni.qty)||0);
      }

      sale.method = newMethod;
      sale.channel = newChannel;
      sale.items = cloneItems(saleDraft.items);
      sale.total = calcItemsTotal(sale.items);

      save();
      closeEditModal();
      renderAll();
      alert('SatÄ±ÅŸ gÃ¼ncellendi!');
    }

    function deleteSale(){
      var b = getBranch();
      var sale = findSale(b.sales, editingSaleId);
      if(!sale) return;

      if(!confirm('Bu satÄ±ÅŸÄ± silmek istiyor musunuz?')) return;

      // stoklarÄ± geri ver
      for(var i=0;i<sale.items.length;i++){
        var it = sale.items[i];
        var p = findProduct(b.products, it.id);
        if(p) p.stock = (Number(p.stock)||0) + (Number(it.qty)||0);
      }

      // satÄ±ÅŸtan Ã§Ä±kar
      for(i=0;i<b.sales.length;i++){
        if(Number(b.sales[i].id)===Number(editingSaleId)){
          b.sales.splice(i,1);
          break;
        }
      }

      save();
      closeEditModal();
      renderAll();
      alert('SatÄ±ÅŸ silindi.');
    }

    // ====== INVENTORY ======
    function resetProductForm(){
      setVal('pId','');
      setVal('pName','');
      setVal('pPrice','');
      setVal('pStock','');
      setVal('pIcon','');
      setVal('pDesc','');
      if(state.categories && state.categories[0]) setVal('pCat', state.categories[0]);
    }

    function saveProduct(){
      var b = getBranch();
      var idRaw = getVal('pId');
      var name = getVal('pName').trim();
      var cat = getVal('pCat');
      var price = Number(getVal('pPrice')||0);
      var stock = Number(getVal('pStock')||0);
      var icon = getVal('pIcon').trim();
      var desc = getVal('pDesc').trim();

      if(!name){ alert('ÃœrÃ¼n adÄ± boÅŸ olamaz'); return; }
      if(!cat){ alert('Kategori seÃ§'); return; }

      if(idRaw){
        // update
        var p = findProduct(b.products, Number(idRaw));
        if(!p){ alert('ÃœrÃ¼n bulunamadÄ±'); return; }
        p.name = name;
        p.cat = cat;
        p.price = price;
        p.stock = stock;
        p.icon = icon;
        p.description = desc;
      }else{
        // new
        var id = newId();
        b.products.push({
          id:id,
          name:name,
          cat:cat,
          price:price,
          stock:stock,
          icon:icon,
          description:desc
        });
      }

      save();
      resetProductForm();
      renderAll();
      alert('ÃœrÃ¼n kaydedildi!');
    }

    function editProduct(id){
      var b = getBranch();
      var p = findProduct(b.products, id);
      if(!p) return;
      setVal('pId', p.id);
      setVal('pName', p.name);
      setVal('pCat', p.cat);
      setVal('pPrice', p.price);
      setVal('pStock', p.stock);
      setVal('pIcon', p.icon||'');
      setVal('pDesc', p.description||'');
      switchView('inventory');
    }

    function deleteProduct(id){
      // Bu sÃ¼rÃ¼mde basit silme: (Ä°stersen geÃ§miÅŸ satÄ±ÅŸta kullanÄ±ldÄ±ysa engel ekleriz)
      var b = getBranch();
      if(!confirm('ÃœrÃ¼nÃ¼ silmek istiyor musunuz?')) return;

      for(var i=0;i<b.products.length;i++){
        if(Number(b.products[i].id)===Number(id)){
          b.products.splice(i,1);
          break;
        }
      }
      save();
      renderAll();
    }

    function renderInventory(){
      renderInventoryFilters();
      filterProducts();
    }

    function renderInventoryFilters(){
      var sel = document.getElementById('pCat');
      if(sel){
        var html = '';
        for(var i=0;i<state.categories.length;i++){
          html += '<option value="'+esc(state.categories[i])+'">'+esc(state.categories[i])+'</option>';
        }
        sel.innerHTML = html;
      }

      var sel2 = document.getElementById('invCatFilter');
      if(sel2){
        var html2 = '<option value="Hepsi">Hepsi</option>';
        for(i=0;i<state.categories.length;i++){
          html2 += '<option value="'+esc(state.categories[i])+'">'+esc(state.categories[i])+'</option>';
        }
        sel2.innerHTML = html2;
      }
    }

    function filterProducts(){
      var b = getBranch();
      var cat = getVal('invCatFilter');
      var q = (getVal('invSearch')||'').toLowerCase().trim();

      var list = [];
      for(var i=0;i<b.products.length;i++){
        var p = b.products[i];
        if(cat && cat!=='Hepsi' && p.cat!==cat) continue;
        if(q && (p.name||'').toLowerCase().indexOf(q)===-1) continue;
        list.push(p);
      }
      renderInventoryTable(list);
    }

    function renderInventoryTable(list){
      var tb = document.getElementById('inventoryBody');
      if(!tb) return;

      var html = '';
      for(var i=0;i<list.length;i++){
        var p = list[i];
        html += '<tr>'
          + '<td>'+esc(p.icon||'')+' '+esc(p.name)+'</td>'
          + '<td>'+esc(p.cat||'')+'</td>'
          + '<td>'+Number(p.price||0).toFixed(2)+' â‚º</td>'
          + '<td>'+Number(p.stock||0)+'</td>'
          + '<td>'
          +   '<button class="btn btn-sm" type="button" onclick="editProduct('+p.id+')">âœï¸</button> '
          +   '<button class="btn btn-sm btn-danger" type="button" onclick="deleteProduct('+p.id+')">ğŸ—‘ï¸</button>'
          + '</td>'
          + '</tr>';
      }
      tb.innerHTML = html || '<tr><td colspan="5" class="muted">ÃœrÃ¼n yok</td></tr>';
    }

    // ====== EXPENSES ======
    function resetExpenseForm(){
      setVal('expDesc','');
      setVal('expAmount','');
      // date'i bugÃ¼ne Ã§ek
      var d = new Date();
      var y = d.getFullYear();
      var m = String(d.getMonth()+1).padStart(2,'0');
      var da = String(d.getDate()).padStart(2,'0');
      setVal('expDate', y+'-'+m+'-'+da);
    }

    function renderExpenseSelectors(){
      var sel = document.getElementById('expType');
      if(sel){
        var html = '';
        for(var i=0;i<state.expenseTypes.length;i++){
          html += '<option value="'+esc(state.expenseTypes[i])+'">'+esc(state.expenseTypes[i])+'</option>';
        }
        sel.innerHTML = html;
      }

      var sel2 = document.getElementById('expTypeFilter');
      if(sel2){
        var html2 = '<option value="Hepsi">Hepsi</option>';
        for(i=0;i<state.expenseTypes.length;i++){
          html2 += '<option value="'+esc(state.expenseTypes[i])+'">'+esc(state.expenseTypes[i])+'</option>';
        }
        sel2.innerHTML = html2;
      }
    }

    function addExpense(){
      var b = getBranch();
      var date = getVal('expDate');
      var type = getVal('expType');
      var desc = getVal('expDesc').trim();
      var amount = Number(getVal('expAmount')||0);

      if(!date){ alert('Tarih seÃ§'); return; }
      if(!type){ alert('Tip seÃ§'); return; }
      if(!amount || amount<=0){ alert('Tutar gir'); return; }

        var expObj = {
        id:newId(),
        date:date,
        type:type,
        desc:desc,
        amount:amount
      };
      b.expenses.push(expObj);

      if(SheetsSync && SheetsSync.isReady()){
        SheetsSync.logExpense(getBranchKey(), expObj);
      }

      save();

      save();
      resetExpenseForm();
      renderAll();
      alert('Gider eklendi!');
    }

    function deleteExpense(id){
      if(!confirm('Gideri silmek istiyor musunuz?')) return;
      var b = getBranch();
      for(var i=0;i<b.expenses.length;i++){
        if(Number(b.expenses[i].id)===Number(id)){
          b.expenses.splice(i,1);
          break;
        }
      }
      save();
      renderAll();
    }

    function filterExpenses(){
      var b = getBranch();
      var type = getVal('expTypeFilter');
      var q = (getVal('expSearch')||'').toLowerCase().trim();

      var out = [];
      for(var i=0;i<b.expenses.length;i++){
        var e = b.expenses[i];
        if(type && type!=='Hepsi' && e.type!==type) continue;
        if(q){
          var hay = (e.desc||'')+' '+(e.type||'');
          if(hay.toLowerCase().indexOf(q)===-1) continue;
        }
        out.push(e);
      }
      renderExpensesTable(out);
    }

    function renderExpensesTable(list){
      var tb = document.getElementById('expensesTable');
      if(!tb) return;

      // yeni en Ã¼stte
      list = list.slice().sort(function(a,b){
        return (new Date(b.date)) - (new Date(a.date));
      });

      var html = '';
      for(var i=0;i<list.length;i++){
        var e = list[i];
        html += '<tr>'
          + '<td>'+esc(e.date||'')+'</td>'
          + '<td>'+esc(e.type||'')+'</td>'
          + '<td>'+esc(e.desc||'')+'</td>'
          + '<td>'+Number(e.amount||0).toFixed(2)+' â‚º</td>'
          + '<td><button class="btn btn-sm btn-danger" type="button" onclick="deleteExpense('+e.id+')">ğŸ—‘ï¸</button></td>'
          + '</tr>';
      }
      tb.innerHTML = html || '<tr><td colspan="5" class="muted">Gider yok</td></tr>';
    }

    function renderExpenses(){
      renderExpenseSelectors();
      resetExpenseForm();
      filterExpenses();
    }

    // ====== EXPORT / IMPORT ======
    function exportBackup(){
      var data = JSON.stringify(state, null, 2);
      var blob = new Blob([data], {type:'application/json'});
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'mahsum_usta_yedek_'+Date.now()+'.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function importBackupFile(file){
      var fr = new FileReader();
      fr.onload = function(){
        try{
          var obj = JSON.parse(fr.result);
          obj = normalizeAndBackfill(obj);
          state = obj;
          save(true);
          renderAll();
          alert('Yedek yÃ¼klendi!');
        }catch(e){
          alert('Yedek okunamadÄ±.');
        }
      };
      fr.readAsText(file);
    }

    // ====== RENDER ALL ======
    function renderSelectors(){
      renderSalesChannelFilter();
      renderInventoryFilters();
      renderExpenseSelectors();
    }

    function renderAll(){
      refreshBranchLabel();
      updateDataSourceLabels();
      renderSelectors();

      // aktif sayfayÄ± tekrar Ã§iz
      var active = document.querySelector('.page-view.active');
      if(active){
        var id = active.id.replace('view-','');
        if(id==='pos') renderPOS();
        if(id==='dashboard'){ renderDashboard(); renderSalesTable(); }
        if(id==='inventory') renderInventory();
        if(id==='expenses') renderExpenses();
      }
    }

    // ====== INIT ======
    function bindBranchSelect(){
      var sel = document.getElementById('branchSelect');
      if(!sel) return;
      sel.addEventListener('change', function(){
        cart = [];
        renderAll();
      });
    }

    function bindBackupButtons(){
      var ex = document.getElementById('btnExport');
      var im = document.getElementById('btnImport');
      var file = document.getElementById('importFile');
      if(ex) ex.onclick = exportBackup;
      if(im) im.onclick = function(){ if(file) file.click(); };
      if(file) file.onchange = function(){
        if(file.files && file.files[0]) importBackupFile(file.files[0]);
        file.value = '';
      };
    }

    // ====== SHEETS LIVE SYNC (GIS token model + Sheets API) ======
    var SheetsSync = (function(){
      var accessToken = null;
      var tokenClient = null;
      var deviceId = null;
      var isApplyingRemote = false;
      var lastPullRev = Number(localStorage.getItem('SHEETS_LAST_PULL_REV') || 0);
      var pushTimer = null;
      var pullTimer = null;

      function nowIso(){ return new Date().toISOString(); }

      function pill(cls, txt){
        var el = document.getElementById('syncPill');
        if(!el) return;
        el.className = 'sync-pill ' + cls;
        el.textContent = txt;
      }
      function setLast(txt){
        var el = document.getElementById('syncLast');
        if(el) el.textContent = 'Son: ' + (txt || '-');
      }

      function isReady(){
        return !!tokenClient;
      }

      function init(){
        deviceId = localStorage.getItem('SHEETS_DEVICE_ID');
        if(!deviceId){
          deviceId = 'dev_' + Date.now() + '_' + Math.floor(Math.random()*1e9);
          localStorage.setItem('SHEETS_DEVICE_ID', deviceId);
        }

        if(!SHEETS_SYNC.enabled){
          pill('sync-warn','â›” KapalÄ±');
          return;
        }

        // GIS script'i geÃ§ gelirse: onload callback ile tekrar init
        if(!(window.google && google.accounts && google.accounts.oauth2)){
          pill('sync-warn','â³ Google auth hazÄ±r deÄŸil');
          return;
        }

        try{
          tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: SHEETS_SYNC.clientId,
            scope: SHEETS_SYNC.scope,
            callback: function(resp){
              if(resp && resp.access_token){
                accessToken = resp.access_token;
                pill('sync-ok','âœ… BaÄŸlandÄ±');
                setLast(nowIso());
                // baÄŸlanÄ±nca otomatik bir pull
                pull();
                    setTimeout(flushOpsQueue, 300);

              }else{
                pill('sync-bad','âŒ Token alÄ±namadÄ±');
              }
            }
          });
          pill('sync-warn','ğŸ” BaÄŸlan');
        }catch(e){
          pill('sync-bad','âŒ Auth init hata');
        }
      }

      function requestTokenInteractive(){
        if(!tokenClient){
          init();
          if(!tokenClient) return;
        }
        tokenClient.requestAccessToken({prompt:'consent'});
      }

      function sheetsFetch(url, opt){
        opt = opt || {};
        opt.headers = opt.headers || {};
        opt.headers['Authorization'] = 'Bearer ' + accessToken;
        return fetch(url, opt).then(function(r){
          if(!r.ok) return r.text().then(function(t){ throw new Error('HTTP '+r.status+' '+t); });
          return r.json();
        });
      }

       // ---- OPS APPEND (satÄ±r ekleme) ----
      var opsQueue = [];
      try { opsQueue = JSON.parse(localStorage.getItem('SHEETS_OPS_QUEUE') || '[]') || []; } catch(e){ opsQueue = []; }

      function saveOpsQueue(){
        try{ localStorage.setItem('SHEETS_OPS_QUEUE', JSON.stringify(opsQueue)); }catch(e){}
      }
      function enqueueOpRow(row){
        opsQueue.push(row);
        saveOpsQueue();
      }

      function appendOpsRows(rows){
        var url = 'https://sheets.googleapis.com/v4/spreadsheets/' + encodeURIComponent(SHEETS_SYNC.spreadsheetId)
          + '/values/' + encodeURIComponent(SHEETS_SYNC.opsAppendRange) + ':append'
          + '?valueInputOption=RAW&insertDataOption=INSERT_ROWS';

        return sheetsFetch(url, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ majorDimension:'ROWS', values: rows })
        });
      }

      function flushOpsQueue(){
        if(!accessToken) return;
        if(!opsQueue.length) return;

        var batch = opsQueue.slice();
        opsQueue = [];
        saveOpsQueue();

        appendOpsRows(batch).then(function(){
          setLast(nowIso());
        }).catch(function(err){
          console.warn(err);
          // geri koy (kaybolmasÄ±n)
          opsQueue = batch.concat(opsQueue);
          saveOpsQueue();
        });
      }

      function logSale(branchKey, sale){
        // timestamp, branch, type=sale, saleId, total, channel, method, itemsJson
        var row = [
          nowIso(),
          String(branchKey || ''),
          'sale',
          String(sale.id || ''),
          String(Number(sale.total || 0).toFixed(2)),
          String(sale.channel || ''),
          String(sale.method || ''),
          JSON.stringify(sale.items || [])
        ];

        if(!accessToken){ enqueueOpRow(row); pill('sync-warn','ğŸ” BaÄŸlan'); return; }

        appendOpsRows([row]).then(function(){
          setLast(nowIso());
        }).catch(function(err){
          console.warn(err);
          enqueueOpRow(row);
        });
      }

      function logExpense(branchKey, exp){
        // timestamp, branch, type=expense, expenseId, amount, typeName, desc
        // H sÃ¼tunu boÅŸ bÄ±rakÄ±yoruz
        var row = [
          nowIso(),
          String(branchKey || ''),
          'expense',
          String(exp.id || ''),
          String(Number(exp.amount || 0).toFixed(2)),
          String(exp.type || ''),
          String(exp.desc || ''),
          ''
        ];

        if(!accessToken){ enqueueOpRow(row); pill('sync-warn','ğŸ” BaÄŸlan'); return; }

        appendOpsRows([row]).then(function(){
          setLast(nowIso());
        }).catch(function(err){
          console.warn(err);
          enqueueOpRow(row);
        });
      }

      function pushDebounced(){
        if(pushTimer) clearTimeout(pushTimer);
        pushTimer = setTimeout(function(){ push(); }, 600);
      }

      function push(){
        if(!SHEETS_SYNC.enabled) return;
        if(isApplyingRemote) return;

        if(!accessToken){
          pill('sync-warn','ğŸ” BaÄŸlan');
          return;
        }

        var rev = Date.now(); // basit rev
        var values = [[ String(rev), nowIso(), deviceId, JSON.stringify(state) ]];

        var url = 'https://sheets.googleapis.com/v4/spreadsheets/' + encodeURIComponent(SHEETS_SYNC.spreadsheetId)
          + '/values/' + encodeURIComponent(SHEETS_SYNC.range) + '?valueInputOption=RAW';

        pill('sync-warn','â¬†ï¸ GÃ¶nderiliyorâ€¦');

        sheetsFetch(url, {
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ range: SHEETS_SYNC.range, majorDimension:'ROWS', values: values })
        }).then(function(){
          pill('sync-ok','âœ… Senkron');
          setLast(nowIso());
        }).catch(function(err){
          console.warn(err);
          pill('sync-bad','âŒ GÃ¶nderme hata');
        });
      }

      function pull(){
        if(!SHEETS_SYNC.enabled) return;
        if(!accessToken){
          pill('sync-warn','ğŸ” BaÄŸlan');
          return;
        }

        var url = 'https://sheets.googleapis.com/v4/spreadsheets/' + encodeURIComponent(SHEETS_SYNC.spreadsheetId)
          + '/values/' + encodeURIComponent(SHEETS_SYNC.range) + '?majorDimension=ROWS';

        pill('sync-warn','â¬‡ï¸ Ã‡ekiliyorâ€¦');

        sheetsFetch(url).then(function(data){
          var row = (data && data.values && data.values[0]) ? data.values[0] : null;
          if(!row || row.length < 4){
            pill('sync-warn','â„¹ï¸ BoÅŸ');
            return;
          }
          var rev = Number(row[0] || 0);
          var updatedAt = row[1] || '';
          var remoteJson = row[3] || '';

          if(rev <= lastPullRev){
            pill('sync-ok','âœ… GÃ¼ncel');
            setLast(updatedAt || nowIso());
            return;
          }

          var remoteState = null;
          try{ remoteState = JSON.parse(remoteJson); }catch(e){ remoteState=null; }
          if(!remoteState){
            pill('sync-bad','âŒ JSON bozuk');
            return;
          }

          isApplyingRemote = true;
          state = normalizeAndBackfill(remoteState);
          save(true); // local gÃ¼ncelle
          renderAll();
          isApplyingRemote = false;

          lastPullRev = rev;
          localStorage.setItem('SHEETS_LAST_PULL_REV', String(lastPullRev));

          pill('sync-ok','âœ… GÃ¼ncellendi');
          setLast(updatedAt || nowIso());
        }).catch(function(err){
          console.warn(err);
          pill('sync-bad','âŒ Ã‡ekme hata');
        });
      }

      function startAutoPull(){
        if(pullTimer) clearInterval(pullTimer);
        pullTimer = setInterval(function(){
          if(document.hidden) return;
          if(!accessToken) return;
          pull();
        }, 2500);
      }

      return {
        init: init,
        isReady: function(){ return !!tokenClient; },
        connect: function(){
          requestTokenInteractive();
          startAutoPull();
        },
        pull: pull,
        push: push,
        pushDebounced: pushDebounced
        logSale: logSale,
        logExpense: logExpense
      };
    })();

    // GIS onload callback
    window.__GIS_LOADED__ = function(){
      SheetsSync.init();
    };

    function bindSyncUI(){
      var btnC = document.getElementById('btnGoogleConnect');
      var btnPull = document.getElementById('btnSyncPull');
      var btnPush = document.getElementById('btnSyncPush');

      if(btnC) btnC.onclick = function(){ SheetsSync.connect(); };
      if(btnPull) btnPull.onclick = function(){ SheetsSync.pull(); };
      if(btnPush) btnPush.onclick = function(){ SheetsSync.push(); };
    }

    function init(){
      loadTheme();
      updateDataSourceLabels();
      bindNav();
      bindBranchSelect();
      bindBackupButtons();
      bindSyncUI();

      var tbtn = document.getElementById('themeToggle');
      if(tbtn) tbtn.onclick = toggleTheme;

      // filtre dropdown'larÄ± ilk kez doldur
      renderSelectors();

      // default tarih alanlarÄ±
      resetExpenseForm();

      // ilk render
      renderAll();

      // GIS yÃ¼klenmiÅŸse init
      if(window.google && google.accounts && google.accounts.oauth2){
        SheetsSync.init();
      }
    }

    init();

    // ====== PWA CACHE (offline) ======
    (function(){
      // Basit inline service-worker (Blob) - offline iÃ§in
      var swCode = `
        const CACHE = "mahsum-usta-v5";
        self.addEventListener("install", (e) => {
          e.waitUntil(caches.open(CACHE).then((c) => c.addAll(["./"])).catch(()=>{}));
          self.skipWaiting();
        });
        self.addEventListener("activate", (e) => {
          e.waitUntil(self.clients.claim());
        });
        self.addEventListener("fetch", (e) => {
          const req = e.request;
          if(req.method !== "GET") return;
          const url = new URL(req.url);
          // sadece aynÄ± origin cache'lensin (sheets.googleapis.com cache'lenmesin)
          if(url.origin !== self.location.origin) return;

          e.respondWith(
            caches.match(req).then((hit) => {
              return hit || fetch(req).then((res) => {
                const copy = res.clone();
                caches.open(CACHE).then((c) => c.put(req, copy)).catch(()=>{});
                return res;
              }).catch(()=>hit);
            })
          );
        });
      `;
      try{
        if("serviceWorker" in navigator){
          var blob = new Blob([swCode], {type:"text/javascript"});
          var swUrl = URL.createObjectURL(blob);
          navigator.serviceWorker.register(swUrl).catch(()=>{});
        }
      }catch(e){}
    })();

    /*
      Ek notlar:
      - EÄŸer "Hata 403 access_denied" alÄ±rsan: OAuth Consent Screen > Audience > Test users iÃ§ine email ekle.
      - Authorized JavaScript origins: https://arenakgul.github.io (path yok).
    */
      </script>
    </main>
  </div>
</body>
</html>
